# å®¢æˆ·æ§åˆ¶å° - æ¶æ„è¯´æ˜

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-12-19
> **æœ€åæ›´æ–°**ï¼š2025-12-19

---

## 1. æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åå¸­å·¥ä½œå° (agent_workbench)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚  â”‚ ä¾§è¾¹æ    â”‚                                                   â”‚
â”‚  â”‚ ğŸ’³ è´¦æˆ·  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚                   â”‚
â”‚                                            â†“                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              iframe åµŒå…¥åŒºåŸŸ                              â”‚  â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚  â”‚         â”‚     Customer Portal å‰ç«¯       â”‚              â”‚  â”‚
â”‚  â”‚         â”‚     (Vue é¡µé¢)                 â”‚              â”‚  â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP API
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Products äº§å“å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              customer_portal (æœ¬æ¨¡å—)                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ /account   â”‚ â”‚/subscriptionâ”‚ â”‚ /usage     â”‚ /invoicesâ”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚              â”‚              â”‚                       â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                          â†“                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Services æœåŠ¡å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    billing (è®¡è´¹æœåŠ¡)                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚  â”‚ plans  â”‚ â”‚subscriptionâ”‚ â”‚ usage  â”‚ â”‚invoice â”‚        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Infrastructure åŸºç¡€è®¾æ–½å±‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚databaseâ”‚  â”‚securityâ”‚  â”‚logging â”‚                           â”‚
â”‚  â”‚ Redis  â”‚  â”‚  JWT   â”‚  â”‚        â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ç›®å½•ç»“æ„

```
products/customer_portal/
â”œâ”€â”€ __init__.py                 # æ¨¡å—å…¥å£ï¼Œå¯¼å‡º router
â”œâ”€â”€ README.md                   # æ¨¡å—è§„èŒƒæ–‡æ¡£
â”œâ”€â”€ routes.py                   # API è·¯ç”±å®šä¹‰
â”œâ”€â”€ models.py                   # Pydantic æ¨¡å‹ï¼ˆå¾…åˆ›å»ºï¼‰
â”œâ”€â”€ handlers/                   # ä¸šåŠ¡å¤„ç†å™¨
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ account.py             # è´¦æˆ·ä¿¡æ¯å¤„ç†ï¼ˆå¾…åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ subscription.py        # è®¢é˜…ç®¡ç†å¤„ç†ï¼ˆå¾…åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ usage.py               # ç”¨é‡ç»Ÿè®¡å¤„ç†ï¼ˆå¾…åˆ›å»ºï¼‰
â”‚   â””â”€â”€ billing.py             # è´¦å•ç®¡ç†å¤„ç†ï¼ˆå¾…åˆ›å»ºï¼‰
â”œâ”€â”€ memory-bank/                # Vibe Coding æ–‡æ¡£
â”‚   â”œâ”€â”€ prd.md                 # äº§å“éœ€æ±‚æ–‡æ¡£
â”‚   â”œâ”€â”€ tech-stack.md          # æŠ€æœ¯æ ˆè¯´æ˜
â”‚   â”œâ”€â”€ implementation-plan.md # å®ç°è®¡åˆ’
â”‚   â”œâ”€â”€ progress.md            # è¿›åº¦è¿½è¸ª
â”‚   â””â”€â”€ architecture.md        # æœ¬æ–‡ä»¶
â””â”€â”€ tests/                      # å•å…ƒæµ‹è¯•ï¼ˆå¾…åˆ›å»ºï¼‰
    â””â”€â”€ test_portal.py
```

---

## 3. ä¾èµ–å…³ç³»

### 3.1 æœ¬æ¨¡å—ä¾èµ–

```python
# ä¾èµ–çš„ services
from services.billing import (
    PlanService,
    SubscriptionService,
    UsageService,
    InvoiceService
)

# ä¾èµ–çš„ infrastructure
from infrastructure.security import verify_jwt_token
from infrastructure.database import get_redis_client
```

### 3.2 è¢«è°ä¾èµ–

```
agent_workbench
    â””â”€â”€ é€šè¿‡ iframe åµŒå…¥ customer_portal å‰ç«¯é¡µé¢
```

---

## 4. æ ¸å¿ƒç»„ä»¶è¯´æ˜

### 4.1 routes.py

**ç”¨é€”**ï¼šå®šä¹‰æ‰€æœ‰ API ç«¯ç‚¹

**ä¸»è¦è·¯ç”±**ï¼š
```python
router = APIRouter(prefix="/api/portal", tags=["å®¢æˆ·æ§åˆ¶å°"])

# è´¦æˆ·
GET  /account
PUT  /account

# è®¢é˜…
GET  /subscription
GET  /plans
POST /subscription/upgrade

# ç”¨é‡
GET  /usage
GET  /usage/detail

# è´¦å•
GET  /invoices
GET  /invoices/{id}
GET  /invoices/{id}/pdf
```

### 4.2 handlers/account.pyï¼ˆå¾…åˆ›å»ºï¼‰

**ç”¨é€”**ï¼šå¤„ç†è´¦æˆ·ä¿¡æ¯ç›¸å…³è¯·æ±‚

**ä¸»è¦å‡½æ•°**ï¼š
- `get_account()` - è·å–è´¦æˆ·ä¿¡æ¯
- `update_account()` - æ›´æ–°è´¦æˆ·ä¿¡æ¯

### 4.3 handlers/subscription.pyï¼ˆå¾…åˆ›å»ºï¼‰

**ç”¨é€”**ï¼šå¤„ç†è®¢é˜…ç®¡ç†ç›¸å…³è¯·æ±‚

**ä¸»è¦å‡½æ•°**ï¼š
- `get_subscription()` - è·å–å½“å‰è®¢é˜…
- `get_plans()` - è·å–å¯ç”¨å¥—é¤
- `upgrade_subscription()` - å‡çº§å¥—é¤

### 4.4 handlers/usage.pyï¼ˆå¾…åˆ›å»ºï¼‰

**ç”¨é€”**ï¼šå¤„ç†ç”¨é‡ç»Ÿè®¡ç›¸å…³è¯·æ±‚

**ä¸»è¦å‡½æ•°**ï¼š
- `get_usage_summary()` - è·å–ç”¨é‡æ¦‚è§ˆ
- `get_usage_detail()` - è·å–ç”¨é‡æ˜ç»†

### 4.5 handlers/billing.pyï¼ˆå¾…åˆ›å»ºï¼‰

**ç”¨é€”**ï¼šå¤„ç†è´¦å•ç®¡ç†ç›¸å…³è¯·æ±‚

**ä¸»è¦å‡½æ•°**ï¼š
- `get_invoices()` - è·å–è´¦å•åˆ—è¡¨
- `get_invoice()` - è·å–è´¦å•è¯¦æƒ…
- `download_invoice_pdf()` - ä¸‹è½½å‘ç¥¨ PDF

---

## 5. æ•°æ®æµ

### 5.1 è·å–è®¢é˜…ä¿¡æ¯

```
ç”¨æˆ·ç‚¹å‡»"è´¦æˆ·ä¸è®¢é˜…"
    â†“
åå¸­å·¥ä½œå°ä¾§è¾¹æ 
    â†“
iframe åŠ è½½ customer_portal å‰ç«¯
    â†“
å‰ç«¯è°ƒç”¨ GET /api/portal/subscription
    â†“
handlers/subscription.py
    â†“
services.billing.SubscriptionService.get_subscription()
    â†“
infrastructure.database (Redis)
    â†“
è¿”å›è®¢é˜…æ•°æ® â†’ å‰ç«¯å±•ç¤º
```

### 5.2 å‡çº§å¥—é¤

```
ç”¨æˆ·é€‰æ‹©æ–°å¥—é¤ â†’ ç‚¹å‡»"å‡çº§"
    â†“
å‰ç«¯è°ƒç”¨ POST /api/portal/subscription/upgrade
    â†“
handlers/subscription.py
    â†“
services.billing.SubscriptionService.upgrade_subscription()
    â†“
1. éªŒè¯å¥—é¤æ˜¯å¦å¯å‡çº§
2. æ›´æ–°è®¢é˜…è®°å½•
3. ç”Ÿæˆå·®ä»·è´¦å•ï¼ˆå¯é€‰ï¼‰
    â†“
è¿”å›æˆåŠŸ â†’ å‰ç«¯åˆ·æ–°è®¢é˜…ä¿¡æ¯
```

---

## 6. å…³é”®è®¾è®¡å†³ç­–

### 6.1 ä¸ºä»€ä¹ˆç‹¬ç«‹æˆäº§å“è€Œä¸æ˜¯æ”¾å·¥ä½œå°ï¼Ÿ

| è€ƒé‡ | å†³ç­– |
|------|------|
| æ¶æ„è§£è€¦ | ç‹¬ç«‹äº§å“å¯ç‹¬ç«‹å¼€å‘ã€éƒ¨ç½²ã€è¿­ä»£ |
| å¤ç”¨æ€§ | æœªæ¥å¯æ”¯æŒå®˜ç½‘ã€App ç­‰å¤šå…¥å£ |
| èŒè´£æ¸…æ™° | å·¥ä½œå°ç®¡"å¹²æ´»"ï¼Œæ§åˆ¶å°ç®¡"èŠ±é’±" |

### 6.2 ä¸ºä»€ä¹ˆç”¨ iframe åµŒå…¥ï¼Ÿ

| è€ƒé‡ | å†³ç­– |
|------|------|
| å®ç°ç®€å• | MVP é˜¶æ®µå¿«é€Ÿä¸Šçº¿ |
| éš”ç¦»æ€§å¥½ | æ ·å¼ã€è„šæœ¬äº’ä¸å¹²æ‰° |
| å¯ç‹¬ç«‹è®¿é—® | ä¸åµŒå…¥æ—¶ä¹Ÿèƒ½ç‹¬ç«‹ä½¿ç”¨ |

### 6.3 ä¸ºä»€ä¹ˆè®¡è´¹é€»è¾‘æ”¾ servicesï¼Ÿ

| è€ƒé‡ | å†³ç­– |
|------|------|
| å¤ç”¨æ€§ | AI å®¢æœã€ç‰©æµé€šçŸ¥éƒ½éœ€è¦è®¡è´¹ |
| å•ä¸€èŒè´£ | æ§åˆ¶å°åªåš UIï¼Œä¸åšä¸šåŠ¡é€»è¾‘ |
| ä¸€è‡´æ€§ | æ‰€æœ‰äº§å“å…±ç”¨åŒä¸€å¥—è®¡è´¹è§„åˆ™ |
