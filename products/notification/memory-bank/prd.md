# 物流通知（Notification）- 产品需求文档

> **产品名称**：Fiido 物流通知服务
> **版本**：v1.1
> **创建日期**：2025-12-21
> **更新日期**：2026-01-07
> **状态**：已实现基础版，待生产化补齐

---

## 一、产品概述

物流通知服务是 Fiido 智能服务平台的独立产品模块，用于把“发货后关键物流事件”自动通知到客户邮箱，并为客服提供可追踪的通知记录。

本模块面向两类业务来源：
1. **Shopify 独立站订单**：来自 Shopify 的发货（fulfillment）信息。
2. **易仓 ERP 售后配件订单**：来自易仓下单的售后配件（可按店铺/来源识别），需要在物流更新时自动通知客户（易仓可提供接口，但不保证有现成能力）。

### 1.1 目标用户
- 终端消费者：获取物流状态更新和签收确认
- 坐席：处理物流异常
- 运营人员：监控物流服务质量

### 1.2 核心价值
- 客户：主动获知“拆包裹 / 预售发货 / 异常 / 签收”等关键节点，减少不确定性
- 客服：减少重复解释与催件咨询，遇到异常能更早介入
- 企业：通知可审计、可追踪、可配置，支持多店铺与售后场景扩展

---

## 二、核心功能

### 2.1 拆包裹发货通知
**触发条件**：一个订单拆分为多个包裹发货
**通知内容**：告知用户订单将分批到达
**触发方式**：Shopify `fulfillments/create` Webhook（或等价发货事件）

### 2.2 预售商品发货通知
**触发条件**：预售商品开始发货
**通知内容**：告知用户预售商品已发出
**触发方式**：Shopify `fulfillments/create` + 预售识别规则（默认 SKU 前缀，可后续改为标签/元字段规则）

### 2.3 物流异常告警
**触发条件**：追踪服务推送/检测到异常状态（如 Alert、Undelivered、退回、派送失败等）
**通知内容**：告知用户物流出现问题，提供解决方案
**触发方式**：优先 Webhook（17track 或易仓），不具备推送时降级为定时轮询（后续迭代）

### 2.4 签收确认通知
**触发条件**：追踪服务推送/检测到 Delivered/签收状态
**通知内容**：确认签收，引导评价
**触发方式**：优先 Webhook（17track 或易仓），不具备推送时降级为定时轮询（后续迭代）

---

## 三、Webhook / 接口端点（产品层）

| 端点 | 来源 | 用途 |
|------|------|------|
| `POST /webhook/shopify` | Shopify | 接收发货事件 |
| `POST /webhook/17track` | 17track（可选） | 接收状态变更 |
| `POST /webhook/yicang` | 易仓（规划） | 接收售后配件订单/物流更新 |

---

## 四、依赖服务

| 服务 | 用途 |
|------|------|
| services/tracking | 追踪服务（默认 17track 实现，允许扩展/替换） |
| services/shopify | 订单数据查询 |
| services/email | 邮件发送 |
| infrastructure/database | 通知记录与映射持久化（推荐作为权威数据源） |

---

## 五、邮件模板

| 模板 | 用途 |
|------|------|
| split_package.html | 拆包裹通知 |
| presale_shipped.html | 预售发货通知 |
| exception_alert.html | 异常告警 |
| delivery_confirm.html | 签收确认 |

---

## 六、成功标准（最小可验收）

- Shopify 订单：能从 `fulfillments/create` 触发拆包裹/预售通知；能对运单建立“运单→订单→客户邮箱”关联
- 异常/签收：在开启追踪集成后，能对同一运单状态变化做到幂等不重复发送
- 售后配件：能识别“易仓售后配件订单”并在物流状态变化时发送邮件（接口能力允许的情况下）
- 可追踪：每封通知具备发送记录（成功/失败/错误原因），便于客服排查

---

## 七、易仓对接待确认项（用于后续补齐可联调版本）

> 标记规范：统一用 `[[YICANG_TBD]]` 作为占位，便于后续全文搜索定位并替换。

### 7.1 Webhook 鉴权与安全（[[YICANG_TBD]]）

需要从易仓开放平台文档确认并填入：
- 签名算法（HMAC/MD5/RSA 等）、签名字段、编码规则
- 时间戳/nonce、防重放窗口
- IP 白名单支持与否
- 失败重试机制（是否重推、重试间隔/次数）、是否提供 `event_id`

### 7.2 Webhook Payload 结构（[[YICANG_TBD]]）

需要从易仓开放平台文档确认并填入（至少提供示例 JSON）：
- 售后店铺标识字段（用于识别“售后配件订单”）
- 订单号/外部单号（用于关联与幂等）
- 客户邮箱、收件人姓名、国家/邮编
- 运单号、承运商、发货时间

---

## 八、跨模块引用

本模块是 **17track 物流追踪集成** 跨模块功能的一部分。

完整文档：`docs/features/17track-integration/`
