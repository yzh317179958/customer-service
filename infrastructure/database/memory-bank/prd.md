# PostgreSQL 数据库模块 PRD

> **模块位置**: infrastructure/database/
> **创建日期**: 2025-12-22
> **版本**: v1.0

---

## 1. 产品概述

### 模块名称

PostgreSQL 数据库持久化模块

### 目标用户

- Fiido 智能服务平台所有产品（ai_chatbot、agent_workbench、notification）
- 服务层（ticket、session、email）

### 核心价值

解决当前纯 Redis 存储的数据丢失风险，为核心业务数据提供可靠的持久化存储，支持复杂查询和数据分析。

### 当前问题


| 数据类型 | 当前存储         | 问题                       |
| -------- | ---------------- | -------------------------- |
| 会话状态 | Redis (24h TTL)  | 会话历史丢失，无法归档分析 |
| 工单数据 | Redis/内存       | 重启丢失，无持久化         |
| 坐席账号 | Redis (365d TTL) | 无法审计，无历史追踪       |
| 审计日志 | Redis (List)     | 数量有限，无法长期保存     |
| 邮件发送 | 无记录           | 无法追溯                   |

---

## 2. 功能列表

### 核心功能（P0）

- [x]  PostgreSQL 连接池管理
- [x]  SQLAlchemy ORM 模型定义
- [x]  Alembic 数据库迁移管理
- [x]  工单数据持久化（Ticket）
- [x]  坐席账号持久化（Agent）
- [x]  审计日志持久化（AuditLog）
- [x]  Pydantic ↔ ORM 模型转换器

### 扩展功能（P1）

- [x]  已关闭会话归档（SessionArchive）
- [x]  邮件发送记录（EmailRecord）
- [ ]  历史数据迁移脚本（Redis → PostgreSQL）
- [x]  数据库健康检查接口

---

## 3. 用户故事

1. **作为系统管理员**，我希望工单数据持久化存储，即使服务器重启也不会丢失。
2. **作为坐席主管**，我希望查看历史工单和审计日志，了解服务质量和问题处理情况。
3. **作为开发者**，我希望有统一的 ORM 层，方便进行复杂数据查询和报表生成。
4. **作为运维人员**，我希望数据库连接有连接池管理和健康检查，保证系统稳定性。
5. **作为产品经理**，我希望归档历史会话数据，用于后续分析和产品优化。

---

## 4. 成功标准

- [x]  所有 ORM 模型通过单元测试
- [x]  Alembic 迁移脚本可正常执行
- [x]  工单 CRUD 操作通过 PostgreSQL 完成
- [x]  坐席账号持久化存储正常
- [x]  审计日志写入 PostgreSQL 正常
- [x]  现有 API 接口保持兼容（无破坏性变更）
- [x]  性能测试：查询响应时间 < 100ms

---

## 5. 约束条件

### 架构约束

- 遵循三层架构：本模块属于 **infrastructure/** 层
- 不可依赖 products/ 和 services/ 层
- 通过 Bootstrap 工厂模式集成

### 技术约束

- PostgreSQL 15+
- SQLAlchemy 2.0+
- Alembic 1.12+
- 保持 Redis 用于热数据缓存

### 兼容性约束

- 现有 Store 接口（TicketStore、SessionStore）保持不变
- 采用双写策略过渡，逐步切换

---

## 6. 文档更新记录


| 版本 | 日期       | 变更     |
| ---- | ---------- | -------- |
| v1.1 | 2025-12-22 | 标记所有功能和成功标准为已完成 |
| v1.0 | 2025-12-22 | 初始版本 |
