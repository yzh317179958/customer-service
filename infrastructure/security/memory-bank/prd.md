# 安全防护组件 PRD

> **版本**: v1.0
> **创建日期**: 2025-12-24
> **状态**: 待开发
> **参考文档**: [安全防护方案](../../../docs/安全防护方案.md)

---

## 1. 产品概述

### 产品名称
Fiido 安全防护组件 (Security Module)

### 定位
`infrastructure/security/` 基础设施层组件，为所有产品提供统一的安全防护能力。

### 目标用户

| 用户类型 | 说明 |
|----------|------|
| AI 智能客服 | 面向公众，需防护恶意刷接口、Token 消耗攻击 |
| 坐席工作台 | 面向内部坐席，需防护登录暴力破解、未授权访问 |
| 未来产品 | 客户控制台、物流通知等，共享安全能力 |

### 核心价值

1. **统一管理** - 所有产品共享一套安全组件，配置集中管理
2. **灵活配置** - 每个产品可自定义安全策略（限流阈值、黑名单规则）
3. **易于接入** - 产品层一行代码即可启用安全防护
4. **可扩展性** - 新增安全能力时，所有产品自动受益

---

## 2. 威胁分析

### 2.1 AI 智能客服 (ai_chatbot) 威胁

| 威胁类型 | 攻击方式 | 影响端点 | 风险等级 |
|----------|----------|----------|----------|
| Token 消耗攻击 | 脚本批量调用 AI 对话 | `/api/chat/stream` | **高** |
| 长文本攻击 | 发送超长消息消耗 Token | `/api/chat/stream` | **高** |
| API 滥用 | 批量查询订单/物流 | `/api/shopify/*`, `/api/tracking/*` | 中 |
| 资源耗尽 | SSE 长连接不释放 | `/api/chat/stream` | 中 |

### 2.2 坐席工作台 (agent_workbench) 威胁

| 威胁类型 | 攻击方式 | 影响端点 | 风险等级 |
|----------|----------|----------|----------|
| 暴力破解 | 批量尝试登录密码 | `/agent/login` | **高** |
| Token 滥用 | 盗用/伪造 JWT | 所有 `/agent/*` 端点 | **高** |
| 未授权访问 | 绕过认证访问管理接口 | `/agents/*`, `/admin/*` | **高** |
| 数据遍历 | 批量获取工单/会话 | `/tickets/*`, `/sessions/*` | 中 |

### 2.3 通用威胁

| 威胁类型 | 攻击方式 | 风险等级 |
|----------|----------|----------|
| CC 攻击 | HTTP 洪水压垮服务 | **高** |
| IP 伪装 | 代理池轮换绕过限流 | 中 |
| 注入攻击 | SQL/命令注入 | 中 |

---

## 3. 功能列表

### 3.1 核心功能（P0 - 上线前必须完成）

| 功能 | 说明 | 状态 |
|------|------|------|
| **请求限流** | 基于 IP/用户的请求频率限制 | ⬜ 待开发 |
| **消息长度限制** | 限制单条消息最大字符数 | ⬜ 待开发 |
| **登录保护** | 登录失败次数限制、账户锁定 | ⬜ 待开发 |
| **IP 黑名单** | 手动/自动封禁恶意 IP | ⬜ 待开发 |

### 3.2 重要功能（P1 - 上线后 1-2 周）

| 功能 | 说明 | 状态 |
|------|------|------|
| **监控指标** | Prometheus 格式指标暴露 | ⬜ 待开发 |
| **自动封禁** | 触发规则后自动封禁 IP | ⬜ 待开发 |
| **会话限制** | 限制单 IP 活跃会话数 | ⬜ 待开发 |

### 3.3 扩展功能（P2 - 后续迭代）

| 功能 | 说明 | 状态 |
|------|------|------|
| 验证码机制 | 异常行为时触发人机验证 | ⬜ 规划中 |
| 设备指纹 | 结合 IP + 浏览器特征识别 | ⬜ 规划中 |
| 行为分析 | 识别机器人行为模式 | ⬜ 规划中 |

---

## 4. 安全规则配置

### 4.1 AI 智能客服限流规则

```yaml
ai_chatbot:
  rate_limits:
    # AI 对话接口 - 最严格
    "/api/chat/stream":
      limit: "10/minute"        # 每分钟 10 次
      burst: 3                  # 允许突发 3 次

    "/api/chat":
      limit: "10/minute"

    # 物流查询 - 中等
    "/api/tracking/*":
      limit: "30/minute"

    # 订单查询 - 中等
    "/api/shopify/*":
      limit: "20/minute"

    # 其他接口 - 宽松
    default:
      limit: "60/minute"

  message_limits:
    max_length: 1000            # 单条消息最大 1000 字符
    max_conversation_rounds: 50 # 单会话最大 50 轮

  session_limits:
    max_active_per_ip: 3        # 单 IP 最多 3 个活跃会话
    idle_timeout: 1800          # 空闲 30 分钟关闭
```

### 4.2 坐席工作台限流规则

```yaml
agent_workbench:
  rate_limits:
    # 登录接口 - 严格防暴力破解
    "/agent/login":
      limit: "5/minute"         # 每分钟 5 次
      lockout_after: 5          # 连续失败 5 次锁定
      lockout_duration: 900     # 锁定 15 分钟

    # Token 刷新 - 中等
    "/agent/refresh":
      limit: "10/minute"

    # 业务操作 - 宽松（已有 JWT 认证）
    default:
      limit: "120/minute"

  ip_whitelist:
    enabled: false              # 可选：仅允许白名单 IP 访问
    ips: []
```

### 4.3 全局规则

```yaml
global:
  # IP 封禁规则
  auto_ban:
    trigger: "100/minute"       # 1 分钟超 100 次请求触发
    duration: 600               # 封禁 10 分钟
    escalation:
      - after: 3                # 触发 3 次后
        duration: 86400         # 升级为 24 小时封禁
      - after: 5                # 触发 5 次后
        duration: -1            # 永久封禁

  # 连接限制
  connection:
    max_per_ip: 10              # 单 IP 最大 10 个并发连接
    timeout_seconds: 30         # 请求超时 30 秒

  # SSE 连接限制
  sse:
    max_per_ip: 3               # 单 IP 最多 3 个 SSE 连接
    heartbeat_interval: 15      # 心跳间隔 15 秒
    max_duration: 600           # 最长连接 10 分钟
```

---

## 5. 用户故事

### 5.1 产品开发者视角

1. **作为 AI 客服开发者**，我希望一行代码就能为 `/api/chat/stream` 添加限流，防止恶意用户刷爆 Token 配额。

2. **作为坐席工作台开发者**，我希望登录接口自动具备暴力破解防护，无需自己实现锁定逻辑。

3. **作为新产品开发者**，我希望直接复用现有安全组件，快速接入标准化的安全防护。

### 5.2 运维人员视角

4. **作为运维人员**，我希望看到统一的安全监控指标，了解各产品的安全状态。

5. **作为运维人员**，我希望能手动封禁恶意 IP，并设置封禁时长。

### 5.3 终端用户视角

6. **作为正常用户**，我希望在合理使用范围内不会被误封，限流提示友好。

---

## 6. 成功标准

### 6.1 功能标准

- [ ] AI 客服 `/api/chat/stream` 接口支持 10 次/分钟限流
- [ ] 坐席工作台 `/agent/login` 支持 5 次失败后锁定 15 分钟
- [ ] 支持手动添加/移除 IP 黑名单
- [ ] 限流触发时返回标准 429 响应和重试提示

### 6.2 性能标准

- [ ] 限流检查延迟 < 1ms（Redis 存储）
- [ ] 内存占用 < 10MB
- [ ] 不影响正常请求响应时间

### 6.3 可用性标准

- [ ] 产品接入代码 < 10 行
- [ ] 配置变更无需重启服务
- [ ] 文档完整，包含使用示例

---

## 7. 非功能需求

### 7.1 架构约束

- 放置在 `infrastructure/security/` 目录
- 遵循三层架构依赖规则（可被 services 和 products 依赖）
- 使用 Redis 存储限流计数和黑名单（支持分布式）

### 7.2 兼容性

- 支持 FastAPI 框架
- 支持同步和异步请求
- 兼容现有的 JWT 认证中间件

### 7.3 可观测性

- 暴露 Prometheus 格式指标
- 关键操作记录日志
- 支持 Grafana 仪表板

---

## 8. 文档更新记录

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-12-24 | 初始版本，基于安全防护方案文档和项目实际情况制定 |
