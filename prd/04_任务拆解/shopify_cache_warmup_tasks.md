# Shopify 缓存预热功能开发计划

> 文档版本: v1.0
> 状态: ✅ 开发完成
> 创建时间: 2025-12-10
> 完成时间: 2025-12-10
> 目标版本: v4.2.0

## 1. 背景与目标

### 1.1 问题描述
- 用户通过 Coze 工作流查询订单时，首次调用需要 **1 分 10 秒**
- 原因：Coze → 后端 → Shopify API 链路，首次无缓存时需要实时调用 Shopify
- 缓存命中后查询只需 **< 1 秒**

### 1.2 解决目标
- 通过后台预热机制，提前将订单数据加载到 Redis 缓存
- 目标：**95%+ 的用户查询在 1 秒内返回**

### 1.3 设计参数
| 参数 | 值 | 说明 |
|------|-----|------|
| 预热范围 | 7 天 | 预热最近 7 天的订单 |
| 日均订单（峰值假设） | 200 单 | 设计容量 |
| 7 天订单总数 | 1,400 单 | 200 × 7 |
| 订单缓存 TTL | 48 小时 | 订单信息不变，缓存较长 |
| 物流缓存 TTL | 6 小时 | 物流状态会更新，需要刷新 |
| 预热速率 | 0.5 次/秒 | 避免影响用户实时请求 |

---

## 2. 技术方案

### 2.1 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                      后端服务                            │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │ APScheduler │───→│ WarmupService│───→│ ShopifyAPI  │  │
│  │  定时调度    │    │  预热服务    │    │  客户端     │  │
│  └─────────────┘    └──────┬──────┘    └─────────────┘  │
│                            │                            │
│                            ▼                            │
│                     ┌─────────────┐                     │
│                     │    Redis    │                     │
│                     │    缓存     │                     │
│                     └─────────────┘                     │
│                            ▲                            │
│                            │                            │
│  ┌─────────────┐    ┌──────┴──────┐                     │
│  │  用户请求   │───→│ ShopifyUK   │                     │
│  │  (优先级高) │    │  Service    │                     │
│  └─────────────┘    └─────────────┘                     │
└─────────────────────────────────────────────────────────┘
```

### 2.2 预热调度策略

| 时间 (UTC) | 北京时间 | 类型 | 说明 |
|-----------|---------|------|------|
| 02:00 | 10:00 | 全量预热 | 预热全部 7 天订单 |
| 08:00 | 16:00 | 增量预热 | 新订单 + 刷新物流 |
| 14:00 | 22:00 | 增量预热 | 新订单 + 刷新物流 |
| 20:00 | 04:00 | 增量预热 | 新订单 + 刷新物流 |

### 2.3 用户请求优先机制

```python
# 伪代码
class WarmupService:
    def warmup_order(self, order_number):
        # 检查是否有用户请求正在进行
        if self.has_pending_user_request():
            await asyncio.sleep(1)  # 暂停 1 秒，让出资源

        # 使用较低的速率
        await self.rate_limiter.acquire()  # 0.5次/秒

        # 执行预热
        await self.shopify_service.search_order_by_number(order_number)
```

---

## 3. 开发任务拆解

### 阶段 1: 基础设施 (预计 2 个增量)

#### 任务 1.1: 修改缓存 TTL 配置
- **文件**: `src/shopify_uk_cache.py`
- **改动**:
  - 订单详情 TTL: 3600 → 172800 (48小时)
  - 物流信息 TTL: 3600 → 21600 (6小时)
  - 订单搜索 TTL: 3600 → 172800 (48小时)
- **状态**: [x] ✅ 已完成
- **验证**: 调用 API 后检查 Redis TTL

#### 任务 1.2: 添加 APScheduler 依赖
- **文件**: `requirements.txt`, `backend.py`
- **改动**:
  - 添加 `apscheduler` 依赖
  - 在 backend.py 中初始化调度器
- **状态**: [x] ✅ 已完成
- **验证**: 服务启动时调度器正常初始化

---

### 阶段 2: 预热服务核心 (预计 3 个增量)

#### 任务 2.1: 创建预热服务模块
- **文件**: `src/warmup_service.py` (新建)
- **功能**:
  - `WarmupService` 类
  - `get_recent_orders(days=7)` - 获取最近 N 天的订单号列表
  - `warmup_order(order_number)` - 预热单个订单
  - `warmup_tracking(order_id)` - 预热物流信息
- **状态**: [x] ✅ 已完成
- **验证**: 单元测试通过

#### 任务 2.2: 实现全量预热逻辑
- **文件**: `src/warmup_service.py`
- **功能**:
  - `full_warmup()` - 全量预热 7 天订单
  - 速率限制 0.5次/秒
  - 失败重试机制（最多 3 次）
  - 详细日志记录
- **状态**: [x] ✅ 已完成
- **验证**: 手动触发全量预热成功

#### 任务 2.3: 实现增量预热逻辑
- **文件**: `src/warmup_service.py`
- **功能**:
  - `incremental_warmup()` - 增量预热
  - 只预热新订单 + 即将过期的缓存
  - 用户请求优先机制
- **状态**: [x] ✅ 已完成
- **验证**: 手动触发增量预热成功

---

### 阶段 3: 调度与 API (预计 2 个增量)

#### 任务 3.1: 配置定时调度任务
- **文件**: `backend.py`
- **功能**:
  - 使用 APScheduler 配置 4 个定时任务
  - 02:00 UTC 全量预热
  - 08:00/14:00/20:00 UTC 增量预热
- **状态**: [x] ✅ 已完成
- **验证**: 查看调度器任务列表

#### 任务 3.2: 添加预热管理 API
- **文件**: `backend.py`
- **API**:
  - `GET /api/warmup/status` - 查看预热状态
  - `POST /api/warmup/trigger` - 手动触发预热
  - `GET /api/warmup/history` - 预热历史记录
  - `POST /api/warmup/stop` - 停止预热任务
- **状态**: [x] ✅ 已完成
- **验证**: API 文档可访问，功能正常

---

### 阶段 4: 测试与部署 (预计 2 个增量)

#### 任务 4.1: 编写测试脚本
- **文件**: `tests/test_warmup.sh` (新建)
- **测试项**:
  - 预热服务初始化
  - 全量预热功能
  - 增量预热功能
  - API 接口测试
  - 缓存 TTL 验证
- **状态**: [x] ✅ 已完成
- **验证**: 测试脚本通过

#### 任务 4.2: 部署到生产环境
- **操作**:
  - 提交代码到 Git
  - 部署到生产服务器
  - 验证预热任务正常运行
  - 监控首次预热完成
- **状态**: [ ] 进行中
- **验证**: 生产环境预热正常

---

## 4. 配置清单

### 4.1 环境变量 (.env)

```bash
# 预热配置
WARMUP_ENABLED=true
WARMUP_ORDER_DAYS=7
WARMUP_RATE_LIMIT=0.5
WARMUP_PAUSE_ON_USER_REQUEST=true

# 缓存 TTL (秒)
CACHE_ORDER_DETAIL_TTL=172800
CACHE_TRACKING_TTL=21600
CACHE_ORDER_SEARCH_TTL=172800
```

### 4.2 调度配置

```python
# APScheduler 任务配置
WARMUP_SCHEDULE = [
    {"hour": 2, "minute": 0, "type": "full"},      # 02:00 UTC
    {"hour": 8, "minute": 0, "type": "incremental"},  # 08:00 UTC
    {"hour": 14, "minute": 0, "type": "incremental"}, # 14:00 UTC
    {"hour": 20, "minute": 0, "type": "incremental"}, # 20:00 UTC
]
```

---

## 5. API 接口设计

### 5.1 GET /api/warmup/status

**响应示例**:
```json
{
  "success": true,
  "data": {
    "enabled": true,
    "last_full_warmup": "2025-12-10T02:00:00Z",
    "last_incremental_warmup": "2025-12-10T14:00:00Z",
    "next_scheduled": "2025-12-10T20:00:00Z",
    "stats": {
      "total_orders_warmed": 1400,
      "cache_hit_rate": "95.2%",
      "last_warmup_duration": "93 minutes"
    }
  }
}
```

### 5.2 POST /api/warmup/trigger

**请求参数**:
```json
{
  "type": "full" | "incremental",
  "days": 7  // 可选，覆盖默认值
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "预热任务已启动",
  "task_id": "warmup_20251210_150000"
}
```

---

## 6. 验收标准

### 6.1 功能验收

- [ ] 全量预热可手动触发并成功完成
- [ ] 增量预热可手动触发并成功完成
- [ ] 定时任务按计划执行
- [ ] 预热期间用户请求不受影响
- [ ] 缓存 TTL 正确设置

### 6.2 性能验收

- [ ] 预热后，缓存命中查询 < 1 秒
- [ ] 缓存命中率 > 95%
- [ ] 预热速率稳定在 0.5 次/秒
- [ ] 全量预热耗时 < 2 小时

### 6.3 稳定性验收

- [ ] 预热失败自动重试
- [ ] 详细日志记录
- [ ] 不影响现有功能

---

## 7. 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| Shopify API 限流 | 预热失败 | 降低速率，失败重试 |
| Redis 内存不足 | 缓存失效 | 监控内存，设置上限 |
| 预热任务崩溃 | 缓存过期 | 异常捕获，告警通知 |
| 订单量激增 | 预热不完整 | 动态调整预热范围 |

---

## 8. 开发顺序

```
任务 1.1 (缓存TTL) → 任务 1.2 (APScheduler)
                          ↓
任务 2.1 (预热服务模块) → 任务 2.2 (全量预热) → 任务 2.3 (增量预热)
                                                      ↓
                          任务 3.1 (定时调度) → 任务 3.2 (管理API)
                                                      ↓
                          任务 4.1 (测试脚本) → 任务 4.2 (部署)
```

**预计总增量**: 9 个
**预计总耗时**: 按增量开发，每个增量完成后提交

---

## 9. 更新记录

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| v1.0 | 2025-12-10 | 初始版本 |

