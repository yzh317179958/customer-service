# 物流通知 EDM 与异常监控功能 - 架构设计方案

> **编制时间**：2024年12月18日
> **需求提出**：杨子豪
> **文档版本**：v1.0

---

## 一、需求理解

### 1.1 三个核心需求

| 需求 | 触发条件 | 通知内容 | 优先级 |
|------|----------|----------|--------|
| 预售通知 | 客户下单（特定预售产品/SKU） | 预设的发货日期 | 高 |
| 拆包裹通知 | 第一个包裹发出时 | 订单将拆分发货 + Tracking 链接 | 高 |
| 异常监控 | 定时扫描 | 超时物流订单告警 | 中 |

### 1.2 异常监控规则

| 渠道类型 | 超时阈值 | 说明 |
|----------|----------|------|
| 海外仓渠道 | 运输中 > 7 天 | 有渠道列表 |
| 中国仓渠道 | 运输中 > 12 天 | 有渠道列表 |

---

## 二、核心问题：独立模块还是集成？

### 2.1 深度分析

**先说结论：建议采用"独立模块 + 数据共享 + 可选 AI 集成"的混合架构。**

原因分析：

```
┌─────────────────────────────────────────────────────────────────┐
│                        功能性质对比                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   AI 客服系统                    物流通知/异常监控               │
│   ─────────────                  ─────────────────              │
│   • 被动响应（用户发起）          • 主动触发（系统发起）          │
│   • 实时对话                      • 定时任务/事件驱动             │
│   • 需要 AI 理解                  • 规则判断（无需 AI）           │
│   • 交互式                        • 单向通知                     │
│   • 会话上下文                    • 无上下文                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 两者的交集

虽然是不同性质的功能，但有重要的**数据和能力交集**：

| 共享资源 | 说明 |
|----------|------|
| Shopify 订单数据 | 都需要查询订单、商品、物流信息 |
| 邮件发送能力 | 都需要发送 EDM 邮件 |
| Redis 缓存 | 都可以利用缓存提升性能 |
| 定时任务框架 | 都需要定时执行 |
| 客户邮箱 | 都需要获取客户联系方式 |

**潜在的 AI 集成场景**（可选，非必须）：

| 场景 | AI 介入方式 |
|------|------------|
| 异常订单处理 | AI 客服主动推送："您的订单物流异常，是否需要帮助？" |
| 预售咨询 | 用户问预售时间，AI 自动查询并回复 |
| 拆包裹查询 | 用户问包裹进度，AI 知道是拆分发货 |

---

## 三、推荐架构方案

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Fiido 智能服务平台                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────┐      ┌──────────────────────┐            │
│  │    AI 客服模块        │      │   物流通知模块        │            │
│  │    (现有系统)         │      │   (新建独立模块)      │            │
│  │                      │      │                      │            │
│  │  • 智能对话          │      │  • 预售通知           │            │
│  │  • 订单查询          │◄────►│  • 拆包裹通知         │            │
│  │  • 人工接管          │ 数据  │  • 异常监控           │            │
│  │  • 工单系统          │ 共享  │  • 定时扫描           │            │
│  └──────────┬───────────┘      └──────────┬───────────┘            │
│             │                             │                        │
│             ▼                             ▼                        │
│  ┌─────────────────────────────────────────────────────────┐       │
│  │                     共享服务层                           │       │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │       │
│  │  │ Shopify     │ │ Email       │ │ Redis       │       │       │
│  │  │ Service     │ │ Service     │ │ Cache       │       │       │
│  │  └─────────────┘ └─────────────┘ └─────────────┘       │       │
│  └─────────────────────────────────────────────────────────┘       │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────┐       │
│  │                     外部服务                             │       │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │       │
│  │  │ Shopify API │ │ SMTP 邮件   │ │ Coze AI     │       │       │
│  │  │ (9 站点)    │ │ 服务        │ │ (可选集成)   │       │       │
│  │  └─────────────┘ └─────────────┘ └─────────────┘       │       │
│  └─────────────────────────────────────────────────────────┘       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 为什么不用 Coze 工作流？

| 考虑因素 | Coze 工作流 | 独立后端模块 |
|----------|-------------|--------------|
| 定时任务 | 不支持（需外部触发） | 原生支持 APScheduler |
| 批量处理 | 需要逐条调用，消耗 Token | 直接批量查询，无 Token 消耗 |
| 规则判断 | 简单判断也消耗 Token | 代码判断，零成本 |
| 邮件发送 | 需要配置插件 | 已有成熟 SMTP 服务 |
| 数据库操作 | 需要外部 API | 直接操作 Redis |
| 成本 | 每次调用消耗 Token | 仅服务器成本 |
| 灵活性 | 受工作流限制 | 完全可控 |

**结论：物流通知和异常监控属于"规则驱动的批量任务"，不适合用 Coze 工作流。**

Coze 适合的场景：
- 需要自然语言理解
- 需要复杂推理
- 需要知识库检索
- 交互式对话

---

## 四、模块设计方案

### 4.1 模块结构

```
src/
├── notification/                    # 新建：物流通知模块
│   ├── __init__.py
│   ├── config.py                   # 配置管理（SKU、渠道、阈值）
│   ├── models.py                   # 数据模型
│   ├── presale_notifier.py         # 预售通知服务
│   ├── split_package_notifier.py   # 拆包裹通知服务
│   ├── anomaly_monitor.py          # 异常监控服务
│   ├── email_templates.py          # 邮件模板
│   └── scheduler.py                # 定时任务调度
│
├── shopify_service.py              # 现有：复用
├── email_service.py                # 现有：增强
└── ...
```

### 4.2 预售通知设计

**触发方式**：Shopify Webhook（订单创建时）

```
Shopify 新订单 ──► Webhook ──► 后端接收 ──► 检查是否预售商品
                                              │
                                              ▼
                                    是 ──► 发送预售通知邮件
                                              │
                                              ▼
                                    否 ──► 跳过
```

**配置示例**：

```python
PRESALE_PRODUCTS = {
    # SKU -> 预计发货日期
    "FIIDO-X-PRO-BLACK": "2025年1月15日",
    "FIIDO-X-PRO-WHITE": "2025年1月15日",

    # 或者按产品标题匹配
    "title_contains": {
        "Pre-order": "订单确认后 30 个工作日内发货",
        "预售": "订单确认后 30 个工作日内发货",
    }
}
```

**邮件内容**：

```
主题：您的预售订单已确认 - 预计发货时间通知

尊敬的客户，

感谢您购买 Fiido 预售商品！

订单号：#UK22080
商品：Fiido X Pro 电动自行车（黑色）
预计发货时间：2025年1月15日

我们将在发货后第一时间通知您。如有疑问，请联系客服。

Fiido 团队
```

### 4.3 拆包裹通知设计

**触发方式**：Shopify Webhook（发货时）或 定时扫描

```
方案 A：Webhook 触发（实时）
─────────────────────────────
Shopify 发货 ──► Webhook ──► 检查订单商品数
                                │
                                ▼
                    商品数 > 已发货数 ──► 是拆包裹
                                │
                                ▼
                    首次发货 ──► 发送拆包裹通知

方案 B：定时扫描（延迟但可靠）
─────────────────────────────
定时任务 ──► 扫描最近发货订单 ──► 筛选 partial 状态
                                    │
                                    ▼
                    检查是否已发送通知 ──► 未发送 ──► 发送通知
```

**邮件内容**：

```
主题：您的订单将分批发货 - 第一个包裹已发出

尊敬的客户，

您的订单 #UK22080 将分批发货。

第一个包裹已发出：
- 商品：Fiido X Pro 电动自行车
- 承运商：Royal Mail
- 运单号：RM123456789GB
- 追踪链接：https://...

剩余商品将在备货完成后尽快发出，届时会再次通知您。

查看完整物流信息：[点击这里]

Fiido 团队
```

### 4.4 异常监控设计

**触发方式**：定时任务（每天执行 1-2 次）

```
定时任务（每天 10:00, 16:00）
        │
        ▼
扫描所有"运输中"订单
        │
        ▼
按渠道分类判断超时
        │
        ├─► 海外仓渠道 + 运输中 > 7天 ──► 标记异常
        │
        └─► 中国仓渠道 + 运输中 > 12天 ──► 标记异常
        │
        ▼
生成异常报告
        │
        ├─► 发送给运营团队（汇总邮件）
        │
        └─► 可选：逐个通知客户
```

**渠道配置示例**：

```python
SHIPPING_CHANNELS = {
    "overseas_warehouse": {
        "name": "海外仓渠道",
        "timeout_days": 7,
        "carriers": [
            "Royal Mail",
            "DPD",
            "Hermes",
            "Yodel",
            "UPS UK",
            "DHL Express",
        ]
    },
    "china_warehouse": {
        "name": "中国仓渠道",
        "timeout_days": 12,
        "carriers": [
            "4PX",
            "YunExpress",
            "CNE Express",
            "Yanwen",
            "SF Express",
            "China Post",
        ]
    }
}
```

**异常报告邮件（发给运营）**：

```
主题：物流异常监控报告 - 2024年12月18日

====== 异常订单汇总 ======

海外仓超时订单（> 7天）：12 单
中国仓超时订单（> 12天）：5 单

====== 海外仓异常详情 ======

1. 订单 #UK22080
   - 客户：john@example.com
   - 承运商：Royal Mail
   - 运单号：RM123456789GB
   - 发货时间：2024-12-08
   - 运输天数：10 天
   - 最后状态：In Transit

2. 订单 #UK22081
   ...

====== 中国仓异常详情 ======
...

====== 建议操作 ======
1. 联系承运商查询延误原因
2. 主动联系客户说明情况
3. 考虑补发或退款
```

---

## 五、与 AI 客服的集成方案（可选）

### 5.1 集成方式

```
物流通知模块                              AI 客服模块
     │                                        │
     │  ┌─────────────────────────────────┐  │
     │  │        共享数据存储              │  │
     │  │                                 │  │
     ├──►  Redis: notification_sent       ◄──┤  AI 可查询通知状态
     │  │  Redis: anomaly_orders          ◄──┤  AI 可查询异常订单
     │  │  Redis: presale_info            ◄──┤  AI 可查询预售信息
     │  │                                 │  │
     │  └─────────────────────────────────┘  │
     │                                        │
     ▼                                        ▼
   邮件通知                             对话中主动告知
```

### 5.2 AI 增强场景

**场景 1：用户咨询预售商品**

```
用户：我下单的电动车什么时候发货？

AI 客服：
1. 查询订单
2. 检测到是预售商品
3. 从 Redis 获取预售发货日期
4. 回复：您购买的是预售商品，预计发货时间为 2025年1月15日...
```

**场景 2：用户咨询物流**

```
用户：我的包裹怎么还没到？

AI 客服：
1. 查询订单物流
2. 检测到运输时间较长
3. 检查是否在异常订单列表中
4. 如果是异常订单：主动说明情况并提供解决方案
```

**场景 3：主动关怀（高级）**

```
异常监控检测到超时订单
        │
        ▼
判断客户是否在线（有活跃会话）
        │
        ├─► 在线：AI 主动推送消息
        │        "我们注意到您的订单物流有延迟，
        │         正在为您跟进，请问还有其他问题吗？"
        │
        └─► 离线：发送邮件通知
```

### 5.3 Coze 工作流增强（可选）

如果希望 AI 能够主动感知和回复物流相关问题，可以：

**方案 A：增加 Coze 插件**

```yaml
# Coze 插件配置
plugins:
  - name: presale_query
    description: 查询预售商品发货时间
    endpoint: /api/presale/query

  - name: anomaly_check
    description: 检查订单是否物流异常
    endpoint: /api/anomaly/check

  - name: split_package_info
    description: 获取拆包裹发货信息
    endpoint: /api/split-package/info
```

**方案 B：丰富现有订单查询返回**

```python
# 在订单查询结果中增加字段
{
    "order_number": "UK22080",
    "is_presale": true,
    "presale_ship_date": "2025-01-15",
    "is_split_package": true,
    "packages_total": 2,
    "packages_shipped": 1,
    "is_anomaly": true,
    "anomaly_reason": "运输超时（已10天）"
}
```

这样 AI 无需额外调用，直接从订单数据中获取信息。

---

## 六、技术实现要点

### 6.1 数据存储设计

```python
# Redis 键设计

# 1. 已发送通知记录（防重复发送）
notification:presale:{order_id}        # 预售通知
notification:split:{order_id}          # 拆包裹通知
notification:anomaly:{order_id}:{date} # 异常通知

# 2. 预售商品配置
presale:sku:{sku}                      # SKU -> 发货日期
presale:product:{product_id}           # 产品 ID -> 发货日期

# 3. 异常订单列表
anomaly:orders:{date}                  # 当日异常订单集合
anomaly:order:{order_id}               # 单个订单异常详情

# 4. 渠道配置
channel:overseas                       # 海外仓渠道列表
channel:china                          # 中国仓渠道列表
```

### 6.2 Shopify Webhook 配置

```
需要订阅的 Webhook 事件：

1. orders/create      - 订单创建（触发预售通知）
2. fulfillments/create - 发货创建（触发拆包裹通知）
3. fulfillments/update - 发货更新（更新物流状态）
```

### 6.3 定时任务配置

```python
# APScheduler 任务配置

# 异常监控：每天 10:00 和 16:00
scheduler.add_job(
    anomaly_monitor.scan_all_orders,
    CronTrigger(hour='10,16', minute=0),
    id='anomaly_scan'
)

# 拆包裹检查：每小时（备用方案，Webhook 失效时）
scheduler.add_job(
    split_package_notifier.check_recent_fulfillments,
    CronTrigger(minute=30),
    id='split_package_check'
)

# 通知重试：每 30 分钟（处理发送失败的通知）
scheduler.add_job(
    notification_retry.process_failed,
    CronTrigger(minute='0,30'),
    id='notification_retry'
)
```

---

## 七、工时估算与排期

### 7.1 任务分解

| 任务 | 描述 | 预计工时 |
|------|------|----------|
| **基础架构** | | |
| 模块结构搭建 | 创建目录、配置、模型 | 0.5 天 |
| 邮件模板系统 | 多语言模板、变量替换 | 1 天 |
| Redis 存储设计 | 键设计、存取封装 | 0.5 天 |
| **预售通知** | | |
| Webhook 接收端点 | 订单创建事件处理 | 0.5 天 |
| SKU 匹配逻辑 | 支持 SKU 和标题匹配 | 0.5 天 |
| 预售邮件发送 | 模板 + 发送 + 记录 | 0.5 天 |
| **拆包裹通知** | | |
| 发货事件处理 | Webhook + 判断逻辑 | 1 天 |
| 拆包裹邮件发送 | 模板 + Tracking 链接 | 0.5 天 |
| 定时扫描备用 | 防 Webhook 丢失 | 0.5 天 |
| **异常监控** | | |
| 渠道配置管理 | 海外仓/中国仓渠道 | 0.5 天 |
| 订单扫描逻辑 | 批量查询 + 超时判断 | 1 天 |
| 异常报告生成 | 汇总 + 详情 + 邮件 | 1 天 |
| 定时任务集成 | APScheduler 配置 | 0.5 天 |
| **测试与优化** | | |
| 单元测试 | 核心逻辑测试 | 1 天 |
| 集成测试 | 端到端测试 | 1 天 |
| 文档编写 | 配置说明、运维手册 | 0.5 天 |

### 7.2 总工时估算

| 模块 | 工时 |
|------|------|
| 基础架构 | 2 天 |
| 预售通知 | 1.5 天 |
| 拆包裹通知 | 2 天 |
| 异常监控 | 3 天 |
| 测试与文档 | 2.5 天 |
| **合计** | **11 天** |

### 7.3 建议排期

考虑到 1 月 5 日 AI 客服上线，建议：

```
方案 A：AI 客服上线后开发（推荐）
──────────────────────────────────
1月6日 - 1月20日：物流通知模块开发（11 天）
1月21日 - 1月23日：测试与修复
1月24日：上线

方案 B：并行开发（需要额外人力）
──────────────────────────────────
12月20日 - 1月3日：物流通知模块开发
1月4日：与 AI 客服一起上线

方案 C：分阶段上线
──────────────────────────────────
第一阶段（1月中旬）：异常监控（最紧急）
第二阶段（1月下旬）：预售通知 + 拆包裹通知
```

---

## 八、总结

### 8.1 核心结论

| 问题 | 答案 |
|------|------|
| 是否独立模块？ | **是**，独立模块 + 数据共享 |
| 与 AI 客服有交集吗？ | **有**，共享订单数据、邮件服务、缓存 |
| 用 Coze 工作流吗？ | **不用**，规则驱动任务不适合 |
| 能集成到 AI 吗？ | **可选**，通过丰富订单数据或增加插件 |

### 8.2 推荐方案

1. **架构**：独立模块，复用现有服务层
2. **触发**：Webhook（实时）+ 定时任务（兜底）
3. **存储**：Redis（配置、状态、防重复）
4. **邮件**：复用现有 SMTP 服务，新增模板
5. **AI 集成**：丰富订单查询返回，AI 自动感知

### 8.3 下一步行动

1. 确认排期方案（A/B/C）
2. 提供渠道列表（海外仓/中国仓的承运商名称）
3. 提供预售商品 SKU 列表
4. 确认邮件模板内容和多语言需求
5. 确认异常订单是否需要通知客户

---

**文档编制**：技术团队
**需求确认**：@杨子豪

---

*如有疑问请随时沟通*
