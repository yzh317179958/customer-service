# 商品状态判断逻辑

> 文档版本: v1.1
> 更新时间: 2025-12-17
> 对应代码版本: v5.3.10

## 一、订单级状态

订单级状态用于显示订单整体情况（如"订单 #UK22081 状态：部分退款"）

| 字段 | 来源 | 可能值 | 说明 |
|------|------|--------|------|
| `financial_status` | Shopify 原生 | paid/pending/refunded/partially_refunded/voided | 订单支付状态 |
| `fulfillment_status` | Shopify 原生 | fulfilled/partial/null | 订单发货状态 |

---

## 二、Shopify 发货相关字段（⚠️ 重要区分）

Shopify API 返回两个容易混淆的状态字段：

| 字段 | 含义 | 可能值 | 说明 |
|------|------|--------|------|
| `fulfillment.status` | **发货操作状态** | success/pending/cancelled/error | `success` = 发货操作成功，**不是**送达成功！ |
| `fulfillment.shipment_status` | **物流运输状态** | delivered/in_transit/out_for_delivery/failure/null | 真正的物流送达状态 |

**⚠️ 关键区别**：
- `status = "success"` 只表示"发货记录创建成功"，不代表包裹已送达
- `shipment_status = "delivered"` 才表示"物流已送达"
- `shipment_status` 可能为 null（物流信息未更新）

---

## 三、商品级状态（核心逻辑）

每个商品独立判断状态，显示在商品卡片上。

### 数据来源

```python
line_items[].delivery_status   # 我们计算后填充的状态（最终显示用）
line_items[].fulfillment_status # Shopify 原生发货状态
```

### 判断流程

```
                    ┌─────────────────────────────┐
                    │     商品是否为服务类？        │
                    │ (Worry-Free/Warranty等)     │
                    └─────────────┬───────────────┘
                                  │
              ┌───────────────────┴───────────────────┐
              │ 是                                     │ 否
              ▼                                       ▼
    ┌─────────────────────┐               ┌─────────────────────┐
    │  服务类商品逻辑       │               │   实物商品逻辑        │
    └─────────┬───────────┘               └─────────┬───────────┘
              │                                     │
              ▼                                     ▼
    ┌─────────────────────┐               ┌─────────────────────┐
    │ 所有实物商品都退款了？ │               │ 该商品在 refunds 中？ │
    └─────────┬───────────┘               └─────────┬───────────┘
              │                                     │
       ┌──────┴──────┐                       ┌──────┴──────┐
       │ 是          │ 否                    │ 是          │ 否
       ▼             ▼                       ▼             ▼
   expired       active              ┌──────────────┐  物流状态判断
   (已失效)      (已生效)             │ restock_type │  (见下方)
                                     └──────┬───────┘
                                            │
                              ┌─────────────┼─────────────┐
                              │             │             │
                              ▼             ▼             ▼
                           return        cancel      no_restock
                              │             │             │
                              ▼             ▼             ▼
                          returned     cancelled      refunded
                         (已退货退款)   (已取消)       (已退款)
```

---

## 四、实物商品状态优先级（v1.1 更新）

```
1. 退款状态（最高优先级）
   └── returned (退货退款)
   └── refunded (仅退款)
   └── cancelled (取消退款)

2. 物流运输状态（次优先级）- 使用 shipment_status
   └── delivered → 已收货 (映射为 success)
   └── in_transit → 运输中
   └── out_for_delivery → 派送中
   └── failure → 投递失败

3. 发货状态（最低优先级）- 当 shipment_status 为空时
   └── fulfillment_status = fulfilled → 已发货
   └── fulfillment_status = null → 待发货
```

**代码逻辑**（`src/shopify_client.py`）：
```python
# 状态判断优先级：shipment_status > status > fulfillment_status
shipment_status = fulfillment_info.get("shipment_status")
f_status = fulfillment_info.get("status")

if shipment_status:
    # 优先使用物流运输状态
    if shipment_status == "delivered":
        delivery_status = "success"  # 已送达 → 已收货
    else:
        delivery_status = shipment_status  # in_transit, out_for_delivery, failure 等
elif f_status == "success":
    # 发货成功但没有 shipment_status，说明已发货但物流状态未知
    delivery_status = None  # 让前端根据 fulfillment_status 显示"已发货"
else:
    delivery_status = f_status if f_status else None
```

---

## 五、服务类商品状态逻辑

服务类商品包括：Worry-Free Purchase、Warranty、Protection、Insurance 等无需物流发货的增值服务。

### 识别规则

通过商品名称或 SKU 识别：
- 名称包含：`worry-free`, `warranty`, `protection`, `insurance`, `service plan`
- SKU 前缀：`seel`, `wfp`, `warranty`

### 状态判断

| 条件 | delivery_status | 显示 |
|------|-----------------|------|
| 订单全额退款 OR 所有实物商品都退款 | `expired` | 已失效 |
| 订单已支付 且 有未退款实物商品 | `active` | 已生效 |
| 订单待支付 | `pending` | 待支付 |

**核心逻辑**：服务类商品跟随订单整体状态，只有所有实物商品都退款了，服务类商品才显示"已失效"。

---

## 六、Shopify refunds 数据结构

Shopify API 返回的退款信息：

```json
{
  "refunds": [
    {
      "id": 1003038146861,
      "created_at": "2025-12-09T09:50:28+08:00",
      "note": "退款原因说明",
      "refund_line_items": [
        {
          "line_item": {
            "title": "商品名称"
          },
          "quantity": 1,
          "restock_type": "return"  // return/cancel/no_restock
        }
      ]
    }
  ]
}
```

### restock_type 含义

| 值 | 含义 | 场景 | 对应状态 |
|----|------|------|----------|
| `return` | 退货退款 | 客户退回商品 | `returned` |
| `cancel` | 取消退款 | 未发货就取消 | `cancelled` |
| `no_restock` | 仅退款 | 不退货的退款（补偿、服务类商品等） | `refunded` |

---

## 七、示例场景

### 场景1: UK22103（运输中，非送达）
- 订单支付状态: `paid`
- fulfillment.status: `success`（发货成功）
- fulfillment.shipment_status: `in_transit`（运输中）

| 商品 | 类型 | 判断逻辑 | delivery_status | 显示 |
|------|------|----------|-----------------|------|
| Worry-Free Purchase | 服务类 | 订单已支付 → 已生效 | `active` | 已生效 |
| Titan battery with bag | 实物 | shipment_status=in_transit | `in_transit` | **运输中**（不是已收货！） |

### 场景2: UK22081（部分退款）
- 订单支付状态: `partially_refunded`
- Worry-Free Purchase 被退款，但 phone holder 未退款

| 商品 | 类型 | 判断逻辑 | delivery_status | 显示 |
|------|------|----------|-----------------|------|
| Worry-Free Purchase | 服务类 | 有未退款实物(phone holder) → 已生效 | `active` | 已生效 |
| Fiido phone holder | 实物 | shipment_status=delivered | `success` | 已收货 |

### 场景3: UK21216（全额退款）
- 订单支付状态: `refunded`
- 所有商品都被退款

| 商品 | 类型 | 判断逻辑 | delivery_status | 显示 |
|------|------|----------|-----------------|------|
| Worry-Free Purchase | 服务类 | 所有实物都退款 → 已失效 | `expired` | 已失效 |
| Rear Pegs for T2 | 实物 | 在refunds中 + restock_type=return | `returned` | 已退货退款 |

### 场景4: DE10090（取消订单）
- 订单支付状态: `refunded`
- 未发货就取消

| 商品 | 类型 | 判断逻辑 | delivery_status | 显示 |
|------|------|----------|-----------------|------|
| 电动车 | 实物 | 在refunds中 + restock_type=cancel | `cancelled` | 已取消 |

### 场景5: UK22080（已送达）
- 订单支付状态: `paid`
- fulfillment.shipment_status: `delivered`

| 商品 | 类型 | 判断逻辑 | delivery_status | 显示 |
|------|------|----------|-----------------|------|
| Worry-Free Purchase | 服务类 | 订单已支付 → 已生效 | `active` | 已生效 |
| Titan Ebike | 实物 | shipment_status=delivered | `success` | 已收货 |
| Pannier Bag | 实物 | shipment_status=delivered | `success` | 已收货 |

---

## 八、状态翻译对照表

| delivery_status | 英文 | 中文 | 前端样式 |
|-----------------|------|------|----------|
| `returned` | Returned & Refunded | 已退货退款 | 紫色 |
| `refunded` | Refunded | 已退款 | 灰色 |
| `expired` | Expired | 已失效 | 灰色 |
| `cancelled` | Cancelled | 已取消 | 浅灰色 |
| `active` | Active | 已生效 | 绿色 |
| `success` | Received | 已收货 | 绿色 |
| `in_transit` | In Transit | 运输中 | 蓝色 |
| `out_for_delivery` | Out for Delivery | 派送中 | 蓝色 |
| `failure` | Delivery Failed | 投递失败 | 红色 |
| `fulfilled` (无delivery_status) | Shipped | 已发货 | 青色 |
| `null/pending` | Pending | 待发货 | 黄色 |

---

## 九、相关代码文件

| 文件 | 说明 |
|------|------|
| `src/shopify_client.py` | 商品状态判断核心逻辑 (`_parse_order_detail` 方法) |
| `src/shopify_tracking.py` | 状态翻译映射表 |
| `frontend/src/components/ChatMessage.vue` | 前端状态样式渲染 |
| `prompts/订单查询回复.md` | AI 回复提示词（需同步到 Coze） |

---

## 十、缓存配置

| 缓存类型 | TTL | 说明 |
|----------|-----|------|
| order_list | 5 分钟 | 按邮箱查询订单列表 |
| order_detail | 48 小时 | 按订单ID获取详情 |
| order_search | 48 小时 | 按订单号搜索 |
| tracking | 6 小时 | 物流追踪信息 |
| order_count | 60 分钟 | 订单数量统计 |

**注意**：修改状态逻辑后，需要清除相关订单的缓存才能看到更新后的状态。

```bash
# 清除单个订单缓存
redis-cli DEL 'shopify:uk:orders:search:UK22081'

# 清除所有订单搜索缓存
redis-cli KEYS 'shopify:*:orders:search:*' | xargs redis-cli DEL
```

---

## 十一、版本更新记录

### v1.1 (2025-12-17)
- **修复状态判断Bug**：区分 `fulfillment.status`（发货操作状态）和 `fulfillment.shipment_status`（物流运输状态）
- `status = "success"` 只表示发货成功，不是送达成功
- `shipment_status = "delivered"` 才表示物流已送达
- 新增第二节"Shopify 发货相关字段"详细说明
