# Fiido 智能客服系统 - 安全防护方案

> **编制时间**：2024年12月18日
> **文档版本**：v1.0
> **目标读者**：技术团队、运维团队

---

## 一、威胁分析概述

针对 AI 客服系统，攻击者的主要目标：

| 攻击目标 | 攻击者收益 | 对我们的影响 |
|----------|------------|--------------|
| 消耗 AI Token | 增加我们的 API 成本 | 账单暴涨，成本失控 |
| 占用并发资源 | 使正常用户无法使用 | 服务不可用，用户流失 |
| 获取敏感数据 | 窃取用户/订单信息 | 数据泄露，法律风险 |

---

## 二、可能的攻击手段与防护方案

### 2.1 Token 消耗攻击

**攻击原理**：恶意用户通过大量发送对话请求，消耗 Coze API 的 Token 配额，导致账单暴涨。

#### 攻击方式

| 攻击方式 | 技术手段 | 危害程度 |
|----------|----------|----------|
| 脚本批量请求 | 编写脚本循环调用 /api/chat 接口 | 高 |
| 长文本攻击 | 发送超长消息，每次消耗大量 Token | 高 |
| 多会话并发 | 创建大量 session，同时发起请求 | 高 |
| 复杂问题诱导 | 故意提问需要长篇回答的问题 | 中 |

#### 防护方案

| 防护措施 | 实现方式 | 优先级 |
|----------|----------|--------|
| 请求频率限制 | 每个 IP/用户每分钟最多 N 次请求 | 必须 |
| 消息长度限制 | 单条消息最大 500-1000 字符 | 必须 |
| 会话数量限制 | 每个 IP 同时最多 3 个活跃会话 | 必须 |
| Token 用量监控 | 实时监控 API 调用量，超阈值告警 | 必须 |
| 每日上限熔断 | 单用户/IP 每日 Token 消耗上限 | 建议 |

**具体配置建议**：

```
单 IP 限制：
- 每分钟最多 20 次对话请求
- 每小时最多 100 次对话请求
- 每天最多 500 次对话请求

单会话限制：
- 单条消息最大 1000 字符
- 单次对话最大轮次 50 轮
- 会话空闲 30 分钟自动关闭

全局限制：
- 每日 Token 消耗上限（根据预算设定）
- 达到 80% 时告警，达到 100% 时熔断
```

---

### 2.2 并发资源耗尽攻击（CC 攻击）

**攻击原理**：大量请求同时涌入，占满服务器连接数和处理能力，导致正常用户无法访问。

#### 攻击方式

| 攻击方式 | 技术手段 | 危害程度 |
|----------|----------|----------|
| HTTP 洪水 | 大量 HTTP 请求压垮服务器 | 高 |
| 慢速攻击 | 建立连接后故意缓慢发送数据 | 高 |
| SSE 占用 | 建立大量流式连接不释放 | 高 |
| API 遍历 | 批量调用各种 API 接口 | 中 |

#### 防护方案

| 防护措施 | 实现方式 | 优先级 |
|----------|----------|--------|
| IP 请求限制 | 单 IP 每秒最多 10 次请求 | 必须 |
| 连接数限制 | 单 IP 最多 10 个并发连接 | 必须 |
| 超时控制 | 请求超时 30 秒，连接超时 60 秒 | 必须 |
| SSE 连接限制 | 单 IP 最多 3 个流式连接 | 必须 |
| CDN/WAF 防护 | 接入云厂商 DDoS 防护 | 建议 |
| IP 黑名单 | 自动封禁异常 IP | 建议 |

**具体配置建议**：

```
连接限制：
- 单 IP 并发连接数：最多 10 个
- 单 IP 每秒请求数：最多 10 次
- SSE 流式连接：单 IP 最多 3 个

超时设置：
- 请求读取超时：30 秒
- 连接保持超时：60 秒
- SSE 心跳间隔：15 秒
- SSE 最长连接：10 分钟

自动封禁规则：
- 1 分钟内超过 100 次请求 → 封禁 10 分钟
- 1 小时内触发 3 次封禁 → 封禁 24 小时
- 触发 5 次 24 小时封禁 → 永久封禁
```

---

### 2.3 身份伪造攻击

**攻击原理**：伪造或盗用用户身份，绕过限制或获取他人数据。

#### 攻击方式

| 攻击方式 | 技术手段 | 危害程度 |
|----------|----------|----------|
| Session 伪造 | 猜测或伪造 session_id | 高 |
| 重放攻击 | 截获并重放有效请求 | 中 |
| IP 伪装 | 使用代理池轮换 IP | 中 |
| 浏览器指纹伪造 | 模拟不同设备特征 | 低 |

#### 防护方案

| 防护措施 | 实现方式 | 优先级 |
|----------|----------|--------|
| Session 加密 | 使用不可预测的 session_id | 必须 |
| 请求签名 | 关键请求添加时间戳签名 | 建议 |
| 设备指纹 | 结合 IP + 浏览器特征识别 | 建议 |
| 验证码 | 异常行为时触发人机验证 | 建议 |
| 行为分析 | 识别机器人行为特征 | 可选 |

---

### 2.4 数据窃取攻击

**攻击原理**：通过各种手段获取系统中的敏感数据（用户信息、订单数据等）。

#### 攻击方式

| 攻击方式 | 技术手段 | 危害程度 |
|----------|----------|----------|
| 订单遍历 | 批量猜测订单号获取订单信息 | 高 |
| API 未授权访问 | 直接调用后台管理接口 | 高 |
| 注入攻击 | SQL 注入、命令注入 | 高 |
| XSS 攻击 | 窃取用户 Cookie/Token | 中 |

#### 防护方案

| 防护措施 | 实现方式 | 优先级 |
|----------|----------|--------|
| 接口鉴权 | 所有敏感接口必须登录验证 | 必须 |
| 参数校验 | 严格验证输入参数格式 | 必须 |
| 订单查询限制 | 必须验证邮箱归属 | 必须 |
| 日志审计 | 记录所有敏感操作 | 必须 |
| 数据脱敏 | 返回数据隐藏敏感字段 | 建议 |

---

## 三、防护体系架构

```
                    ┌─────────────────┐
                    │   CDN / WAF     │  ← 第一道防线：DDoS 防护、基础过滤
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   Nginx 网关    │  ← 第二道防线：IP 限流、连接限制
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   应用层限流    │  ← 第三道防线：业务级限制
                    │  (slowapi等)    │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   业务逻辑层    │  ← 第四道防线：参数校验、权限验证
                    │   (FastAPI)     │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   监控告警层    │  ← 持续监控：异常检测、实时告警
                    └─────────────────┘
```

---

## 四、当前系统安全现状

### 4.1 已有的安全措施

| 措施 | 现状 | 说明 |
|------|------|------|
| JWT 认证 | 已实现 | 坐席工作台接口已有鉴权 |
| Session 隔离 | 已实现 | 每个用户独立的 conversation_id |
| OAuth 2.0 | 已实现 | Coze API 调用使用 OAuth 认证 |
| HTTPS | 已启用 | 传输层加密 |
| 参数校验 | 部分实现 | Pydantic 模型验证 |

### 4.2 缺失的安全措施

| 措施 | 现状 | 风险等级 |
|------|------|----------|
| API 请求限流 | 未实现 | 高 |
| IP 黑名单 | 未实现 | 高 |
| 消息长度限制 | 未实现 | 高 |
| Token 用量监控 | 未实现 | 高 |
| WAF 防护 | 未接入 | 中 |
| 验证码机制 | 未实现 | 中 |
| 行为分析 | 未实现 | 低 |

---

## 五、实施计划

### 5.1 第一阶段：紧急防护（上线前必须完成）

**目标**：防止最基本的恶意攻击

| 任务 | 工时 | 负责人 |
|------|------|--------|
| 实现 API 请求限流（slowapi） | 1 天 | |
| 添加消息长度限制 | 0.5 天 | |
| 配置 Nginx 连接限制 | 0.5 天 | |
| 添加 Token 用量日志 | 0.5 天 | |

**限流配置示例**：

```python
# 使用 slowapi 实现限流
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/api/chat")
@limiter.limit("20/minute")  # 每分钟最多 20 次
async def chat(request: ChatRequest):
    # 消息长度检查
    if len(request.message) > 1000:
        raise HTTPException(400, "消息过长，最多 1000 字符")
    ...
```

**Nginx 配置示例**：

```nginx
# 连接数限制
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
limit_conn conn_limit 10;

# 请求频率限制
limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;
limit_req zone=req_limit burst=20 nodelay;
```

### 5.2 第二阶段：增强防护（上线后 1-2 周）

**目标**：完善监控和自动封禁

| 任务 | 工时 | 负责人 |
|------|------|--------|
| Token 用量监控和告警 | 1 天 | |
| IP 黑名单自动封禁 | 1 天 | |
| 异常行为检测 | 2 天 | |
| 接入云 WAF 服务 | 1 天 | |

### 5.3 第三阶段：深度防护（上线后 1 个月）

**目标**：建立完整的安全体系

| 任务 | 工时 | 负责人 |
|------|------|--------|
| 验证码机制 | 2 天 | |
| 设备指纹识别 | 2 天 | |
| 行为分析系统 | 3 天 | |
| 安全审计报告 | 1 天 | |

---

## 六、监控告警配置

### 6.1 关键指标

| 指标 | 正常范围 | 告警阈值 | 处理方式 |
|------|----------|----------|----------|
| 每分钟请求数 | < 1000 | > 2000 | 通知运维 |
| 单 IP 请求数 | < 20/分钟 | > 50/分钟 | 自动封禁 |
| API 错误率 | < 1% | > 5% | 通知开发 |
| 响应时间 | < 2 秒 | > 5 秒 | 排查性能 |
| Token 日消耗 | 按预算 | > 80% 预算 | 通知负责人 |

### 6.2 告警通知

| 级别 | 触发条件 | 通知方式 | 响应时间 |
|------|----------|----------|----------|
| 紧急 | 服务不可用、Token 超限 | 电话 + 短信 | 5 分钟 |
| 严重 | 攻击检测、异常流量 | 短信 + 邮件 | 15 分钟 |
| 警告 | 指标超阈值 | 邮件 + 钉钉 | 1 小时 |
| 信息 | 日常监控 | 邮件 | 次日 |

---

## 七、应急响应流程

### 7.1 发现攻击

```
1. 监控告警触发
   │
   ▼
2. 确认攻击类型
   │
   ├─→ Token 消耗攻击 → 执行 7.2 流程
   ├─→ CC 并发攻击 → 执行 7.3 流程
   └─→ 数据窃取攻击 → 执行 7.4 流程
```

### 7.2 Token 消耗攻击响应

```
1. 立即启用 Token 熔断（暂停 AI 服务）
2. 分析攻击来源 IP
3. 封禁恶意 IP
4. 降低限流阈值
5. 恢复服务
6. 持续监控
```

### 7.3 CC 并发攻击响应

```
1. 启用云 WAF 紧急防护
2. 临时提高 Nginx 限流
3. 必要时切换到备用 IP
4. 分析攻击特征
5. 更新防护规则
6. 恢复正常配置
```

### 7.4 数据窃取攻击响应

```
1. 封禁可疑 IP
2. 审计操作日志
3. 评估数据泄露范围
4. 修复安全漏洞
5. 通知相关用户（如需要）
6. 更新安全策略
```

---

## 八、成本评估

### 8.1 防护措施成本

| 措施 | 类型 | 预估成本 |
|------|------|----------|
| slowapi 限流 | 代码实现 | 0（开源） |
| Nginx 配置 | 配置调整 | 0 |
| 云 WAF | 服务订阅 | 500-2000 元/月 |
| 监控告警 | 服务订阅 | 300-1000 元/月 |
| 验证码服务 | 按量付费 | 0.01 元/次 |

### 8.2 不防护的潜在损失

| 风险 | 潜在损失 |
|------|----------|
| Token 被刷爆 | 单日可能损失数千至数万元 |
| 服务中断 | 用户流失、品牌损害 |
| 数据泄露 | 法律责任、赔偿 |

---

## 九、总结

### 9.1 上线前必须完成

1. **API 请求限流** - 防止脚本批量请求
2. **消息长度限制** - 防止长文本攻击
3. **Nginx 连接限制** - 防止并发攻击
4. **Token 用量日志** - 便于事后分析

### 9.2 上线后持续完善

1. 监控告警体系
2. 自动封禁机制
3. 云 WAF 接入
4. 验证码机制

### 9.3 安全是持续过程

- 定期审查安全配置
- 关注安全漏洞公告
- 定期进行安全测试
- 持续优化防护策略

---

**文档编制**：技术团队
**审核**：
**批准**：

---

*本文档仅供内部使用*
