# 开发参考手册

> 文档版本: v1.0
> 更新时间: 2025-12-16
> 本文档包含开发过程中的详细参考信息，是 CLAUDE.md 的补充文档

---

## 一、生产服务器详细配置

### 1.1 服务器基本信息

| 配置项 | 值 |
|-------|-----|
| 服务器地址 | `8.211.27.199` |
| 登录用户 | `root` |
| 登录密码 | `Tr&gbt85A>9a@HhuO|g,tov%fN6#Z` |
| 操作系统 | Ubuntu |
| 域名 | ai.fiido.com |

### 1.2 目录结构详情

| 用途 | 路径 | 说明 |
|-----|------|------|
| 项目根目录 | `/opt/fiido-ai-service/` | Git 仓库所在目录 |
| 后端入口 | `/opt/fiido-ai-service/backend.py` | FastAPI 主服务 |
| 后端模块 | `/opt/fiido-ai-service/src/` | Python 模块 |
| 前端源码 | `/opt/fiido-ai-service/frontend/` | Vue 项目源码 |
| 前端部署目录 | `/var/www/fiido-frontend/` | Nginx 静态文件目录 |
| Python 虚拟环境 | `/opt/fiido-ai-service/venv/` | Python 依赖 |
| 静态资源 | `/opt/fiido-ai-service/assets/` | 图片等静态资源 |
| 提示词模板 | `/opt/fiido-ai-service/prompts/` | AI 提示词文件 |

### 1.3 服务配置详情

| 配置 | 值 | 说明 |
|-----|-----|------|
| 后端服务名 | `fiido-ai-backend` | systemd 服务名 |
| 后端监听端口 | 8000 | 本地监听，Nginx 反代 |
| Nginx 配置目录 | `/etc/nginx/sites-enabled/` | 站点配置 |
| systemd 配置 | `/etc/systemd/system/fiido-ai-backend.service` | 服务配置文件 |
| Redis | localhost:6379 | 缓存服务 |

### 1.4 访问地址

| 环境 | 地址 | 说明 |
|-----|------|------|
| 用户端 (AI客服) | https://ai.fiido.com/chat-test/ | 生产环境用户端 |
| 后端 API | https://ai.fiido.com/api/ | 生产环境 API |
| 本地后端 | http://localhost:8000 | 开发环境 |
| 本地用户端 | http://localhost:5173 | 开发环境 |
| 本地坐席工作台 | http://localhost:5174 | 开发环境 |

---

## 二、部署操作手册

### 2.1 完整部署流程

```bash
# 1. SSH 登录服务器
sshpass -p 'Tr&gbt85A>9a@HhuO|g,tov%fN6#Z' ssh -o StrictHostKeyChecking=no root@8.211.27.199

# 2. 拉取最新代码
cd /opt/fiido-ai-service && git pull origin main

# 3. 重启后端服务
systemctl restart fiido-ai-backend
systemctl status fiido-ai-backend --no-pager

# 4. 构建前端
cd /opt/fiido-ai-service/frontend && npm run build

# 5. 部署前端到 Nginx 目录
rm -rf /var/www/fiido-frontend/* && cp -r dist/* /var/www/fiido-frontend/

# 6. 验证部署
curl -s https://ai.fiido.com/api/health | jq
```

### 2.2 仅部署后端

```bash
sshpass -p 'Tr&gbt85A>9a@HhuO|g,tov%fN6#Z' ssh root@8.211.27.199 \
  'cd /opt/fiido-ai-service && git pull origin main && systemctl restart fiido-ai-backend'
```

### 2.3 仅部署前端

```bash
sshpass -p 'Tr&gbt85A>9a@HhuO|g,tov%fN6#Z' ssh root@8.211.27.199 \
  'cd /opt/fiido-ai-service/frontend && npm run build && rm -rf /var/www/fiido-frontend/* && cp -r dist/* /var/www/fiido-frontend/'
```

### 2.4 清除缓存

```bash
# 清除订单搜索缓存
redis-cli KEYS "shopify:*:orders:search:*" | xargs -r redis-cli DEL

# 清除所有 Shopify 缓存
redis-cli KEYS "shopify:*" | xargs -r redis-cli DEL

# 清除单个订单缓存
redis-cli DEL 'shopify:uk:orders:search:UK22081'
```

### 2.5 日志查看

```bash
# 后端服务日志（实时）
journalctl -u fiido-ai-backend -f

# 后端服务日志（最近100行）
journalctl -u fiido-ai-backend -n 100

# Nginx 访问日志
tail -f /var/log/nginx/access.log

# Nginx 错误日志
tail -f /var/log/nginx/error.log
```

### 2.6 服务管理

```bash
# 启动服务
systemctl start fiido-ai-backend

# 停止服务
systemctl stop fiido-ai-backend

# 重启服务
systemctl restart fiido-ai-backend

# 查看服务状态
systemctl status fiido-ai-backend

# 查看服务配置
cat /etc/systemd/system/fiido-ai-backend.service
```

---

## 三、Coze API 调用规范

### 3.1 SSE 流式响应（必须）

```python
# ✅ 正确 - 使用 stream() 方法
with http_client.stream('POST', url, json=payload, headers=headers) as response:
    for line in response.iter_lines():
        if line.startswith('data:'):
            data_content = line[5:].strip()
            event_data = json.loads(data_content)
            if event_data.get("type") == "answer":
                content = event_data["content"]

# ❌ 错误 - Coze 返回的是 SSE 流，不是 JSON！
response = http_client.post(...)
data = response.json()
```

### 3.2 必需的请求参数

```python
payload = {
    "workflow_id": WORKFLOW_ID,      # 必需
    "app_id": APP_ID,                # 必需
    "session_name": session_id,      # 必需 - 会话隔离核心
    "additional_messages": [...],    # 必需
    "conversation_id": conv_id,      # 可选（多轮对话需要）
}
```

### 3.3 从顶层提取字段

```python
# ✅ 正确
event_data = json.loads(data_content)
if event_data.get("type") == "answer":
    content = event_data["content"]

# ❌ 错误 - Coze 不返回嵌套结构
content = event_data["message"]["content"]
```

### 3.4 OAuth Token 管理

```python
# ✅ 正确 - 使用 token_manager，包含 session_name
access_token = token_manager.get_access_token(
    session_name=session_id  # 必须包含 session_name 实现隔离
)

# ❌ 错误 - 硬编码 Token
access_token = "hardcoded_token"

# ❌ 错误 - 缺少 session_name
access_token = token_manager.get_access_token()
```

### 3.5 会话隔离机制

```python
@app.post("/api/chat")
async def chat(request: ChatRequest):
    session_id = request.user_id or generate_user_id()
    access_token = token_manager.get_access_token(session_name=session_id)
    conversation_id = conversation_cache.get(session_id)

    payload = {
        "workflow_id": WORKFLOW_ID,
        "app_id": APP_ID,
        "session_name": session_id,  # ← 关键！会话隔离核心
        "parameters": {"USER_INPUT": request.message}
    }

    if conversation_id:
        payload["conversation_id"] = conversation_id

    # ... 调用 Coze API ...

    # 保存 Coze 返回的 conversation_id
    if not conversation_id and returned_conversation_id:
        conversation_cache[session_id] = returned_conversation_id
```

**关键约束**:
- ❌ 禁止手动生成 conversation_id
- ✅ 首次对话不传 conversation_id，由 Coze 自动生成
- ✅ 后续对话传入相同的 conversation_id 维持上下文

---

## 四、开发流程详细规范

### 4.1 增量开发粒度标准

**后端开发**：

| 增量类型 | 最大修改范围 | 说明 |
|---------|-------------|------|
| 单个 API 端点 | 1 个文件，< 100 行 | 立即提交 |
| 数据模型变更 | 1-2 个文件 | 立即提交 |
| 业务逻辑模块 | 1 个模块文件 | 立即提交 |
| Bug 修复 | 最小改动 | 立即提交 |

**前端开发**：

| 增量类型 | 最大修改范围 | 说明 |
|---------|-------------|------|
| 单个组件 | 1 个 .vue 文件 | 自测后提交 |
| 样式调整 | 1 个组件的 CSS | 立即提交 |
| 交互逻辑 | 1 个 composable | 立即提交 |

### 4.2 测试脚本模板

```bash
#!/bin/bash
BASE_URL="http://localhost:8000"
PASSED=0
FAILED=0

echo "测试1: 创建资源 - 正常场景"
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$BASE_URL/api/resource" \
  -H "Content-Type: application/json" \
  -d '{"name": "test"}')

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
if [ "$HTTP_CODE" -eq 200 ]; then
    echo "✅ PASS"
    ((PASSED++))
else
    echo "❌ FAIL - 预期200，实际$HTTP_CODE"
    ((FAILED++))
fi

echo "========================================"
echo "通过: $PASSED / 失败: $FAILED"
[ $FAILED -eq 0 ] && exit 0 || exit 1
```

### 4.3 前端自测流程

```bash
# 1. TypeScript 类型检查
cd frontend && npx vue-tsc --noEmit

# 2. 启动前端服务
npm run dev

# 3. 检查浏览器控制台无错误
# 4. 测试核心功能可用
```

### 4.4 回归测试

```bash
cd /home/yzh/AI客服/鉴权
./tests/regression_test.sh
# 预期: 所有测试通过
```

---

## 五、坐席认证与权限约束

### 5.1 JWT 权限分级

| 权限级别 | 装饰器 | 适用 API |
|---------|-------|---------|
| 无需认证 | 无 | `/api/chat`, `/api/manual/escalate` |
| 普通坐席 | `require_agent()` | 修改密码、修改资料、会话查询 |
| 管理员 | `require_admin()` | 坐席 CRUD、密码重置、权限管理 |

### 5.2 字段级访问控制

**坐席允许修改**：`name`, `avatar_url`

**坐席禁止修改**：`role`, `username`, `max_sessions`, `status`, `created_at`, `last_login`, `password_hash`

### 5.3 密码修改三重验证

```python
@app.post("/api/agent/change-password")
async def change_password(request: ChangePasswordRequest):
    # 验证1: 旧密码正确性
    # 验证2: 新密码强度（至少8字符，包含字母和数字）
    # 验证3: 新旧密码不能相同
```

---

## 六、生产环境性能要求

### 6.1 并发性配置

| 配置项 | 建议值 |
|-------|-------|
| Redis 连接池 | 50 连接 |
| HTTP 客户端连接池 | 100 连接 |
| 每用户 SSE 连接数 | 最多 3 个 |
| 消息队列长度 | 100 |

### 6.2 超时配置

```python
HTTP_TIMEOUT = httpx.Timeout(
    connect=5.0,   # 连接超时 5秒
    read=30.0,     # 读取超时 30秒
    write=10.0,    # 写入超时 10秒
    pool=10.0      # 连接池超时 10秒
)
```

### 6.3 性能指标

| 指标 | 目标值 |
|-----|-------|
| API 响应 P50 | < 200ms |
| API 响应 P99 | < 1s |
| 人工消息推送延迟 | < 100ms |
| AI 响应首字延迟 | < 50ms |

### 6.4 Redis 内存配置

```
maxmemory 512mb
maxmemory-policy allkeys-lru
```

---

## 七、环境变量说明

| 变量名 | 说明 | 示例 |
|-------|------|------|
| `COZE_WORKFLOW_ID` | Coze 工作流 ID | `7xxx...` |
| `COZE_APP_ID` | Coze 应用 ID | `7xxx...` |
| `COZE_OAUTH_CLIENT_ID` | OAuth 客户端 ID | `xxx...` |
| `COZE_OAUTH_CLIENT_SECRET` | OAuth 客户端密钥 | `xxx...` |
| `JWT_SECRET_KEY` | JWT 签名密钥 | 随机字符串 |
| `REGULATOR_KEYWORDS` | 人工接管触发关键词 | `人工,客服,转人工` |
| `REGULATOR_FAIL_THRESHOLD` | AI 连续失败阈值 | `3` |

---

## 八、常见问题排查

### 8.1 后端服务无法启动

```bash
# 检查端口占用
lsof -i :8000

# 检查服务日志
journalctl -u fiido-ai-backend -n 50

# 检查 Python 依赖
cd /opt/fiido-ai-service && source venv/bin/activate && pip list
```

### 8.2 前端页面空白

```bash
# 检查构建是否成功
ls -la /var/www/fiido-frontend/

# 检查 Nginx 配置
nginx -t

# 重载 Nginx
systemctl reload nginx
```

### 8.3 订单查询返回旧数据

```bash
# 清除订单缓存
redis-cli KEYS "shopify:*:orders:search:*" | xargs -r redis-cli DEL
```

### 8.4 Coze API 调用失败

```bash
# 检查 Token 是否有效
curl -H "Authorization: Bearer $ACCESS_TOKEN" https://api.coze.cn/v1/workflow/run

# 检查环境变量
cat /opt/fiido-ai-service/.env | grep COZE
```

---

## 九、文档索引

| 文档 | 路径 | 说明 |
|-----|------|------|
| 主开发指令 | `CLAUDE.md` | 核心开发规范 |
| 本参考手册 | `docs/开发参考手册.md` | 详细参考信息 |
| 商品状态逻辑 | `docs/商品状态判断逻辑.md` | 订单状态判断规则 |
| 核心约束 | `prd/02_约束与原则/CONSTRAINTS_AND_PRINCIPLES.md` | 技术约束 |
| 技术方案 | `prd/03_技术方案/TECHNICAL_SOLUTION_v1.0.md` | 架构设计 |
| API 契约 | `prd/03_技术方案/api_contract.md` | 接口文档 |
| Coze 规范 | `prd/02_约束与原则/coze.md` | Coze API 约束 |
