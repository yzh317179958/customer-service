# ä¼ä¸šçº§éƒ¨ç½²å·®è·åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2025-11-24
**å½“å‰ç‰ˆæœ¬**: v2.3.3
**ç³»ç»ŸçŠ¶æ€**: åŠŸèƒ½å®Œæˆåº¦ 94%ï¼Œç”Ÿäº§å°±ç»ªåº¦ 40%

---

## ğŸ“Š æ ¸å¿ƒé—®é¢˜æ€»ç»“

### æ‚¨çš„ç³»ç»Ÿç°åœ¨èƒ½åšä»€ä¹ˆï¼Ÿâœ…

1. **åŠŸèƒ½å±‚é¢** (94% å®Œæˆ)
   - âœ… AI æ™ºèƒ½å¯¹è¯
   - âœ… å¤šè½®å¯¹è¯å’Œä¸Šä¸‹æ–‡ç†è§£
   - âœ… ä¼šè¯éš”ç¦»ï¼ˆæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ï¼‰
   - âœ… äººå·¥æ¥ç®¡æµç¨‹ï¼ˆå‡çº§/æ¥å…¥/è½¬æ¥/é‡Šæ”¾ï¼‰
   - âœ… åå¸­å·¥ä½œå°ï¼ˆä¼šè¯åˆ—è¡¨ã€èŠå¤©ã€ç»Ÿè®¡ï¼‰
   - âœ… å®æ—¶æ¶ˆæ¯æ¨é€ï¼ˆSSEï¼‰
   - âœ… ç›‘ç®¡ç­–ç•¥ï¼ˆå…³é”®è¯è§¦å‘ï¼‰
   - âœ… å·¥ä½œæ—¶é—´åˆ¤æ–­
   - âœ… é‚®ä»¶é€šçŸ¥

2. **æŠ€æœ¯å±‚é¢** (åŸºç¡€å®Œæˆ)
   - âœ… OAuth + JWT é‰´æƒï¼ˆä¸ Coze APIï¼‰
   - âœ… FastAPI åç«¯æ¶æ„
   - âœ… Vue 3 å‰ç«¯ï¼ˆç”¨æˆ·ç«¯ + åå¸­ç«¯ï¼‰
   - âœ… TypeScript ç±»å‹å®‰å…¨
   - âœ… Pinia çŠ¶æ€ç®¡ç†

### æ‚¨çš„ç³»ç»Ÿç°åœ¨ä¸èƒ½åšä»€ä¹ˆï¼ŸâŒ

**ä¸¥é‡é—®é¢˜**ï¼š
1. âŒ **æ•°æ®ä¸æŒä¹…** - æœåŠ¡å™¨é‡å¯åæ‰€æœ‰ä¼šè¯ä¸¢å¤±
2. âŒ **æ— å®‰å…¨è®¤è¯** - åå¸­ç«¯ä»»ä½•äººéƒ½èƒ½ç™»å½•
3. âŒ **ä¸æ”¯æŒ HTTPS** - æ— æ³•éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
4. âŒ **æ— æ³•åµŒå…¥ç‹¬ç«‹ç«™** - åªèƒ½ä½œä¸ºç‹¬ç«‹é¡µé¢è®¿é—®
5. âŒ **æ— ç›‘æ§å‘Šè­¦** - å‡ºé—®é¢˜ä¸çŸ¥é“
6. âŒ **æ— æ—¥å¿—ç³»ç»Ÿ** - æ— æ³•è¿½æº¯é—®é¢˜

---

## ğŸ”´ P0 çº§åˆ« - å¿…é¡»ç«‹å³è§£å†³ï¼ˆå¦åˆ™æ— æ³•ä¸Šçº¿ï¼‰

### 1. æ•°æ®æŒä¹…åŒ– (Redis)

**å½“å‰çŠ¶æ€**ï¼š
```python
# backend.py - æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å†…å­˜å­—å…¸ä¸­
sessions: Dict[str, SessionState] = {}  # âŒ é‡å¯ä¸¢å¤±
```

**ç”Ÿäº§é£é™©**ï¼š
- ğŸ”´ **è‡´å‘½** - æœåŠ¡é‡å¯åæ‰€æœ‰ç”¨æˆ·ä¼šè¯ä¸¢å¤±
- ğŸ”´ **è‡´å‘½** - æ— æ³•æ°´å¹³æ‰©å±•ï¼ˆå¤šå°æœåŠ¡å™¨ï¼‰
- ğŸ”´ **è‡´å‘½** - æ— æ³•ç»Ÿè®¡å†å²æ•°æ®

**å¿…é¡»åš**ï¼š
```python
# 1. å®‰è£… Redis
pip install redis

# 2. åˆ›å»º Redis å­˜å‚¨å±‚
# src/redis_store.py
import redis
import json

class RedisSessionStore:
    def __init__(self, redis_url: str):
        self.redis = redis.from_url(redis_url)

    def save_session(self, session_name: str, session: SessionState):
        """ä¿å­˜ä¼šè¯åˆ° Redisï¼Œ24å°æ—¶è¿‡æœŸ"""
        key = f"session:{session_name}"
        self.redis.setex(key, 86400, session.json())

    def get_session(self, session_name: str) -> SessionState:
        """ä» Redis è¯»å–ä¼šè¯"""
        data = self.redis.get(f"session:{session_name}")
        return SessionState.parse_raw(data) if data else None

# 3. æ›¿æ¢æ‰€æœ‰å†…å­˜æ“ä½œ
# backend.py
redis_store = RedisSessionStore(os.getenv("REDIS_URL"))

# åŸæ¥ï¼šsessions[session_name] = session
# æ”¹ä¸ºï¼šredis_store.save_session(session_name, session)
```

**å·¥ä½œé‡**: 2-3 å¤©
**ä¼˜å…ˆçº§**: ğŸ”´ P0 - æœ€é«˜ä¼˜å…ˆçº§

---

### 2. åå¸­è®¤è¯ç³»ç»Ÿ

**å½“å‰çŠ¶æ€**ï¼š
```typescript
// agent-workbench - ä»»ä½•äººéƒ½èƒ½è¾“å…¥ä»»æ„IDç™»å½•
const handleLogin = async () => {
  await agentStore.login({
    agentId: agentId.value,  // âŒ æ— éªŒè¯
    agentName: agentName.value
  })
}
```

**ç”Ÿäº§é£é™©**ï¼š
- ğŸ”´ **è‡´å‘½** - ä»»ä½•äººéƒ½èƒ½è¿›å…¥åå¸­å·¥ä½œå°
- ğŸ”´ **è‡´å‘½** - æ— æ³•è¿½æº¯åå¸­æ“ä½œ
- ğŸ”´ **è‡´å‘½** - æ— æƒé™æ§åˆ¶

**å¿…é¡»åš**ï¼š
```python
# 1. åˆ›å»ºåå¸­æ•°æ®åº“è¡¨
# src/models.py
from sqlalchemy import Column, String, Integer, Float
from werkzeug.security import generate_password_hash, check_password_hash

class Agent(Base):
    __tablename__ = 'agents'

    id = Column(String, primary_key=True)
    username = Column(String, unique=True, nullable=False)
    password_hash = Column(String, nullable=False)
    name = Column(String, nullable=False)
    role = Column(String, default='agent')  # agent / admin
    max_sessions = Column(Integer, default=5)
    created_at = Column(Float)

# 2. å®ç°ç™»å½• API
@app.post("/api/agent/login")
async def agent_login(request: dict):
    username = request["username"]
    password = request["password"]

    # æŸ¥è¯¢æ•°æ®åº“
    agent = db.query(Agent).filter(Agent.username == username).first()

    # éªŒè¯å¯†ç 
    if not agent or not check_password_hash(agent.password_hash, password):
        raise HTTPException(401, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")

    # ç”Ÿæˆ JWT Token
    token = create_jwt_token(agent.id, agent.role)

    return {
        "success": True,
        "token": token,
        "agent": {
            "id": agent.id,
            "name": agent.name,
            "role": agent.role
        }
    }

# 3. å‰ç«¯å­˜å‚¨ Token å¹¶åœ¨è¯·æ±‚ä¸­æºå¸¦
// agent-workbench/src/api/request.ts
axios.interceptors.request.use(config => {
  const token = localStorage.getItem('agent_token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})
```

**å·¥ä½œé‡**: 3-4 å¤©
**ä¼˜å…ˆçº§**: ğŸ”´ P0 - æœ€é«˜ä¼˜å…ˆçº§

---

### 3. HTTPS éƒ¨ç½²é…ç½®

**å½“å‰çŠ¶æ€**ï¼š
```
ç”¨æˆ·è®¿é—®: http://localhost:5173  âŒ æœ¬åœ°å¼€å‘æ¨¡å¼
åå¸­è®¿é—®: http://192.168.1.133:5174  âŒ å±€åŸŸç½‘IP
åç«¯API: http://localhost:8000  âŒ æ— åŠ å¯†
```

**ç”Ÿäº§é£é™©**ï¼š
- ğŸ”´ **è‡´å‘½** - ç”¨æˆ·æ•°æ®æ˜æ–‡ä¼ è¾“ï¼ˆä¸å®‰å…¨ï¼‰
- ğŸ”´ **è‡´å‘½** - æµè§ˆå™¨é˜»æ­¢é HTTPS ç«™ç‚¹è®¿é—®
- ğŸ”´ **è‡´å‘½** - Cookie/LocalStorage å®‰å…¨é—®é¢˜

**å¿…é¡»åš**ï¼š

#### æ­¥éª¤ 1: è´­ä¹°åŸŸåå’Œ SSL è¯ä¹¦
```bash
# ç¤ºä¾‹åŸŸå
kefu.yoursite.com  # å®¢æœç³»ç»Ÿä¸»åŸŸå
```

#### æ­¥éª¤ 2: å®‰è£… Nginx åå‘ä»£ç†
```bash
sudo apt install nginx certbot python3-certbot-nginx
```

#### æ­¥éª¤ 3: é…ç½® Nginx
```nginx
# /etc/nginx/sites-available/fiido-kefu
server {
    listen 80;
    server_name kefu.yoursite.com;

    # HTTP è‡ªåŠ¨è·³è½¬ HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name kefu.yoursite.com;

    # SSL è¯ä¹¦
    ssl_certificate /etc/letsencrypt/live/kefu.yoursite.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/kefu.yoursite.com/privkey.pem;

    # å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # åç«¯ APIï¼ˆæ”¯æŒ SSE é•¿è¿æ¥ï¼‰
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400;  # SSE éœ€è¦é•¿è¶…æ—¶
    }

    # ç”¨æˆ·ç«¯å‰ç«¯ï¼ˆç¼–è¯‘åçš„é™æ€æ–‡ä»¶ï¼‰
    location / {
        root /var/www/fiido-kefu/frontend/dist;
        try_files $uri $uri/ /index.html;

        # é™æ€èµ„æºç¼“å­˜
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # åå¸­å·¥ä½œå°
    location /agent {
        alias /var/www/fiido-kefu/agent-workbench/dist;
        try_files $uri $uri/ /agent/index.html;
    }
}
```

#### æ­¥éª¤ 4: ç”³è¯·å…è´¹ SSL è¯ä¹¦
```bash
sudo certbot --nginx -d kefu.yoursite.com
```

#### æ­¥éª¤ 5: æ„å»ºç”Ÿäº§ç‰ˆæœ¬
```bash
# ç”¨æˆ·ç«¯
cd frontend
npm run build  # ç”Ÿæˆ dist/

# åå¸­å·¥ä½œå°
cd agent-workbench
npm run build  # ç”Ÿæˆ dist/

# éƒ¨ç½²åˆ°æœåŠ¡å™¨
scp -r frontend/dist user@server:/var/www/fiido-kefu/frontend/
scp -r agent-workbench/dist user@server:/var/www/fiido-kefu/agent-workbench/
```

**å·¥ä½œé‡**: 1-2 å¤©ï¼ˆé¦–æ¬¡é…ç½®ï¼‰
**ä¼˜å…ˆçº§**: ğŸ”´ P0 - æœ€é«˜ä¼˜å…ˆçº§

---

### 4. å‰ç«¯åµŒå…¥æ–¹æ¡ˆï¼ˆç‹¬ç«‹ç«™é›†æˆï¼‰

**å½“å‰çŠ¶æ€**ï¼š
- âŒ åªèƒ½ä½œä¸ºç‹¬ç«‹é¡µé¢è®¿é—®ï¼ˆhttp://yoursite.com/chatï¼‰
- âŒ æ— æ³•åµŒå…¥åˆ°ç°æœ‰ç‹¬ç«‹ç«™é¡µé¢

**ç”Ÿäº§éœ€æ±‚**ï¼š
```html
<!-- ç‹¬ç«‹ç«™é¡µé¢å¸Œæœ›è¿™æ ·åµŒå…¥å®¢æœ -->
<script src="https://kefu.yoursite.com/sdk.js"></script>
<script>
  FiidoChat.init({
    apiUrl: 'https://kefu.yoursite.com/api',
    position: 'bottom-right',  // ä½ç½®
    theme: 'teal',  // ä¸»é¢˜è‰²
    autoOpen: false  // æ˜¯å¦è‡ªåŠ¨æ‰“å¼€
  });
</script>
```

**å¿…é¡»åš**ï¼š

#### æ–¹æ¡ˆ A: iframe åµŒå…¥ï¼ˆç®€å•ï¼Œæ¨èå…ˆåšï¼‰

```html
<!-- 1. åˆ›å»ºåµŒå…¥ä»£ç ç”Ÿæˆå™¨ -->
<!-- embed.html -->
<!DOCTYPE html>
<html>
<head>
  <style>
    /* æµ®åŠ¨æŒ‰é’® */
    #fiido-chat-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4ECDC4, #52C7B8);
      box-shadow: 0 4px 12px rgba(78, 205, 196, 0.4);
      cursor: pointer;
      z-index: 9999;
    }

    /* iframe å®¹å™¨ */
    #fiido-chat-iframe {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 400px;
      height: 600px;
      border: none;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 9998;
    }

    #fiido-chat-iframe.open {
      display: block;
    }
  </style>
</head>
<body>
  <!-- æµ®åŠ¨æŒ‰é’® -->
  <div id="fiido-chat-button" onclick="toggleChat()">
    <img src="/fiido2.png" style="width: 100%; height: 100%; object-fit: contain;">
  </div>

  <!-- iframe å®¹å™¨ -->
  <iframe
    id="fiido-chat-iframe"
    src="https://kefu.yoursite.com/"
    allow="microphone; camera"
  ></iframe>

  <script>
    function toggleChat() {
      const iframe = document.getElementById('fiido-chat-iframe');
      iframe.classList.toggle('open');
    }
  </script>
</body>
</html>
```

**ç‹¬ç«‹ç«™åªéœ€æ·»åŠ ä¸€è¡Œä»£ç **ï¼š
```html
<!-- åœ¨ç‹¬ç«‹ç«™çš„ä»»æ„é¡µé¢æ·»åŠ  -->
<script src="https://kefu.yoursite.com/embed.js"></script>
```

#### æ–¹æ¡ˆ B: Web Componentsï¼ˆé«˜çº§ï¼Œå¯é€‰ï¼‰

```javascript
// sdk/fiido-chat.js
class FiidoChatWidget extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: 'open' });
  }

  connectedCallback() {
    const apiUrl = this.getAttribute('api-url') || 'https://kefu.yoursite.com/api';
    const position = this.getAttribute('position') || 'bottom-right';

    this.shadowRoot.innerHTML = `
      <style>
        /* æ ·å¼éš”ç¦» */
        :host {
          all: initial;
        }
        .chat-widget { /* ... */ }
      </style>
      <div class="chat-widget">
        <!-- èŠå¤©ç•Œé¢ -->
      </div>
    `;
  }
}

customElements.define('fiido-chat', FiidoChatWidget);
```

**ç‹¬ç«‹ç«™ä½¿ç”¨**ï¼š
```html
<fiido-chat
  api-url="https://kefu.yoursite.com/api"
  position="bottom-right"
  theme="teal">
</fiido-chat>
```

**å·¥ä½œé‡**:
- æ–¹æ¡ˆ A (iframe): 1-2 å¤©
- æ–¹æ¡ˆ B (Web Components): 3-5 å¤©

**ä¼˜å…ˆçº§**: ğŸ”´ P0 - æœ€é«˜ä¼˜å…ˆçº§

---

## ğŸŸ  P1 çº§åˆ« - å¼ºçƒˆå»ºè®®ï¼ˆæå‡ç¨³å®šæ€§ï¼‰

### 5. Docker å®¹å™¨åŒ–éƒ¨ç½² â­ **ç”Ÿäº§ç¯å¢ƒæ ‡é…**

**å½“å‰çŠ¶æ€**ï¼š
- âŒ ç›´æ¥è¿è¡Œ Python è„šæœ¬ï¼ˆ`python3 backend.py`ï¼‰
- âŒ æ‰‹åŠ¨å®‰è£…ä¾èµ–ï¼ˆ`pip3 install -r requirements.txt`ï¼‰
- âŒ æ— ç¯å¢ƒéš”ç¦»

**ç”Ÿäº§é£é™©**ï¼š
- ğŸŸ  **ä¸¥é‡** - ç¯å¢ƒä¾èµ–ä¸ä¸€è‡´ï¼ˆPythonç‰ˆæœ¬ã€ç³»ç»Ÿåº“ï¼‰
- ğŸŸ  **ä¸¥é‡** - éš¾ä»¥å¿«é€Ÿéƒ¨ç½²å’Œå›æ»š
- ğŸŸ  **ä¸¥é‡** - æ— æ³•ä¿è¯å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒä¸€è‡´æ€§

**å¿…é¡»åš**ï¼š

#### åˆ›å»º Dockerfile
```dockerfile
# Dockerfile
FROM python:3.10-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y gcc curl && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶å¹¶å®‰è£… Python ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶æºä»£ç 
COPY . .

EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8000/api/health || exit 1

CMD ["python3", "backend.py"]
```

#### åˆ›å»º docker-compose.yml
```yaml
version: '3.8'

services:
  backend:
    build: .
    container_name: fiido-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - COZE_API_BASE=${COZE_API_BASE}
      - COZE_WORKFLOW_ID=${COZE_WORKFLOW_ID}
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./private_key.pem:/app/private_key.pem:ro
      - ./logs:/app/logs
    depends_on:
      - redis
    networks:
      - fiido-network

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - fiido-network

volumes:
  redis-data:

networks:
  fiido-network:
    driver: bridge
```

#### éƒ¨ç½²å‘½ä»¤
```bash
# æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend

# åœæ­¢æœåŠ¡
docker-compose down
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç¯å¢ƒä¸€è‡´æ€§ä¿è¯
- âœ… ä¸€é”®éƒ¨ç½²å’Œå›æ»š
- âœ… èµ„æºéš”ç¦»å’Œé™åˆ¶
- âœ… æ˜“äºæ‰©å±•ï¼ˆå¤šå‰¯æœ¬ï¼‰

**å·¥ä½œé‡**: 1-2 å¤©
**ä¼˜å…ˆçº§**: ğŸŸ  P1

---

### 6. é‚®ä»¶é€šçŸ¥ç³»ç»Ÿ â­ **éå·¥ä½œæ—¶é—´å¿…éœ€**

**å½“å‰çŠ¶æ€**ï¼š
```python
# backend.py - éå·¥ä½œæ—¶é—´é€»è¾‘å­˜åœ¨ä½†é‚®ä»¶æœªå®ç°
if not shift_config.is_in_shift():
    session.transition_status(SessionStatus.AFTER_HOURS_EMAIL)
    # TODO: å‘é€é‚®ä»¶é€šçŸ¥ âŒ æœªå®ç°
```

**ç”Ÿäº§é£é™©**ï¼š
- ğŸŸ  **ä¸¥é‡** - éå·¥ä½œæ—¶é—´ç”¨æˆ·æ— æ³•å¾—åˆ°å“åº”
- ğŸŸ  **ä¸¥é‡** - ç´§æ€¥é—®é¢˜æ— æ³•åŠæ—¶å¤„ç†

**å¿…é¡»åš**ï¼š

#### æ­¥éª¤ 1: å®‰è£…é‚®ä»¶åº“
```bash
pip install aiosmtplib email-validator
```

#### æ­¥éª¤ 2: åˆ›å»ºé‚®ä»¶æœåŠ¡æ¨¡å—
```python
# src/email_service.py
import aiosmtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

class EmailService:
    def __init__(self):
        self.smtp_host = os.getenv("SMTP_HOST", "smtp.gmail.com")
        self.smtp_user = os.getenv("SMTP_USER")
        self.smtp_password = os.getenv("SMTP_PASSWORD")

    async def send_after_hours_notification(
        self, session_name: str, user_message: str
    ):
        """å‘é€éå·¥ä½œæ—¶é—´é€šçŸ¥é‚®ä»¶"""
        subject = f"[Fiidoå®¢æœ] éå·¥ä½œæ—¶é—´å’¨è¯¢ - {session_name}"

        body = f"""
        <h2>éå·¥ä½œæ—¶é—´ç”¨æˆ·å’¨è¯¢é€šçŸ¥</h2>
        <p><strong>ä¼šè¯ID:</strong> {session_name}</p>
        <p><strong>ç”¨æˆ·æ¶ˆæ¯:</strong> {user_message}</p>
        <p><strong>æ—¶é—´:</strong> {datetime.now()}</p>
        """

        message = MIMEMultipart()
        message["Subject"] = subject
        message["From"] = self.smtp_user
        message["To"] = os.getenv("NOTIFY_EMAIL")
        message.attach(MIMEText(body, "html"))

        await aiosmtplib.send(
            message,
            hostname=self.smtp_host,
            port=587,
            username=self.smtp_user,
            password=self.smtp_password,
            use_tls=True
        )
```

#### æ­¥éª¤ 3: é›†æˆåˆ°åç«¯
```python
# backend.py
email_service = EmailService()

@app.post("/api/manual/escalate")
async def escalate_to_manual(request: dict):
    if not shift_config.is_in_shift():
        # å‘é€é‚®ä»¶é€šçŸ¥
        await email_service.send_after_hours_notification(
            session_name=session_name,
            user_message=request.get("last_message", "")
        )
        session.escalation.mail_sent_at = time.time()
```

#### æ­¥éª¤ 4: ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env
SMTP_HOST=smtp.gmail.com
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
NOTIFY_EMAIL=support@fiido.com
```

**å·¥ä½œé‡**: 2-3 å¤©
**ä¼˜å…ˆçº§**: ğŸŸ  P1

---

### 7. æ—¥å¿—ç›‘æ§ç³»ç»Ÿ

**å½“å‰çŠ¶æ€**ï¼š
```python
# backend.py - æ‰€æœ‰æ—¥å¿—åªæ‰“å°åˆ°æ§åˆ¶å°
print(f"ä¼šè¯çŠ¶æ€å˜æ›´: {session_name}")  # âŒ æ— æ³•è¿½æº¯
```

**ç”Ÿäº§é£é™©**ï¼š
- ğŸŸ  **ä¸¥é‡** - å‡ºé—®é¢˜æ— æ³•å®šä½åŸå› 
- ğŸŸ  **ä¸¥é‡** - æ— æ³•ç»Ÿè®¡ç³»ç»Ÿè¿è¡Œæƒ…å†µ

**å»ºè®®åš**ï¼š

#### æ–¹æ¡ˆ 1: ç»“æ„åŒ–æ—¥å¿—ï¼ˆæœ€ä½è¦æ±‚ï¼‰
```python
# å®‰è£…
pip install python-json-logger

# src/logger.py
import logging
from pythonjsonlogger import jsonlogger

def setup_logger():
    logger = logging.getLogger("fiido_kefu")
    handler = logging.FileHandler("/var/log/fiido-kefu/app.log")
    formatter = jsonlogger.JsonFormatter(
        '%(asctime)s %(name)s %(levelname)s %(message)s'
    )
    handler.setFormatter(formatter)
    logger.addHandler(handler)
    logger.setLevel(logging.INFO)
    return logger

# ä½¿ç”¨
logger = setup_logger()
logger.info("ä¼šè¯çŠ¶æ€å˜æ›´", extra={
    "session_name": session_name,
    "old_status": "bot_active",
    "new_status": "pending_manual",
    "agent_id": agent_id
})
```

#### æ–¹æ¡ˆ 2: é›†æˆç›‘æ§å¹³å°ï¼ˆæ¨èï¼‰
```python
# ä½¿ç”¨ Sentry é”™è¯¯è¿½è¸ª
pip install sentry-sdk

# backend.py
import sentry_sdk
sentry_sdk.init(
    dsn="your-sentry-dsn",
    traces_sample_rate=1.0,
    environment="production"
)

# è‡ªåŠ¨æ•è·æ‰€æœ‰é”™è¯¯
```

**å·¥ä½œé‡**: 2-3 å¤©
**ä¼˜å…ˆçº§**: ğŸŸ  P1

---

### 6. é”™è¯¯å¤„ç†ä¼˜åŒ–

**å½“å‰çŠ¶æ€**ï¼š
```python
# backend.py - åŸºç¡€é”™è¯¯å¤„ç†
try:
    result = some_function()
except Exception as e:
    print(f"é”™è¯¯: {e}")  # âŒ ç”¨æˆ·çœ‹ä¸åˆ°
```

**å»ºè®®åš**ï¼š
```python
# 1. ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
class APIError(Exception):
    def __init__(self, code: str, message: str, status_code: int = 500):
        self.code = code
        self.message = message
        self.status_code = status_code

# 2. å…¨å±€é”™è¯¯å¤„ç†å™¨
@app.exception_handler(APIError)
async def api_error_handler(request: Request, exc: APIError):
    logger.error(f"APIé”™è¯¯: {exc.code}", extra={
        "code": exc.code,
        "message": exc.message,
        "path": request.url.path
    })
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "success": False,
            "error": {
                "code": exc.code,
                "message": exc.message
            }
        }
    )

# 3. å‰ç«¯ç»Ÿä¸€é”™è¯¯æç¤º
// frontend/src/api/request.ts
axios.interceptors.response.use(
  response => response,
  error => {
    const msg = error.response?.data?.error?.message || 'ç³»ç»Ÿé”™è¯¯'
    ElMessage.error(msg)  // ä½¿ç”¨ Element Plus æç¤º
    return Promise.reject(error)
  }
)
```

**å·¥ä½œé‡**: 1-2 å¤©
**ä¼˜å…ˆçº§**: ğŸŸ  P1

---

## ğŸŸ¡ P2 çº§åˆ« - ä¼˜åŒ–é¡¹ï¼ˆæå‡ä½“éªŒï¼‰

### 7. æ€§èƒ½ä¼˜åŒ–

**å½“å‰é—®é¢˜**ï¼š
- æ¯ 2 ç§’è½®è¯¢ä¼šè¯çŠ¶æ€ï¼ˆå¯èƒ½é€ æˆæœåŠ¡å™¨å‹åŠ›ï¼‰
- æ²¡æœ‰æ¥å£é™æµ
- æ²¡æœ‰ç¼“å­˜æœºåˆ¶

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```python
# 1. API é™æµ
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/api/chat")
@limiter.limit("10/minute")  # æ¯åˆ†é’Ÿæœ€å¤š 10 æ¬¡
async def chat(request: Request):
    pass

# 2. ç¼“å­˜ Bot ä¿¡æ¯
from functools import lru_cache

@lru_cache(maxsize=1)
def get_bot_info():
    # ç¼“å­˜ç»“æœï¼Œé¿å…é‡å¤æŸ¥è¯¢
    return fetch_from_coze()

# 3. WebSocket æ›¿ä»£è½®è¯¢ï¼ˆå¯é€‰ï¼‰
@app.websocket("/ws/session/{session_name}")
async def websocket_session(websocket: WebSocket, session_name: str):
    await websocket.accept()
    # æ¨é€ä¼šè¯æ›´æ–°ï¼Œæ›¿ä»£å‰ç«¯è½®è¯¢
```

**å·¥ä½œé‡**: 3-5 å¤©
**ä¼˜å…ˆçº§**: ğŸŸ¡ P2

---

### 8. å®‰å…¨åŠ å›º â­ **ç”Ÿäº§ç¯å¢ƒå¿…éœ€**

**å½“å‰é—®é¢˜**ï¼š
- æ—  CORS ç™½åå•é™åˆ¶ï¼ˆä»»ä½•åŸŸåéƒ½èƒ½è®¿é—®ï¼‰
- æ— è¯·æ±‚é€Ÿç‡é™åˆ¶ï¼ˆå®¹æ˜“è¢«DDoSï¼‰
- æ— è¾“å…¥å†…å®¹éªŒè¯ï¼ˆXSSé£é™©ï¼‰
- æ•æ„Ÿä¿¡æ¯æœªè„±æ•

**å®‰å…¨é£é™©**ï¼š
- ğŸŸ¡ **ä¸­ç­‰** - è·¨åŸŸæ”»å‡»é£é™©
- ğŸŸ¡ **ä¸­ç­‰** - API æ»¥ç”¨å’ŒDDoS
- ğŸŸ¡ **ä¸­ç­‰** - XSS æ³¨å…¥
- ğŸŸ¡ **ä¸­ç­‰** - æ•æ„Ÿæ•°æ®æ³„éœ²

**å¿…é¡»åš**ï¼š

#### 1. CORS ç™½åå•é…ç½®

```python
# backend.py
from fastapi.middleware.cors import CORSMiddleware

# âœ… æ­£ç¡® - ç™½åå•é™åˆ¶
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://kefu.yoursite.com",    # ç”Ÿäº§åŸŸå
        "https://www.yoursite.com",      # ä¸»ç«™
        "http://localhost:5173",         # æœ¬åœ°å¼€å‘
        "http://localhost:5174"          # åå¸­å·¥ä½œå°
    ],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)

# âŒ é”™è¯¯ - å…è®¸æ‰€æœ‰åŸŸåï¼ˆå½“å‰é…ç½®ï¼‰
# allow_origins=["*"]
```

#### 2. API é€Ÿç‡é™åˆ¶

```python
# å®‰è£…
pip install slowapi

# backend.py
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# åº”ç”¨é™æµ
@app.post("/api/chat")
@limiter.limit("20/minute")  # æ¯åˆ†é’Ÿæœ€å¤š20æ¬¡å¯¹è¯
async def chat(request: Request, chat_request: ChatRequest):
    pass

@app.post("/api/manual/escalate")
@limiter.limit("5/minute")   # æ¯åˆ†é’Ÿæœ€å¤š5æ¬¡è½¬äººå·¥
async def escalate(request: Request, escalate_request: dict):
    pass
```

#### 3. è¾“å…¥éªŒè¯å’Œæ¸…ç†

```python
from pydantic import BaseModel, validator, Field
import bleach

class ChatRequest(BaseModel):
    message: str = Field(..., max_length=5000)  # é™åˆ¶é•¿åº¦
    user_id: Optional[str] = None
    conversation_id: Optional[str] = None

    @validator('message')
    def sanitize_message(cls, v):
        """æ¸…ç† HTML æ ‡ç­¾ï¼Œé˜²æ­¢ XSS"""
        return bleach.clean(v, tags=[], strip=True)

    @validator('user_id', 'conversation_id')
    def validate_ids(cls, v):
        """éªŒè¯ ID æ ¼å¼"""
        if v and not re.match(r'^[a-zA-Z0-9_-]+$', v):
            raise ValueError("Invalid ID format")
        return v
```

#### 4. æ•æ„Ÿä¿¡æ¯è„±æ•

```python
import logging
import re

class SensitiveFilter(logging.Filter):
    """æ—¥å¿—æ•æ„Ÿä¿¡æ¯è¿‡æ»¤å™¨"""

    PATTERNS = [
        (r'Bearer\s+([a-zA-Z0-9_-]+)', 'Bearer ***'),  # JWT Token
        (r'"password"\s*:\s*"([^"]+)"', '"password": "***"'),  # å¯†ç 
        (r'\d{11}', '***'),  # æ‰‹æœºå·
        (r'\d{15,19}', '***'),  # é“¶è¡Œå¡å·
    ]

    def filter(self, record):
        message = record.getMessage()
        for pattern, replacement in self.PATTERNS:
            message = re.sub(pattern, replacement, message)
        record.msg = message
        return True

# åº”ç”¨è¿‡æ»¤å™¨
logger = logging.getLogger("backend")
logger.addFilter(SensitiveFilter())
```

#### 5. HTTPS å¼ºåˆ¶é‡å®šå‘

```nginx
# Nginx é…ç½®
server {
    listen 80;
    server_name kefu.yoursite.com;

    # HTTP è‡ªåŠ¨è·³è½¬ HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name kefu.yoursite.com;

    # å®‰å…¨å¤´éƒ¨
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ... å…¶ä»–é…ç½®
}
```

**å·¥ä½œé‡**: 2-3 å¤©
**ä¼˜å…ˆçº§**: ğŸŸ¡ P2 ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»å®Œæˆï¼‰

---

## ğŸ“‹ éƒ¨ç½²æ—¶é—´çº¿å»ºè®®

### ç¬¬ 1 å‘¨ï¼šP0 å¿…é¡»é¡¹ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
```
Day 1-2: Redis æ•°æ®æŒä¹…åŒ–
Day 3-4: åå¸­è®¤è¯ç³»ç»Ÿ
Day 5-6: HTTPS é…ç½® + Nginx éƒ¨ç½²
Day 7: iframe åµŒå…¥æ–¹æ¡ˆ
```

### ç¬¬ 2 å‘¨ï¼šP1 å¼ºçƒˆå»ºè®®ï¼ˆç¨³å®šæ€§ï¼‰
```
Day 1-2: Docker å®¹å™¨åŒ–éƒ¨ç½²
Day 3-4: é‚®ä»¶é€šçŸ¥ç³»ç»Ÿ
Day 5-6: æ—¥å¿—ç›‘æ§ç³»ç»Ÿ + é”™è¯¯å¤„ç†ä¼˜åŒ–
Day 7: å…¨é¢æµ‹è¯•å’Œä¸Šçº¿å‡†å¤‡
```

### ç¬¬ 3 å‘¨ï¼šP2 ä¼˜åŒ–é¡¹ï¼ˆå®‰å…¨å’Œæ€§èƒ½ï¼‰
```
Day 1-2: å®‰å…¨åŠ å›ºï¼ˆCORSã€é™æµã€è¾“å…¥éªŒè¯ï¼‰
Day 3-4: æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ã€WebSocketï¼‰
Day 5-6: ç›‘æ§å‘Šè­¦å’Œæ•°æ®ç»Ÿè®¡
Day 7: æ–‡æ¡£å®Œå–„å’ŒåŸ¹è®­
```

---

## ğŸ’° æˆæœ¬é¢„ä¼°

### åŸºç¡€è®¾æ–½æˆæœ¬ï¼ˆæœˆï¼‰
```
- äº‘æœåŠ¡å™¨ (2æ ¸4G): Â¥100-200/æœˆ
- Redis äº‘æœåŠ¡: Â¥50-100/æœˆ
- åŸŸå: Â¥50-100/å¹´
- SSL è¯ä¹¦: Â¥0 (Let's Encrypt å…è´¹)
- ç›‘æ§æœåŠ¡: Â¥0-200/æœˆ (å¯é€‰)

æ€»è®¡: Â¥200-500/æœˆ
```

### å¼€å‘æˆæœ¬ï¼ˆäººå¤©ï¼‰
```
- P0 å¿…é¡»é¡¹: 7-10 å¤©
- P1 å»ºè®®é¡¹: 7-9 å¤© (å« Docker + é‚®ä»¶)
- P2 ä¼˜åŒ–é¡¹: 5-7 å¤© (å«å®‰å…¨åŠ å›º)

æ€»è®¡: 19-26 å¤© (çº¦ 3-4 å‘¨)
```

---

## âœ… æœ€å°å¯è¡Œéƒ¨ç½²æ¸…å•

**å¦‚æœæ—¶é—´ç´§æ€¥ï¼Œæœ€ä½é™åº¦éœ€è¦å®Œæˆ**ï¼š

1. âœ… **Redis æŒä¹…åŒ–** (2-3å¤©)
   - ä¼šè¯æ•°æ®ä¸ä¸¢å¤±
   - æ”¯æŒæœåŠ¡é‡å¯

2. âœ… **åŸºç¡€è®¤è¯** (2å¤©)
   - åå¸­å¯†ç ç™»å½•
   - JWT Token éªŒè¯

3. âœ… **HTTPS éƒ¨ç½²** (1-2å¤©)
   - Nginx åå‘ä»£ç†
   - SSL è¯ä¹¦

4. âœ… **iframe åµŒå…¥** (1å¤©)
   - ç”ŸæˆåµŒå…¥ä»£ç 
   - æµ‹è¯•è·¨åŸŸ

5. âœ… **Docker å®¹å™¨åŒ–** (1å¤©) â­ æ–°å¢
   - ç¯å¢ƒä¸€è‡´æ€§ä¿è¯
   - å¿«é€Ÿéƒ¨ç½²

6. âœ… **åŸºç¡€å®‰å…¨åŠ å›º** (1å¤©) â­ æ–°å¢
   - CORS ç™½åå•
   - API é€Ÿç‡é™åˆ¶

**æ€»è®¡**: 8-10 å¤©ï¼Œå¯ä»¥ä¸Šçº¿ä½¿ç”¨ï¼ˆå«åŸºç¡€å®‰å…¨ä¿éšœï¼‰

---

## ğŸ¯ æ€»ç»“ï¼šæ‚¨ç°åœ¨çš„å·®è·

| ç»´åº¦ | å®Œæˆåº¦ | ç¼ºå¤±å†…å®¹ |
|------|--------|---------|
| **åŠŸèƒ½** | 94% | æ»¡æ„åº¦è¯„ä»· |
| **å®‰å…¨** | 30% | åå¸­è®¤è¯ã€HTTPSã€æ•°æ®åŠ å¯† |
| **ç¨³å®šæ€§** | 40% | æ•°æ®æŒä¹…åŒ–ã€é”™è¯¯å¤„ç†ã€æ—¥å¿— |
| **å¯éƒ¨ç½²æ€§** | 20% | ç”Ÿäº§é…ç½®ã€åµŒå…¥æ–¹æ¡ˆã€ç›‘æ§ |
| **ç»¼åˆè¯„ä¼°** | **40%** | éœ€è¦ 2-3 å‘¨è¾¾åˆ°ç”Ÿäº§æ ‡å‡† |

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. ğŸ”´ **æ•°æ®ä¼šä¸¢å¤±** - Redis æŒä¹…åŒ–æ˜¯ç¬¬ä¸€ä¼˜å…ˆçº§
2. ğŸ”´ **æ— æ³•å®‰å…¨éƒ¨ç½²** - HTTPS + è®¤è¯å¿…é¡»åš
3. ğŸ”´ **æ— æ³•åµŒå…¥ç‹¬ç«‹ç«™** - iframe æ–¹æ¡ˆå¿…é¡»åš
4. ğŸŸ  **å‡ºé—®é¢˜ä¸çŸ¥é“** - æ—¥å¿—ç›‘æ§å¼ºçƒˆå»ºè®®åš
5. ğŸŸ  **ç¯å¢ƒä¸ä¸€è‡´** - Docker å®¹å™¨åŒ–ä¿è¯ç¯å¢ƒç¨³å®š â­ æ–°å¢
6. ğŸŸ  **éå·¥ä½œæ—¶é—´æ— å“åº”** - é‚®ä»¶é€šçŸ¥ç³»ç»Ÿå¿…éœ€ â­ æ–°å¢
7. ğŸŸ¡ **å®‰å…¨é˜²æŠ¤ä¸è¶³** - CORSã€é™æµã€è¾“å…¥éªŒè¯ â­ æ–°å¢

**å»ºè®®è¡ŒåŠ¨**ï¼š
- **ç«‹å³å¼€å§‹**: Redis æŒä¹…åŒ–ï¼ˆæœ€ç´§æ€¥ï¼‰
- **åŒæ­¥è¿›è¡Œ**: HTTPS é…ç½® + Docker å®¹å™¨åŒ–
- **éšåå®Œæˆ**: åå¸­è®¤è¯ + iframe åµŒå…¥ + é‚®ä»¶é€šçŸ¥
- **é€æ­¥ä¼˜åŒ–**: å®‰å…¨åŠ å›º + æ—¥å¿—ç›‘æ§ + æ€§èƒ½ä¼˜åŒ–

---

**æ–‡æ¡£ç»´æŠ¤**: Claude Code
**æœ€åæ›´æ–°**: 2025-11-24
