# å¯¹è¯å†å²åŠŸèƒ½è¯Šæ–­æŠ¥å‘Š

> é—®é¢˜ï¼šåå¸­å·¥ä½œå°å³ä¾§å¯¹è¯å†å²æ¡†æ˜¾ç¤ºä¸ºç©º
> è¯Šæ–­æ—¶é—´ï¼š2025-11-27
> ç‰ˆæœ¬ï¼šv3.7.0

---

## ğŸ“Š å½“å‰å®ç°æƒ…å†µ

### âœ… åŠŸèƒ½å·²å®ç°

#### 1. åç«¯æ”¯æŒ (backend.py)

**æ•°æ®æ¨¡å‹** (SessionState):
```python
class SessionState(BaseModel):
    session_name: str
    status: SessionStatus
    conversation_id: Optional[str]
    history: List[Message] = []  # â† å¯¹è¯å†å²å­˜å‚¨
    # ...
```

**API æ¥å£**:
- âœ… `GET /api/sessions/{session_name}` (lines 1882-1913)
  - è¿”å›å®Œæ•´ä¼šè¯æ•°æ®ï¼ŒåŒ…å« `history` å­—æ®µ
  - æ•°æ®ç»“æ„ï¼š`{ success: true, data: { session: {..., history: [...]} } }`

- âœ… `POST /api/manual/messages` (lines 1916-2001)
  - äººå·¥æ¶ˆæ¯å†™å…¥
  - è‡ªåŠ¨æ·»åŠ åˆ° `session_state.history`
  - é€šè¿‡ SSE å®æ—¶æ¨é€

**æ¶ˆæ¯å­˜å‚¨é€»è¾‘**:
```python
# æ·»åŠ æ¶ˆæ¯åˆ°å†å²
session_state.add_message(message)
await session_store.save(session_state)

# SSE å®æ—¶æ¨é€
await sse_queues[session_name].put({
    "type": "manual_message",
    "role": role,
    "content": content
})
```

#### 2. å‰ç«¯æ”¯æŒ (agent-workbench)

**Store** (sessionStore.ts:193-223):
```typescript
async function fetchSessionDetail(sessionName: string) {
  const response = await fetch(`/api/sessions/${sessionName}`)
  const data = await response.json()
  currentSession.value = data.data.session  // â† åŒ…å« history
}
```

**UI æ¸²æŸ“** (Dashboard.vue:584-603):
```vue
<div ref="chatHistoryRef" class="chat-history">
  <div v-for="message in sessionStore.currentSession.history" :key="message.id">
    <!-- æ˜¾ç¤ºæ¶ˆæ¯å†…å®¹ -->
  </div>
</div>
```

**è°ƒç”¨æ—¶æœº**:
1. ç‚¹å‡»ä¼šè¯åˆ—è¡¨ â†’ `handleSelectSession(sessionName)`
2. æ¥å…¥ä¼šè¯å â†’ `handleTakeover() â†’ fetchSessionDetail()`
3. å‘é€æ¶ˆæ¯å â†’ `sendMessage() â†’ fetchSessionDetail()`

---

## âš ï¸ é—®é¢˜åˆ†æ

### å¯èƒ½åŸå›  1: ä¼šè¯æœ¬èº«æ²¡æœ‰å†å²æ¶ˆæ¯ â­ **æœ€å¯èƒ½**

**ç—‡çŠ¶**:
- å³ä¾§å¯¹è¯æ¡†ä¸ºç©º
- æ²¡æœ‰ä»»ä½•æ¶ˆæ¯æ˜¾ç¤º

**åŸå› **:
- æµ‹è¯•ä¼šè¯åˆšåˆ›å»ºï¼Œè¿˜æ²¡æœ‰ç”¨æˆ·æˆ–AIçš„å¯¹è¯
- `history` æ•°ç»„ä¸ºç©ºï¼š`history: []`

**éªŒè¯æ–¹æ³•**:
```bash
# æ£€æŸ¥ Redis ä¸­çš„ä¼šè¯æ•°æ®
redis-cli GET "session:test_session_name"

# é¢„æœŸè¾“å‡ºï¼ˆç©ºå†å²ï¼‰:
{
  "session_name": "test_session_name",
  "history": [],  # â† ç©ºæ•°ç»„
  "status": "pending_manual"
}
```

**è§£å†³æ–¹æ¡ˆ**:
1. **åˆ›å»ºæœ‰å¯¹è¯å†å²çš„æµ‹è¯•ä¼šè¯**:
   ```bash
   # 1. é€šè¿‡ç”¨æˆ·ç«¯å‘èµ·å¯¹è¯
   curl -X POST http://localhost:8000/api/chat \
     -H "Content-Type: application/json" \
     -d '{"message":"ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢äº§å“","user_id":"test_user_001"}'

   # 2. AI ä¼šå›å¤ï¼Œhistory å¢åŠ  2 æ¡æ¶ˆæ¯
   # 3. åœ¨åå¸­å·¥ä½œå°ç‚¹å‡»è¯¥ä¼šè¯ï¼Œåº”è¯¥èƒ½çœ‹åˆ°å†å²
   ```

2. **æ‰‹åŠ¨æ¨¡æ‹Ÿäººå·¥å¯¹è¯**:
   ```bash
   # 1. åˆ›å»ºä¼šè¯å¹¶å‡çº§åˆ°äººå·¥
   SESSION="test_$(date +%s)"
   curl -X POST http://localhost:8000/api/conversation/new \
     -d "{\"session_id\":\"$SESSION\"}"

   curl -X POST http://localhost:8000/api/manual/escalate \
     -d "{\"session_name\":\"$SESSION\",\"reason\":\"manual\"}"

   # 2. åå¸­æ¥å…¥
   curl -X POST "http://localhost:8000/api/sessions/$SESSION/takeover" \
     -d '{"agent_id":"agent001","agent_name":"æµ‹è¯•åå¸­"}'

   # 3. å‘é€äººå·¥æ¶ˆæ¯
   curl -X POST http://localhost:8000/api/manual/messages \
     -d "{\"session_name\":\"$SESSION\",\"role\":\"agent\",\"content\":\"æ‚¨å¥½ï¼Œæˆ‘æ˜¯å®¢æœ\"}"

   # 4. åœ¨å·¥ä½œå°æŸ¥çœ‹è¯¥ä¼šè¯ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ¶ˆæ¯
   ```

---

### å¯èƒ½åŸå›  2: å‰ç«¯æœªé€‰ä¸­ä¼šè¯

**ç—‡çŠ¶**:
- å·¦ä¾§ä¼šè¯åˆ—è¡¨æœ‰æ•°æ®
- å³ä¾§èŠå¤©åŒºåŸŸå®Œå…¨ç©ºç™½
- æµè§ˆå™¨æ§åˆ¶å°æ— é”™è¯¯

**åŸå› **:
- ç”¨æˆ·æ²¡æœ‰ç‚¹å‡»å·¦ä¾§ä¼šè¯åˆ—è¡¨ä¸­çš„ä»»ä½•ä¼šè¯
- `sessionStore.currentSession` ä¸º null
- `v-for="message in sessionStore.currentSession.history"` æ— æ³•éå†

**è§£å†³æ–¹æ¡ˆ**:
- **ç‚¹å‡»å·¦ä¾§ä¼šè¯åˆ—è¡¨ä¸­çš„æŸä¸ªä¼šè¯**
- ä¼šè§¦å‘ `handleSelectSession()` â†’ `fetchSessionDetail()`
- å³ä¾§å¼€å§‹æ˜¾ç¤ºä¼šè¯è¯¦æƒ…å’Œå†å²

---

### å¯èƒ½åŸå›  3: API è°ƒç”¨å¤±è´¥

**ç—‡çŠ¶**:
- ç‚¹å‡»ä¼šè¯åå³ä¾§ä»ä¸ºç©º
- æµè§ˆå™¨æ§åˆ¶å°æœ‰é”™è¯¯ï¼š`âŒ è·å–ä¼šè¯è¯¦æƒ…å¤±è´¥`

**å¯èƒ½çš„é”™è¯¯**:
- `HTTP 404`: ä¼šè¯ä¸å­˜åœ¨ï¼ˆsession_name é”™è¯¯ï¼‰
- `HTTP 500`: åç«¯æœåŠ¡å¼‚å¸¸
- Network error: åç«¯æœåŠ¡æœªå¯åŠ¨

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥åç«¯æœåŠ¡
lsof -i :8000
# åº”è¯¥çœ‹åˆ° python3 backend.py

# 2. æµ‹è¯• API æ˜¯å¦æ­£å¸¸
SESSION_NAME="test_session_name"
curl http://localhost:8000/api/sessions/$SESSION_NAME

# 3. æŸ¥çœ‹åç«¯æ—¥å¿—
tail -f /tmp/backend_*.log | grep "è·å–ä¼šè¯çŠ¶æ€"
```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ 8000 ç«¯å£
- æ£€æŸ¥ session_name æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹åç«¯æ—¥å¿—å®šä½å…·ä½“é”™è¯¯

---

### å¯èƒ½åŸå›  4: å‰ç«¯æ•°æ®ç»‘å®šé—®é¢˜

**ç—‡çŠ¶**:
- API è°ƒç”¨æˆåŠŸï¼ˆæµè§ˆå™¨ Network æ ‡ç­¾æ˜¾ç¤º 200ï¼‰
- `sessionStore.currentSession` æœ‰æ•°æ®
- ä½† UI ä¸æ˜¾ç¤º

**æ’æŸ¥**:
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
sessionStore.currentSession
// æŸ¥çœ‹ history å­—æ®µæ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•°æ®

sessionStore.currentSession.history
// æŸ¥çœ‹å…·ä½“æ¶ˆæ¯å†…å®¹
```

**å¯èƒ½é—®é¢˜**:
- `history` å­—æ®µä¸º undefinedï¼ˆåç«¯æœªè¿”å›ï¼‰
- `history` æ•°æ®æ ¼å¼ä¸åŒ¹é…ï¼ˆç¼ºå°‘ id å­—æ®µï¼‰
- Vue å“åº”æ€§ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**:
- åˆ·æ–°é¡µé¢é‡è¯•
- æ£€æŸ¥åç«¯è¿”å›çš„æ•°æ®ç»“æ„
- æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„ Vue Devtools

---

## ğŸ” å¿«é€Ÿè¯Šæ–­è„šæœ¬

åˆ›å»ºä»¥ä¸‹è„šæœ¬ç”¨äºå¿«é€Ÿè¯Šæ–­ï¼š

```bash
#!/bin/bash
# æ–‡ä»¶: tests/diagnose_chat_history.sh

echo "======================================"
echo "  å¯¹è¯å†å²åŠŸèƒ½è¯Šæ–­å·¥å…·"
echo "======================================"
echo ""

# 1. æ£€æŸ¥åç«¯æœåŠ¡
echo "1ï¸âƒ£ æ£€æŸ¥åç«¯æœåŠ¡..."
if lsof -i :8000 > /dev/null 2>&1; then
    echo "âœ… åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸ (8000ç«¯å£)"
else
    echo "âŒ åç«¯æœåŠ¡æœªè¿è¡Œï¼è¯·å¯åŠ¨: python3 backend.py"
    exit 1
fi

# 2. åˆ›å»ºæµ‹è¯•ä¼šè¯
SESSION="diag_$(date +%s)"
echo ""
echo "2ï¸âƒ£ åˆ›å»ºæµ‹è¯•ä¼šè¯: $SESSION"
curl -s -X POST http://localhost:8000/api/conversation/new \
  -H "Content-Type: application/json" \
  -d "{\"session_id\":\"$SESSION\"}" > /dev/null

# 3. ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼ˆç”ŸæˆAIå›å¤ï¼‰
echo "3ï¸âƒ£ æ¨¡æ‹Ÿç”¨æˆ·å¯¹è¯..."
curl -s -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d "{\"message\":\"ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢äº§å“\",\"user_id\":\"$SESSION\"}" > /dev/null

sleep 2

# 4. å‡çº§åˆ°äººå·¥
echo "4ï¸âƒ£ å‡çº§åˆ°äººå·¥æ¥ç®¡..."
curl -s -X POST http://localhost:8000/api/manual/escalate \
  -H "Content-Type: application/json" \
  -d "{\"session_name\":\"$SESSION\",\"reason\":\"manual\"}" > /dev/null

# 5. åå¸­æ¥å…¥
echo "5ï¸âƒ£ åå¸­æ¥å…¥ä¼šè¯..."
curl -s -X POST "http://localhost:8000/api/sessions/$SESSION/takeover" \
  -H "Content-Type: application/json" \
  -d '{"agent_id":"test_agent","agent_name":"æµ‹è¯•åå¸­"}' > /dev/null

# 6. åå¸­å‘é€æ¶ˆæ¯
echo "6ï¸âƒ£ åå¸­å‘é€æ¶ˆæ¯..."
curl -s -X POST http://localhost:8000/api/manual/messages \
  -H "Content-Type: application/json" \
  -d "{\"session_name\":\"$SESSION\",\"role\":\"agent\",\"content\":\"æ‚¨å¥½ï¼Œæˆ‘æ˜¯Fiidoå®¢æœï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼\",\"agent_info\":{\"agent_id\":\"test_agent\",\"agent_name\":\"æµ‹è¯•åå¸­\"}}" > /dev/null

# 7. è·å–ä¼šè¯è¯¦æƒ…
echo ""
echo "7ï¸âƒ£ è·å–ä¼šè¯è¯¦æƒ…..."
RESPONSE=$(curl -s "http://localhost:8000/api/sessions/$SESSION")

echo "$RESPONSE" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if data.get('success'):
        session = data['data']['session']
        history = session.get('history', [])
        print(f'âœ… ä¼šè¯çŠ¶æ€: {session[\"status\"]}')
        print(f'âœ… å¯¹è¯å†å²æ•°é‡: {len(history)} æ¡')
        print('')
        print('ğŸ“ å¯¹è¯å†å²å†…å®¹:')
        for i, msg in enumerate(history, 1):
            role = msg['role']
            content = msg['content'][:50]
            print(f'  {i}. [{role}] {content}...')
    else:
        print('âŒ è·å–ä¼šè¯å¤±è´¥:', data.get('detail'))
except Exception as e:
    print('âŒ è§£æå¤±è´¥:', e)
"

echo ""
echo "======================================"
echo "  è¯Šæ–­å®Œæˆï¼"
echo "======================================"
echo ""
echo "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:"
echo "  1. è®¿é—®åå¸­å·¥ä½œå°: http://localhost:5174"
echo "  2. ç™»å½•: admin / admin123"
echo "  3. åœ¨ä¼šè¯åˆ—è¡¨ä¸­æ‰¾åˆ°ä¼šè¯: $SESSION"
echo "  4. ç‚¹å‡»è¯¥ä¼šè¯ï¼Œå³ä¾§åº”æ˜¾ç¤ºå¯¹è¯å†å²"
echo ""
```

---

## âœ… PRD éœ€æ±‚æ–‡æ¡£ä¸­çš„è®¾è®¡

### éœ€æ±‚å®šä¹‰

**PRD_COMPLETE_v3.0.md** ä¸­æåˆ°:
- åå¸­å·¥ä½œå°éœ€è¦æ˜¾ç¤º"æ¶ˆæ¯å†å²" (line 450)
- ä¼šè¯éš”ç¦»è¦æ±‚"å¯¹è¯å†å²å®Œå…¨éš”ç¦»" (TESTING_GUIDE.md:267)
- æ–°è®¿å®¢"å¯¹è¯å†å²ä¸ºç©º" (coze.md:92)

### åŠŸèƒ½è¦æ±‚

1. **åŸºç¡€åŠŸèƒ½** âœ… å·²å®ç°:
   - æ˜¾ç¤ºç”¨æˆ·å’ŒAIçš„å¯¹è¯å†å²
   - æ˜¾ç¤ºåå¸­å’Œç”¨æˆ·çš„äººå·¥å¯¹è¯
   - æŒ‰æ—¶é—´é¡ºåºæ’åˆ—
   - åŒºåˆ†ä¸åŒè§’è‰²ï¼ˆç”¨æˆ·/AI/åå¸­ï¼‰

2. **æœªæ˜ç¡®è¦æ±‚**ï¼ˆå¯èƒ½éœ€è¦è¡¥å……ï¼‰:
   - å†å²æ¶ˆæ¯åˆ†é¡µï¼ˆå½“å‰ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ï¼‰
   - å†å²æ¶ˆæ¯æœç´¢
   - å¯¼å‡ºå¯¹è¯è®°å½•
   - æ¶ˆæ¯å·²è¯»/æœªè¯»æ ‡è¯†

---

## ğŸ“ æ€»ç»“

### å½“å‰åŠŸèƒ½å®ç°åº¦ï¼š90%

#### âœ… å·²å®Œæˆ:
- åç«¯æ•°æ®æ¨¡å‹å’Œå­˜å‚¨
- API æ¥å£å®Œæ•´
- å‰ç«¯æ•°æ®è·å–å’Œæ¸²æŸ“
- å®æ—¶æ¶ˆæ¯æ¨é€

#### âš ï¸ å¯èƒ½çš„é—®é¢˜:
- æµ‹è¯•æ•°æ®ä¸è¶³ï¼ˆä¼šè¯æ²¡æœ‰å†å²æ¶ˆæ¯ï¼‰
- ç”¨æˆ·æœªç‚¹å‡»ä¼šè¯ï¼ˆå‰ç«¯æœªåŠ è½½æ•°æ®ï¼‰
- é¦–æ¬¡ä½¿ç”¨ç¼ºå°‘å¼•å¯¼

#### ğŸ’¡ å»ºè®®æ”¹è¿›:
1. **æ·»åŠ ç©ºçŠ¶æ€æç¤º**:
   ```vue
   <div v-if="sessionStore.currentSession.history.length === 0" class="empty-state">
     <p>æš‚æ— å¯¹è¯å†å²</p>
     <p>å¼€å§‹å‘é€æ¶ˆæ¯è¿›è¡Œå¯¹è¯</p>
   </div>
   ```

2. **æ·»åŠ åŠ è½½çŠ¶æ€**:
   ```vue
   <div v-if="sessionStore.isLoading" class="loading">
     åŠ è½½å¯¹è¯å†å²ä¸­...
   </div>
   ```

3. **è‡ªåŠ¨åˆ›å»ºæµ‹è¯•æ•°æ®**:
   - åœ¨å¼€å‘ç¯å¢ƒè‡ªåŠ¨åˆ›å»ºå¸¦å†å²çš„æµ‹è¯•ä¼šè¯
   - è¿è¡Œè¯Šæ–­è„šæœ¬ç”Ÿæˆæµ‹è¯•æ•°æ®

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-27
**ç‰ˆæœ¬**: v3.7.0
