# Coze 工作流配置方案 v7.8.0

> **更新日期**: 2025-12-29
> **版本**: v7.8.0

---

## 一、架构概览

### 三大业务分支

```
用户进线
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│                    前端快捷回复按钮                           │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────┐│
│  │ Pre-sales   │ │ Where's my  │ │ After-sales │ │Contact ││
│  │ inquiry     │ │ package?    │ │ support     │ │support ││
│  │ (presale)   │ │ (tracking)  │ │(after_sale) │ │team    ││
│  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └───┬────┘│
└─────────┼───────────────┼───────────────┼────────────┼─────┘
          │               │               │            │
          ▼               ▼               ▼            ▼
    ┌──────────────────────────────────────────┐  ┌─────────┐
    │            Coze 工作流                    │  │后端直接 │
    │                                          │  │转人工   │
    │  ┌─────────────────────────────────────┐ │  └─────────┘
    │  │         意图识别节点                  │ │
    │  │     (意图识别.md v3.0)               │ │
    │  └──────────────┬──────────────────────┘ │
    │                 │                        │
    │    ┌────────────┼────────────┐           │
    │    │            │            │           │
    │    ▼            ▼            ▼           │
    │ ┌────────┐ ┌────────┐ ┌────────┐        │
    │ │presale │ │tracking│ │after_  │        │
    │ │        │ │        │ │sale    │        │
    │ └────┬───┘ └────┬───┘ └────┬───┘        │
    │      │          │          │            │
    │      ▼          ▼          ▼            │
    │ ┌────────┐ ┌────────┐ ┌────────┐        │
    │ │presale │ │订单查询 │ │售后流程│        │
    │ │_reply  │ │回复_v2  │ │回复    │        │
    │ │.md     │ │.md      │ │.md     │        │
    │ └────────┘ └────────┘ └────────┘        │
    └──────────────────────────────────────────┘
```

---

## 二、Intent 定义

### 前端 → 后端 → Coze

| 快捷按钮 | Intent 值 | Coze 路由 | 提示词文件 |
|----------|-----------|-----------|------------|
| Pre-sales inquiry | `presale` | presale 分支 | presale_reply.md |
| Where's my package? | `tracking` | tracking 分支 | 订单查询回复_v2.md |
| After-sales support | `after_sale` | after_sale 分支 | 售后流程回复.md |
| Contact support team | `contact_agent` | 后端拦截 | 不经过 Coze |

---

## 三、Coze 工作流节点配置

### 节点1：意图识别

**提示词文件**: `意图识别.md` (v3.0)

**输入变量**:
- `{{user_input}}`: 用户消息
- `{{chat_history}}`: 对话历史
- `{{INTENT}}`: 前端预传入意图

**输出**:
```json
{
  "intent": "presale | tracking | after_sale",
  "order_number": "UK22080 | null",
  "email": "xxx@xxx.com | null",
  "confidence": 0.95,
  "from_intent_param": true | false
}
```

### 节点2：条件路由

根据 `intent` 字段路由到对应分支：

| intent | 路由到 |
|--------|--------|
| `presale` | 售前回复节点 |
| `tracking` | 物流查询节点 |
| `after_sale` | 售后回复节点 |

### 节点3a：售前回复 (presale)

**提示词文件**: `presale_reply.md` (v1.0)

**特点**:
- 参考 'aa' 知识库
- 默认英文回复
- 支持多语言（检测用户语言并匹配回复）
- 产品推荐、参数咨询、价格查询

**输入变量**:
- `{{input}}`: 用户问题
- `{{resp}}`: 'aa' 知识库匹配结果
- `{{chat_history}}`: 对话历史

### 节点3b：物流查询 (tracking)

**提示词文件**: `订单查询回复_v2.md` (v2.0)

**特点**:
- 使用订单号查询 Shopify 订单
- 调用 17track API 获取物流轨迹
- 输出商品卡片格式

**输入变量**:
- `{{USER_INPUT}}`: 用户问题
- `{{order_result}}`: 订单数据
- `{{tracking_result}}`: 物流数据

### 节点3c：售后回复 (after_sale)

**提示词文件**: `售后流程回复.md` (v1.0)

**特点**:
- 退换货流程引导
- 维修申请
- 投诉处理
- 质保咨询

---

## 四、知识库配置

| 知识库 | 用途 | 使用场景 |
|--------|------|----------|
| **aa** | 产品 FAQ、参数、使用说明 | presale 分支 |
| **bb** | 产品链接库 | 价格查询时使用 browse 工具 |

---

## 五、提示词文件清单

| 文件名 | 版本 | 用途 | 分支 |
|--------|------|------|------|
| 意图识别.md | v3.0 | 意图识别 + 实体提取 | 入口 |
| presale_reply.md | v1.0 | 售前咨询回复 | presale |
| 订单查询回复_v2.md | v2.0 | 物流查询回复 | tracking |
| 售后流程回复.md | v1.0 | 售后问题回复 | after_sale |

### 可删除/归档的文件

| 文件名 | 原用途 | 处理建议 |
|--------|--------|----------|
| 产品咨询智能回复.md | 旧版售前 | 已被 presale_reply.md 替代 |
| 订单引导回复.md | 无订单号引导 | 合并到 tracking 分支 |
| 通用回复.md | 闲聊问候 | 合并到 presale 分支 |
| 邮箱查询回复.md | 邮箱查订单 | 合并到 tracking 分支 |

---

## 六、Coze 工作流修改步骤

### Step 1: 更新意图识别节点

1. 替换提示词为 `意图识别.md` v3.0 内容
2. 确保输入变量包含 `INTENT`
3. 输出解析 JSON 中的 `intent` 字段

### Step 2: 修改条件分支

1. 删除旧的 `order_status`、`general` 等分支
2. 保留/创建三个分支：
   - `presale` → 售前回复节点
   - `tracking` → 物流查询节点
   - `after_sale` → 售后回复节点

### Step 3: 更新各分支提示词

1. **presale 分支**: 使用 `presale_reply.md`
   - 配置 'aa' 知识库调用
   - 配置 'bb' 数据库用于价格查询

2. **tracking 分支**: 使用 `订单查询回复_v2.md`
   - 配置 Shopify 订单查询插件
   - 配置 17track 物流查询插件

3. **after_sale 分支**: 使用 `售后流程回复.md`
   - 配置工单创建逻辑（可选）

### Step 4: 测试验证

测试用例：

| 测试场景 | 用户输入 | 预期路由 |
|----------|----------|----------|
| 售前咨询 | "C11 Pro 续航多少" | presale |
| 物流查询 | "UK22080 到哪了" | tracking |
| 售后问题 | "我想退货" | after_sale |
| 带订单号售后 | "UK22080 我要退货" | after_sale |
| 闲聊问候 | "你好" | presale |

---

## 七、后端代码变更

### 已修改文件

| 文件 | 变更内容 |
|------|----------|
| `models.py` | UserIntent 枚举简化为 4 个值 |
| `chatStore.ts` | UserIntent 类型同步更新 |
| `WelcomeScreen.vue` | 快捷按钮配置更新 |

### Intent 枚举对照

| 旧值 | 新值 | 说明 |
|------|------|------|
| `order_status` | `tracking` | 改名更精确 |
| `general` | (删除) | 合并到 presale |
| `presale` | `presale` | 保持不变 |
| `after_sale` | `after_sale` | 保持不变 |
| `contact_agent` | `contact_agent` | 保持不变 |

---

## 八、版本记录

### v7.8.0 (2025-12-29)
- 简化为三大业务分支：presale、tracking、after_sale
- 移除 order_status、general 等冗余意图
- 新增 presale_reply.md（英文默认 + 多语言支持）
- 更新意图识别.md 到 v3.0
