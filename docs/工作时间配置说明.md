# 工作时间配置说明

## 概述

人工客服工作时间配置用于控制系统何时允许将用户请求升级到人工客服。此功能在 v3.2 版本中实现。

---

## 配置位置

### .env 文件配置

```bash
# 人工客服工作时间配置 (v3.2+)
HUMAN_SHIFT_START=00:00      # 工作时间开始（格式: HH:MM）
HUMAN_SHIFT_END=23:59         # 工作时间结束（格式: HH:MM）
WEEKENDS_DISABLED=false       # 周末是否禁用人工客服
TIMEZONE=Asia/Shanghai        # 时区配置
HOLIDAYS=                     # 节假日列表（格式: YYYY-MM-DD,YYYY-MM-DD）
```

---

## 工作模式

### 1. 测试/开发阶段（当前配置）

**配置值**：
- `HUMAN_SHIFT_START=00:00`
- `HUMAN_SHIFT_END=23:59`
- `WEEKENDS_DISABLED=false`

**行为**：
- ✅ 全天24小时允许人工接入
- ✅ 周末允许接入
- ✅ 回归测试可以在任何时间运行
- ✅ 开发调试不受时间限制

**适用场景**：
- 开发阶段测试
- 回归测试运行
- 功能验证
- 演示展示

---

### 2. 生产环境（建议配置）

**配置值示例**：
```bash
HUMAN_SHIFT_START=09:00
HUMAN_SHIFT_END=18:00
WEEKENDS_DISABLED=true
HOLIDAYS=2025-01-01,2025-02-10,2025-05-01
```

**行为**：
- ✅ 工作日 09:00-18:00 允许人工接入
- ❌ 非工作时间只发送邮件通知，不改变会话状态
- ❌ 周末不接入人工客服
- ❌ 节假日不接入人工客服

**适用场景**：
- 正式生产环境
- 有明确客服工作时间的企业
- 需要控制人工成本

---

## 行为差异

### 工作时间内

用户点击"人工客服"或触发自动升级时：

```
1. 会话状态: bot_active → pending_manual
2. 坐席工作台: 显示待接入会话
3. 邮件通知: 可选发送
4. 用户体验: 等待坐席接入
```

### 非工作时间

用户点击"人工客服"或触发自动升级时：

```
1. 会话状态: 保持 bot_active（不变）
2. 坐席工作台: 不显示
3. 邮件通知: 必须发送（记录需求）
4. 用户体验: AI 继续服务，告知工作时间
```

---

## 回归测试注意事项 ⚠️

### 问题现象

如果配置了限制性工作时间（如 09:00-18:00），在非工作时间运行 `./tests/regression_test.sh` 会导致以下测试失败：

- ❌ 测试4: 人工升级
- ❌ 测试5: AI阻止 (manual mode)
- ❌ 测试6: 坐席接入
- ❌ 测试8: 释放会话

### 原因分析

```python
# backend.py - manual_escalate 函数
in_shift = is_in_shift()

if not in_shift:
    # 非工作时间：只发邮件，不触发状态转换
    return {
        "success": True,
        "data": session_state.model_dump(),
        "email_sent": email_sent,
        "is_in_shift": False  # ← 状态仍为 bot_active
    }

# 工作时间：正常触发人工接管
session_state.transition_status(
    new_status=SessionStatus.PENDING_MANUAL  # ← 测试期望此状态
)
```

### 解决方案

**方案1：调整 .env 配置（推荐用于开发/测试）**

```bash
HUMAN_SHIFT_START=00:00
HUMAN_SHIFT_END=23:59
WEEKENDS_DISABLED=false
```

**方案2：在工作时间运行测试**

```bash
# 确认当前是否在工作时间
curl http://localhost:8000/api/shift/status

# 响应示例
{
  "is_in_shift": true,  # ← 必须是 true
  "message": "人工客服在线",
  "shift_hours": "09:00 - 18:00"
}
```

**方案3：临时覆盖环境变量**

```bash
HUMAN_SHIFT_START=00:00 HUMAN_SHIFT_END=23:59 ./tests/regression_test.sh
```

---

## API 接口

### 获取工作时间配置

```bash
GET /api/shift/config
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "shift_start": "00:00",
    "shift_end": "23:59",
    "timezone": "Asia/Shanghai",
    "weekends_disabled": false,
    "holidays": [],
    "is_in_shift": true
  }
}
```

### 获取当前工作状态

```bash
GET /api/shift/status
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "is_in_shift": true,
    "message": "人工客服在线",
    "shift_hours": "00:00 - 23:59"
  }
}
```

---

## 代码实现

### ShiftConfig 类

位置：`src/shift_config.py`

```python
class ShiftConfig:
    def is_in_shift(self, check_time: Optional[datetime] = None) -> bool:
        """
        判断指定时间是否在工作时间内

        检查顺序：
        1. 节假日检查
        2. 周末检查
        3. 时间范围检查
        """
```

### 调用位置

```python
# backend.py - manual_escalate 接口
in_shift = is_in_shift()  # 调用全局函数

if not in_shift:
    # 非工作时间处理逻辑
    ...
else:
    # 工作时间处理逻辑
    ...
```

---

## 常见问题 FAQ

### Q1: 为什么测试阶段要设置为全天接入？

**A**: 回归测试需要验证人工接管功能，如果设置了限制性工作时间，在非工作时间运行测试会失败。设置为全天接入可以确保测试随时可以运行。

### Q2: 生产环境如何配置？

**A**: 根据实际客服团队的工作时间设置：
- 国内企业：`09:00-18:00`，周末禁用
- 跨时区企业：可能需要设置多个班次或使用跨天配置（如 `22:00-06:00`）
- 24小时客服：保持测试配置 `00:00-23:59`

### Q3: 非工作时间用户请求人工客服会怎样？

**A**:
1. 系统发送邮件通知管理员
2. 会话状态保持 `bot_active`（AI 继续服务）
3. 前端可以显示提示："当前非工作时间，AI 将继续为您服务"
4. 记录到日志系统，供第二天工作时回访

### Q4: 如何支持跨时区客服？

**A**:
- 方案1：使用统一时区（如 UTC），配置覆盖所有时区的工作时间
- 方案2：配置为 `00:00-23:59`，通过轮班制度覆盖全天
- 方案3：扩展 `ShiftConfig` 支持多时区配置（需要开发）

### Q5: 修改配置后需要重启服务吗？

**A**: 是的，`.env` 文件的修改需要重启 backend 服务才能生效：

```bash
# 重启后端
pkill -f "python3 backend.py"
python3 backend.py
```

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| v3.2.0 | 2025-11-25 | 初始实现工作时间配置功能 |
| v3.2.1 | 2025-11-25 | 修复测试阶段配置，设置为全天接入 |

---

## 相关文档

- `prd/04_任务拆解/email_and_monitoring_tasks.md` - 邮件通知任务
- `src/shift_config.py` - 工作时间配置实现
- `tests/regression_test.sh` - 回归测试脚本
- `.env` - 环境变量配置文件

---

**文档维护者**: Claude Code
**最后更新**: 2025-11-25
**状态**: ✅ 已验证（回归测试 12/12 通过）
