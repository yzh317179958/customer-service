# 手动测试指南 - 模块2: 队列管理与优先级

> **测试对象**: L1-1-Part1-模块2 - 会话优先级与队列管理
> **测试版本**: v3.6.0
> **测试日期**: 2025-01-27
> **测试人员**: Claude Code

---

## 测试环境准备

### 1. 启动服务

```bash
# 终端1: 启动后端
cd /home/yzh/AI客服/鉴权
python3 backend.py

# 终端2: 启动坐席工作台
cd agent-workbench
npm run dev

# 访问: http://localhost:5174
# 默认账号: admin/admin123 或 agent001/agent123
```

### 2. 创建测试数据

使用以下脚本创建测试会话（包含VIP客户、普通客户、不同等待时间）:

```bash
# 创建测试会话
python3 create_test_data.py
```

或手动创建：

```bash
# 创建VIP客户会话（等待3分钟）
curl -X POST http://localhost:8000/api/manual/escalate \
  -H "Content-Type: application/json" \
  -d '{"session_name": "vip_session_001", "reason": "manual"}'

# 创建普通客户会话（等待1分钟）
curl -X POST http://localhost:8000/api/manual/escalate \
  -H "Content-Type: application/json" \
  -d '{"session_name": "normal_session_001", "reason": "manual"}'
```

---

## 测试用例清单

### ✅ 测试1: 队列API功能验证

**测试步骤**:
1. 打开终端
2. 执行队列API调用：
   ```bash
   curl -s http://localhost:8000/api/sessions/queue | python3 -m json.tool
   ```

**预期结果**:
- ✅ 返回 `"success": true`
- ✅ 包含 `total_count` (总队列数量)
- ✅ 包含 `vip_count` (VIP客户数量)
- ✅ 包含 `avg_wait_time` (平均等待时长)
- ✅ 包含 `max_wait_time` (最长等待时长)
- ✅ `queue` 数组中每个项包含:
  - `session_name`
  - `position` (队列位置，从1开始)
  - `priority_level` ("urgent", "high", "normal")
  - `is_vip` (true/false)
  - `wait_time_seconds` (等待时长，秒)
  - `urgent_keywords` (触发的紧急关键词列表)

**实际结果**: [ 通过 / 失败 ]

---

### ✅ 测试2: 优先级标识显示

**测试步骤**:
1. 登录坐席工作台 (http://localhost:5174)
2. 切换到"待接入"标签页
3. 观察会话列表中的优先级标识

**预期结果**:
- ✅ VIP客户显示🔴红色标识（urgent）
- ✅ 等待超过5分钟的会话显示🔴红色标识（urgent）
- ✅ 包含紧急关键词（"投诉"、"退款"等）的会话显示🟠橙色标识（high）
- ✅ 普通会话不显示特殊标识（normal）
- ✅ 鼠标悬停在标识上显示提示文本（"紧急" / "重要"）
- ✅ urgent 标识有轻微脉冲动画效果

**实际结果**: [ 通过 / 失败 ]

**截图**:
- [ ] 已截图保存到 `screenshots/module2_priority_badges.png`

---

### ✅ 测试3: 队列统计信息显示

**测试步骤**:
1. 登录坐席工作台
2. 确保有等待接入的会话（pending_manual状态）
3. 观察左侧面板的队列统计区域

**预期结果**:
- ✅ 显示"等待队列"标题区域
- ✅ 显示队列总人数（如"5人"）
- ✅ 显示以下三个指标：
  - 🔴 VIP客户数量
  - ⏱️ 平均等待时长
  - ⚠️ 最长等待时长
- ✅ 背景为渐变橙色（#FEF3C7 → #FED7AA）
- ✅ 当队列为空时，统计区域隐藏

**实际结果**: [ 通过 / 失败 ]

**截图**:
- [ ] 已截图保存到 `screenshots/module2_queue_stats.png`

---

### ✅ 测试4: 队列优先级排序

**测试步骤**:
1. 创建以下测试会话（按顺序创建）:
   - 普通客户A (normal)
   - VIP客户B (urgent)
   - 普通客户C，包含"投诉"关键词 (high)
   - 普通客户D (normal)
2. 调用队列API查看排序:
   ```bash
   curl -s http://localhost:8000/api/sessions/queue | python3 -c "
   import sys, json
   d = json.load(sys.stdin)
   for item in d['data']['queue']:
       print(f\"{item['position']}. {item['session_name']} - {item['priority_level']} (VIP:{item['is_vip']})\")
   "
   ```

**预期结果**:
- ✅ VIP客户B排在第1位（urgent优先级最高）
- ✅ 包含"投诉"的客户C排在第2位（high优先级）
- ✅ 普通客户A、D排在后面（normal优先级）
- ✅ 同优先级按等待时长降序排列

**实际结果**: [ 通过 / 失败 ]

**队列排序**:
```
1. ________ - ______ (VIP:____)
2. ________ - ______ (VIP:____)
3. ________ - ______ (VIP:____)
4. ________ - ______ (VIP:____)
```

---

### ✅ 测试5: VIP客户自动识别

**测试步骤**:
1. 创建测试会话，设置 `user_profile.vip = true`
2. 触发人工升级（调用 `/api/manual/escalate`）
3. 查看队列API返回的优先级

**预期结果**:
- ✅ VIP客户的 `is_vip` 字段为 `true`
- ✅ VIP客户的 `priority_level` 自动设置为 `"urgent"`
- ✅ VIP客户在队列中排在最前面

**实际结果**: [ 通过 / 失败 ]

---

### ✅ 测试6: 等待超时检测

**测试步骤**:
1. 创建测试会话
2. 触发人工升级
3. 等待6分钟（超过5分钟阈值）
4. 调用队列API查看优先级

**预期结果**:
- ✅ `is_timeout` 字段为 `true`
- ✅ `priority_level` 自动提升为 `"urgent"`
- ✅ 前端显示🔴红色urgent标识
- ✅ 等待时长正确显示（如"6分钟"）

**实际结果**: [ 通过 / 失败 ]

**注意**: 为了快速测试，可以临时修改 `src/session_state.py:200` 将超时阈值从300秒改为60秒。

---

### ✅ 测试7: 紧急关键词触发

**测试步骤**:
1. 创建测试会话，用户消息包含"投诉"关键词
2. 触发AI对话：
   ```bash
   curl -X POST http://localhost:8000/api/chat \
     -H "Content-Type: application/json" \
     -d '{"message":"我要投诉你们的服务","user_id":"keyword_test_001"}'
   ```
3. 触发人工升级
4. 查看队列API返回的优先级

**预期结果**:
- ✅ `urgent_keywords` 数组包含 `["投诉"]`
- ✅ `priority_level` 为 `"high"` (如果不是VIP)
- ✅ 前端显示🟠橙色high标识

**实际结果**: [ 通过 / 失败 ]

**触发的关键词**: [ 投诉 / 退款 / 质量问题 / 差评 / 赔偿 ]

---

### ✅ 测试8: 队列自动刷新

**测试步骤**:
1. 登录坐席工作台
2. 保持页面打开
3. 在另一个终端创建新的等待会话
4. 观察队列统计区域

**预期结果**:
- ✅ 队列统计在30秒内自动更新（轮询间隔）
- ✅ `total_count` 数字增加
- ✅ 新会话出现在会话列表中

**实际结果**: [ 通过 / 失败 ]

**刷新时间**: ______秒

---

### ✅ 测试9: TypeScript类型检查

**测试步骤**:
1. 在 `agent-workbench` 目录运行类型检查:
   ```bash
   cd agent-workbench
   npx vue-tsc --noEmit
   ```

**预期结果**:
- ✅ 无TypeScript错误
- ✅ 新增的类型（`PriorityLevel`, `PriorityInfo`, `QueueSessionInfo`, `QueueResponse`）正确定义
- ✅ 所有引用处类型匹配

**实际结果**: [ 通过 / 失败 ]

**错误信息**:
```
(如有错误，粘贴在此)
```

---

### ✅ 测试10: 回归测试套件

**测试步骤**:
1. 运行完整回归测试:
   ```bash
   cd /home/yzh/AI客服/鉴权
   ./tests/regression_test.sh
   ```

**预期结果**:
- ✅ 所有19个测试通过（14个原有 + 3个模块2新增 + 2个TypeScript）
- ✅ 测试15: 队列API调用 ✅ 通过
- ✅ 测试16: 队列数据结构完整性 ✅ 通过
- ✅ 测试17: 队列项包含优先级字段 ✅ 通过

**实际结果**: [ 通过 / 失败 ]

**测试结果**:
```
通过: ___/19
失败: ___/19
```

---

## 边界条件测试

### 测试11: 空队列场景

**测试步骤**:
1. 确保没有pending_manual状态的会话
2. 调用队列API
3. 观察前端显示

**预期结果**:
- ✅ API返回 `total_count: 0`, `vip_count: 0`
- ✅ 队列数组为空 `[]`
- ✅ 前端队列统计区域隐藏（`v-if="sessionStore.queueStats.total_count > 0"`）

**实际结果**: [ 通过 / 失败 ]

---

### 测试12: 大量队列场景

**测试步骤**:
1. 创建50个等待会话（混合VIP和普通客户）
2. 调用队列API
3. 观察性能

**预期结果**:
- ✅ API响应时间 < 500ms
- ✅ 队列正确排序（urgent > high > normal）
- ✅ 前端渲染流畅，无明显卡顿

**实际结果**: [ 通过 / 失败 ]

**响应时间**: ______ms

---

## 问题记录

### 发现的问题

| 问题编号 | 严重程度 | 问题描述 | 重现步骤 | 修复状态 |
|---------|---------|---------|---------|---------|
| M2-01   | [ P0 / P1 / P2 ] | (问题描述) | (步骤) | [ 待修复 / 已修复 ] |
| M2-02   | [ P0 / P1 / P2 ] | (问题描述) | (步骤) | [ 待修复 / 已修复 ] |

### 改进建议

1. (建议内容)
2. (建议内容)

---

## 测试结论

**总体评估**: [ 通过 / 失败 / 部分通过 ]

**通过的测试用例数**: ___/12

**核心功能状态**:
- [ ] 队列API功能正常
- [ ] 优先级计算逻辑正确
- [ ] 前端显示符合预期
- [ ] 排序算法有效
- [ ] TypeScript类型安全

**建议**:
- [ ] 可以进入下一阶段开发
- [ ] 需要修复问题后再继续
- [ ] 需要优化性能

---

**测试人员签名**: _______________
**测试完成时间**: _______________
**备注**:

---

## 附录: 测试数据脚本

如需要批量创建测试数据，可以使用以下Python脚本:

```python
#!/usr/bin/env python3
# create_test_data.py
import requests
import time

BASE_URL = "http://localhost:8000"

test_sessions = [
    {"session_name": "vip_urgent_001", "vip": True, "keywords": []},
    {"session_name": "normal_complaint_001", "vip": False, "keywords": ["投诉"]},
    {"session_name": "normal_refund_001", "vip": False, "keywords": ["退款"]},
    {"session_name": "normal_001", "vip": False, "keywords": []},
    {"session_name": "normal_002", "vip": False, "keywords": []},
]

for session in test_sessions:
    # 创建会话并触发人工升级
    response = requests.post(
        f"{BASE_URL}/api/manual/escalate",
        json={"session_name": session["session_name"], "reason": "manual"}
    )
    print(f"✅ 创建会话: {session['session_name']} - {response.status_code}")
    time.sleep(1)

print("\n✅ 测试数据创建完成！")
```

---

**文档版本**: v1.0
**最后更新**: 2025-01-27
