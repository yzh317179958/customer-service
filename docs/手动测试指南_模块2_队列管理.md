# 手动测试指南 - 模块2: 队列管理与优先级

> **测试对象**: L1-1-Part1-模块2 - 会话优先级与队列管理
> **测试版本**: v3.6.0 (已修复priority字段缺失问题)
> **测试日期**: 2025-01-27
> **测试人员**: Claude Code
> **修订日期**: 2025-01-27 (修复版)

---

## ⚠️ 重要说明

本测试指南已根据实际修复情况更新：
- ✅ 修复了handleFilterChange函数未定义问题
- ✅ 修复了会话列表API缺少priority字段问题
- ✅ 新增自动化验证脚本 `tests/verify_module2_display.sh`

---

## 测试环境准备

### 1. 启动服务

```bash
# 终端1: 启动后端
cd /home/yzh/AI客服/鉴权
python3 backend.py

# 终端2: 启动坐席工作台
cd agent-workbench
npm run dev

# 前端访问地址会自动分配（通常是5174-5182之间）
# 查看终端输出获取实际端口，如: http://localhost:5182/
# 默认账号: admin/admin123 或 agent001/agent123
```

### 2. 快速验证（推荐）

在开始手动测试前，先运行自动化验证脚本确保后端API正常：

```bash
cd /home/yzh/AI客服/鉴权
./tests/verify_module2_display.sh
```

**预期输出**:
```
✅ 测试1: 会话列表API返回priority字段
✅ 测试2: VIP客户标记为urgent级别
✅ 测试3: 队列统计数据结构完整
✅ 测试4: 队列项包含position排序字段
✅ 测试5: 紧急关键词检测
```

如果所有测试通过，继续进行前端手动测试。

### 3. 创建测试数据（可选）

使用以下脚本创建测试会话（包含VIP客户、普通客户、不同等待时间）:

```bash
# 创建测试会话
python3 create_test_data.py
```

或手动创建：

```bash
# 创建VIP客户会话（等待3分钟）
curl -X POST http://localhost:8000/api/manual/escalate \
  -H "Content-Type: application/json" \
  -d '{"session_name": "vip_session_001", "reason": "manual"}'

# 创建普通客户会话（等待1分钟）
curl -X POST http://localhost:8000/api/manual/escalate \
  -H "Content-Type: application/json" \
  -d '{"session_name": "normal_session_001", "reason": "manual"}'
```

---

## 测试用例清单

### ✅ 测试1: 队列API功能验证

**测试步骤**:
1. 打开终端
2. 执行队列API调用：
   ```bash
   curl -s http://localhost:8000/api/sessions/queue | python3 -m json.tool
   ```

**预期结果**:
- ✅ 返回 `"success": true`
- ✅ 包含 `total_count` (总队列数量)
- ✅ 包含 `vip_count` (VIP客户数量)
- ✅ 包含 `avg_wait_time` (平均等待时长)
- ✅ 包含 `max_wait_time` (最长等待时长)
- ✅ `queue` 数组中每个项包含:
  - `session_name`
  - `position` (队列位置，从1开始)
  - `priority_level` ("urgent", "high", "normal")
  - `is_vip` (true/false)
  - `wait_time_seconds` (等待时长，秒)
  - `urgent_keywords` (触发的紧急关键词列表)

**实际结果**: [ 通过 / 失败 ]

---

### ✅ 测试2: 优先级标识显示

**前置条件**: 系统中已有测试数据（VIP客户张三、包含退款关键词的王五）

**测试步骤**:
1. 在浏览器打开坐席工作台（查看终端输出的实际端口，通常是 http://localhost:5182/）
2. 使用 admin/admin123 登录
3. 点击左侧"待接入"标签页（或点击统计卡片中的"待接入"）
4. 观察会话列表中的优先级标识

**预期结果**:
- ✅ **VIP客户张三**显示：
  - 👑VIP 黄色徽章（"VIP"文字）
  - 🔴 红色圆形标识（紧急）
  - 脉冲动画效果（2秒循环，透明度0.7-1.0变化）
  - 鼠标悬停显示"紧急"提示
- ✅ **王五（包含"退款"关键词）**显示：
  - 🟠 橙色圆形标识（重要）
  - 鼠标悬停显示"重要"提示
  - 无动画效果
- ✅ 超时会话（等待>5分钟）显示：
  - 🔴 红色圆形标识（紧急）
  - 脉冲动画效果
- ✅ 普通会话：不显示特殊标识（仅状态标签）

**实际验证**:
- [ ] VIP客户显示正确 ✅
- [ ] 关键词客户显示正确 ✅
- [ ] 超时客户显示正确 ✅
- [ ] 普通客户无标识 ✅
- [ ] 动画效果正常 ✅
- [ ] Tooltip提示正确 ✅

**实际结果**: [ 通过 / 失败 ]

**截图**:
- [ ] 已截图保存到 `screenshots/module2_priority_badges.png`

---

### ✅ 测试3: 队列统计信息显示

**测试步骤**:
1. 在坐席工作台登录后（admin/admin123）
2. 确保有等待接入的会话（pending_manual状态，可通过快速验证脚本确认）
3. 在左侧面板找到【等待队列】统计卡片（位于"详细统计"下方，"筛选标签"上方）
4. 观察统计卡片的内容和样式

**预期结果**:
- ✅ **卡片外观**:
  - 渐变橙色背景（#FEF3C7 → #FED7AA）
  - 圆角边框，底部有分隔线
  - 整体呈现醒目的提示效果
- ✅ **卡片头部**:
  - 📋 图标
  - "等待队列"文字
  - 队列总人数徽章（如"9人"），白色半透明背景
- ✅ **统计指标**（三个并排的小卡片）:
  - 🔴 VIP客户: 显示数字（如"1"）
  - ⏱️ 平均等待: 显示格式化时间（如"5分钟"或"6小时"）
  - ⚠️ 最长等待: 显示格式化时间
- ✅ **空队列行为**: 当队列为空时（total_count = 0），统计卡片完全隐藏

**实际验证**:
- [ ] 卡片背景颜色正确 ✅
- [ ] 三个统计指标显示完整 ✅
- [ ] 时间格式化正确（秒→分→时） ✅
- [ ] 空队列时自动隐藏 ✅

**实际结果**: [ 通过 / 失败 ]

**截图**:
- [ ] 已截图保存到 `screenshots/module2_queue_stats.png`

---

### ✅ 测试4: 队列优先级排序

**测试步骤**:
1. 创建以下测试会话（按顺序创建）:
   - 普通客户A (normal)
   - VIP客户B (urgent)
   - 普通客户C，包含"投诉"关键词 (high)
   - 普通客户D (normal)
2. 调用队列API查看排序:
   ```bash
   curl -s http://localhost:8000/api/sessions/queue | python3 -c "
   import sys, json
   d = json.load(sys.stdin)
   for item in d['data']['queue']:
       print(f\"{item['position']}. {item['session_name']} - {item['priority_level']} (VIP:{item['is_vip']})\")
   "
   ```

**预期结果**:
- ✅ VIP客户B排在第1位（urgent优先级最高）
- ✅ 包含"投诉"的客户C排在第2位（high优先级）
- ✅ 普通客户A、D排在后面（normal优先级）
- ✅ 同优先级按等待时长降序排列

**实际结果**: [ 通过 / 失败 ]

**队列排序**:
```
1. ________ - ______ (VIP:____)
2. ________ - ______ (VIP:____)
3. ________ - ______ (VIP:____)
4. ________ - ______ (VIP:____)
```

---

### ✅ 测试5: VIP客户自动识别

**测试步骤**:
1. 创建测试会话，设置 `user_profile.vip = true`
2. 触发人工升级（调用 `/api/manual/escalate`）
3. 查看队列API返回的优先级

**预期结果**:
- ✅ VIP客户的 `is_vip` 字段为 `true`
- ✅ VIP客户的 `priority_level` 自动设置为 `"urgent"`
- ✅ VIP客户在队列中排在最前面

**实际结果**: [ 通过 / 失败 ]

---

### ✅ 测试6: 等待超时检测

**测试步骤**:
1. 创建测试会话
2. 触发人工升级
3. 等待6分钟（超过5分钟阈值）
4. 调用队列API查看优先级

**预期结果**:
- ✅ `is_timeout` 字段为 `true`
- ✅ `priority_level` 自动提升为 `"urgent"`
- ✅ 前端显示🔴红色urgent标识
- ✅ 等待时长正确显示（如"6分钟"）

**实际结果**: [ 通过 / 失败 ]

**注意**: 为了快速测试，可以临时修改 `src/session_state.py:200` 将超时阈值从300秒改为60秒。

---

### ✅ 测试7: 紧急关键词触发

**测试步骤**:
1. 创建测试会话，用户消息包含"投诉"关键词
2. 触发AI对话：
   ```bash
   curl -X POST http://localhost:8000/api/chat \
     -H "Content-Type: application/json" \
     -d '{"message":"我要投诉你们的服务","user_id":"keyword_test_001"}'
   ```
3. 触发人工升级
4. 查看队列API返回的优先级

**预期结果**:
- ✅ `urgent_keywords` 数组包含 `["投诉"]`
- ✅ `priority_level` 为 `"high"` (如果不是VIP)
- ✅ 前端显示🟠橙色high标识

**实际结果**: [ 通过 / 失败 ]

**触发的关键词**: [ 投诉 / 退款 / 质量问题 / 差评 / 赔偿 ]

---

### ✅ 测试8: 队列自动刷新

**测试步骤**:
1. 登录坐席工作台
2. 保持页面打开
3. 在另一个终端创建新的等待会话
4. 观察队列统计区域

**预期结果**:
- ✅ 队列统计在30秒内自动更新（轮询间隔）
- ✅ `total_count` 数字增加
- ✅ 新会话出现在会话列表中

**实际结果**: [ 通过 / 失败 ]

**刷新时间**: ______秒

---

### ✅ 测试9: TypeScript类型检查

**测试步骤**:
1. 在 `agent-workbench` 目录运行类型检查:
   ```bash
   cd agent-workbench
   npx vue-tsc --noEmit
   ```

**预期结果**:
- ✅ 无TypeScript错误
- ✅ 新增的类型（`PriorityLevel`, `PriorityInfo`, `QueueSessionInfo`, `QueueResponse`）正确定义
- ✅ 所有引用处类型匹配

**实际结果**: [ 通过 / 失败 ]

**错误信息**:
```
(如有错误，粘贴在此)
```

---

### ✅ 测试10: 回归测试套件

**测试步骤**:
1. 运行完整回归测试:
   ```bash
   cd /home/yzh/AI客服/鉴权
   ./tests/regression_test.sh
   ```

**预期结果**:
- ✅ 所有19个测试通过（14个原有 + 3个模块2新增 + 2个TypeScript）
- ✅ 测试15: 队列API调用 ✅ 通过
- ✅ 测试16: 队列数据结构完整性 ✅ 通过
- ✅ 测试17: 队列项包含优先级字段 ✅ 通过

**实际结果**: [ 通过 / 失败 ]

**测试结果**:
```
通过: ___/19
失败: ___/19
```

---

## 边界条件测试

### 测试11: 空队列场景

**测试步骤**:
1. 确保没有pending_manual状态的会话
2. 调用队列API
3. 观察前端显示

**预期结果**:
- ✅ API返回 `total_count: 0`, `vip_count: 0`
- ✅ 队列数组为空 `[]`
- ✅ 前端队列统计区域隐藏（`v-if="sessionStore.queueStats.total_count > 0"`）

**实际结果**: [ 通过 / 失败 ]

---

### 测试12: 大量队列场景

**测试步骤**:
1. 创建50个等待会话（混合VIP和普通客户）
2. 调用队列API
3. 观察性能

**预期结果**:
- ✅ API响应时间 < 500ms
- ✅ 队列正确排序（urgent > high > normal）
- ✅ 前端渲染流畅，无明显卡顿

**实际结果**: [ 通过 / 失败 ]

**响应时间**: ______ms

---

## 问题记录

### 发现的问题

| 问题编号 | 严重程度 | 问题描述 | 重现步骤 | 修复状态 |
|---------|---------|---------|---------|---------|
| M2-01   | [ P0 / P1 / P2 ] | (问题描述) | (步骤) | [ 待修复 / 已修复 ] |
| M2-02   | [ P0 / P1 / P2 ] | (问题描述) | (步骤) | [ 待修复 / 已修复 ] |

### 改进建议

1. (建议内容)
2. (建议内容)

---

## 测试结论

**总体评估**: [ 通过 / 失败 / 部分通过 ]

**通过的测试用例数**: ___/12

**核心功能状态**:
- [ ] 队列API功能正常
- [ ] 优先级计算逻辑正确
- [ ] 前端显示符合预期
- [ ] 排序算法有效
- [ ] TypeScript类型安全

**建议**:
- [ ] 可以进入下一阶段开发
- [ ] 需要修复问题后再继续
- [ ] 需要优化性能

---

## 📝 实际测试记录模板

**测试执行人**: _____________
**测试执行时间**: 2025-___-___
**测试环境**:
- 后端服务: http://localhost:8000 [ 正常 / 异常 ]
- 前端服务: http://localhost:_____ [ 正常 / 异常 ]
- 快速验证脚本: [ 5/5通过 / ___/5通过 ]

### 核心功能测试结果

| 测试编号 | 测试项 | 结果 | 备注 |
|---------|-------|------|------|
| 测试1 | 队列API功能 | [ ✅ / ❌ ] | |
| 测试2 | 优先级标识显示 | [ ✅ / ❌ ] | |
| 测试3 | 队列统计信息 | [ ✅ / ❌ ] | |
| 测试4 | 队列优先级排序 | [ ✅ / ❌ ] | |
| 测试5 | VIP客户识别 | [ ✅ / ❌ ] | |
| 测试6 | 等待超时检测 | [ ✅ / ❌ ] | |
| 测试7 | 紧急关键词触发 | [ ✅ / ❌ ] | |
| 测试8 | 队列自动刷新 | [ ✅ / ❌ ] | |
| 测试9 | TypeScript检查 | [ ✅ / ❌ ] | |
| 测试10 | 回归测试套件 | [ ✅ / ❌ ] | |

### 前端UI验证

| UI元素 | 验证项 | 结果 | 截图 |
|--------|-------|------|------|
| 优先级标识 | VIP客户显示🔴+👑 | [ ✅ / ❌ ] | [ ] 已截图 |
| 优先级标识 | 关键词客户显示🟠 | [ ✅ / ❌ ] | [ ] 已截图 |
| 优先级标识 | urgent标识有动画 | [ ✅ / ❌ ] | [ ] 已录屏 |
| 队列统计 | 渐变橙色背景 | [ ✅ / ❌ ] | [ ] 已截图 |
| 队列统计 | 三个指标显示完整 | [ ✅ / ❌ ] | [ ] 已截图 |
| 队列统计 | 时间格式化正确 | [ ✅ / ❌ ] | |
| 队列统计 | 空队列时隐藏 | [ ✅ / ❌ ] | [ ] 已截图 |

### 发现的问题

| 问题编号 | 严重程度 | 问题描述 | 重现步骤 | 修复状态 |
|---------|---------|---------|---------|---------|
| M2-001 | [ P0 / P1 / P2 ] | (问题描述) | (步骤) | [ 待修复 / 已修复 ] |
| M2-002 | [ P0 / P1 / P2 ] | (问题描述) | (步骤) | [ 待修复 / 已修复 ] |

### 测试结论

**通过测试数**: ___/12

**核心功能状态**:
- [ ] ✅ 所有核心功能正常
- [ ] ⚠️ 部分功能有小问题但不影响使用
- [ ] ❌ 存在阻塞性问题需修复

**建议**:
- [ ] ✅ 可进入生产环境
- [ ] ⚠️ 需修复P1/P2问题后再上线
- [ ] ❌ 需修复P0问题后再测试

**签名**: _____________
**日期**: 2025-___-___

---

**文档版本**: v1.1 (修复版)
**最后更新**: 2025-01-27
**维护者**: Claude Code

如需要批量创建测试数据，可以使用以下Python脚本:

```python
#!/usr/bin/env python3
# create_test_data.py
import requests
import time

BASE_URL = "http://localhost:8000"

test_sessions = [
    {"session_name": "vip_urgent_001", "vip": True, "keywords": []},
    {"session_name": "normal_complaint_001", "vip": False, "keywords": ["投诉"]},
    {"session_name": "normal_refund_001", "vip": False, "keywords": ["退款"]},
    {"session_name": "normal_001", "vip": False, "keywords": []},
    {"session_name": "normal_002", "vip": False, "keywords": []},
]

for session in test_sessions:
    # 创建会话并触发人工升级
    response = requests.post(
        f"{BASE_URL}/api/manual/escalate",
        json={"session_name": session["session_name"], "reason": "manual"}
    )
    print(f"✅ 创建会话: {session['session_name']} - {response.status_code}")
    time.sleep(1)

print("\n✅ 测试数据创建完成！")
```

---

**文档版本**: v1.0
**最后更新**: 2025-01-27
