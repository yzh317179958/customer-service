# ç®¡ç†å‘˜åŠŸèƒ½å®æ–½æ–¹æ¡ˆè¯¦è§£

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¶é—´**: 2025-11-25
> **çŠ¶æ€**: ğŸ“‹ å¾…å®¡æ ¸
> **ä¾èµ–**: åå¸­è®¤è¯ç³»ç»Ÿ (v2.3.7+)
> **ä¼˜å…ˆçº§**: P1

---

## 1. ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåŠŸèƒ½ï¼Ÿ

### 1.1 å½“å‰é—®é¢˜

åå¸­è®¤è¯ç³»ç»Ÿ (v2.3.7) å·²å®ç°ï¼š
- âœ… åå¸­ç™»å½•/ç™»å‡º
- âœ… JWT Token è®¤è¯
- âœ… å¯†ç åŠ å¯†å­˜å‚¨ (bcrypt)
- âœ… 3ä¸ªé»˜è®¤è´¦å·ï¼ˆadmin, agent001, agent002ï¼‰

**å­˜åœ¨çš„é—®é¢˜**ï¼š
1. **æ— æ³•ç®¡ç†åå¸­è´¦å·** - åªæœ‰ç¡¬ç¼–ç çš„3ä¸ªè´¦å·ï¼Œæ— æ³•æ–°å¢åå¸­
2. **æ— æƒé™æ§åˆ¶** - æ‰€æœ‰APIéƒ½æ²¡æœ‰TokenéªŒè¯ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®
3. **æ— æ³•ä¿®æ”¹å¯†ç ** - åå¸­æ— æ³•ä¿®æ”¹è‡ªå·±çš„å¯†ç 
4. **æ— æ³•åˆ é™¤è´¦å·** - æµ‹è¯•è´¦å·æ— æ³•æ¸…ç†
5. **ç”Ÿäº§ç¯å¢ƒé£é™©** - é»˜è®¤è´¦å·å¿…é¡»åœ¨ç”Ÿäº§ç¯å¢ƒå‰åˆ é™¤æˆ–ä¿®æ”¹å¯†ç 

### 1.2 ä¸šåŠ¡åœºæ™¯

**åœºæ™¯1ï¼šæ–°åå¸­å…¥èŒ**
```
ç°çŠ¶ï¼šéœ€è¦å¼€å‘äººå‘˜ä¿®æ”¹ä»£ç æ·»åŠ è´¦å·
æœŸæœ›ï¼šç®¡ç†å‘˜åœ¨å·¥ä½œå°ç‚¹å‡»"æ–°å¢åå¸­"å³å¯åˆ›å»º
```

**åœºæ™¯2ï¼šåå¸­ç¦»èŒ**
```
ç°çŠ¶ï¼šè´¦å·æ— æ³•åˆ é™¤ï¼Œåªèƒ½ç¦ç”¨ç™»å½•
æœŸæœ›ï¼šç®¡ç†å‘˜åˆ é™¤è´¦å·ï¼Œæ¸…ç†æ•°æ®
```

**åœºæ™¯3ï¼šå¯†ç æ³„éœ²**
```
ç°çŠ¶ï¼šéœ€è¦å¼€å‘äººå‘˜é‡ç½®å¯†ç 
æœŸæœ›ï¼šç®¡ç†å‘˜/åå¸­è‡ªå·±é‡ç½®å¯†ç 
```

**åœºæ™¯4ï¼šæƒé™ç®¡ç†**
```
ç°çŠ¶ï¼šæ‰€æœ‰APIæ— æƒé™éªŒè¯
æœŸæœ›ï¼šJWTä¸­é—´ä»¶è‡ªåŠ¨éªŒè¯æƒé™
```

### 1.3 ä¸šåŠ¡ä»·å€¼

| ç»´åº¦ | ä»·å€¼ | é‡åŒ–æŒ‡æ ‡ |
|------|------|----------|
| **è¿ç»´æ•ˆç‡** | å‡å°‘äººå·¥å¹²é¢„ | è´¦å·ç®¡ç†æ—¶é—´ä»30åˆ†é’Ÿé™è‡³2åˆ†é’Ÿ |
| **å®‰å…¨æ€§** | æƒé™æ§åˆ¶ + å®¡è®¡æ—¥å¿— | é¿å…æœªæˆæƒè®¿é—® |
| **ç”¨æˆ·ä½“éªŒ** | è‡ªåŠ©ä¿®æ”¹å¯†ç  | æå‡åå¸­æ»¡æ„åº¦ |
| **åˆè§„æ€§** | æ»¡è¶³ä¼ä¸šå®‰å…¨è§„èŒƒ | æ»¡è¶³ISO 27001è¦æ±‚ |

---

## 2. æŠ€æœ¯åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

### 2.1 æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åå¸­å·¥ä½œå°å‰ç«¯ (Vue 3)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ç™»å½•é¡µé¢  â”‚  â”‚ ç®¡ç†é¡µé¢  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTP + JWT Token
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      FastAPI åç«¯ (backend.py)       â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  JWT æƒé™ä¸­é—´ä»¶                 â”‚ â”‚
â”‚  â”‚  verify_agent_token()          â”‚ â”‚
â”‚  â”‚  require_admin()               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â†“                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ç®¡ç†å‘˜ API                     â”‚ â”‚
â”‚  â”‚  /api/agents (CRUD)            â”‚ â”‚
â”‚  â”‚  /api/agents/{username}/reset  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â†“                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  AgentManager                  â”‚ â”‚
â”‚  â”‚  (src/agent_auth.py)           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â†“                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Redis å­˜å‚¨                  â”‚
â”‚  agent:admin â†’ {...}                â”‚
â”‚  agent:agent001 â†’ {...}             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 JWT æƒé™éªŒè¯åŸç†

```python
# 1. ç™»å½•æ—¶ç”Ÿæˆ Token
Token Payload = {
    "agent_id": "agent_001",
    "username": "admin",
    "role": "admin",        # â† å…³é”®å­—æ®µ
    "exp": 1737001200,      # 1å°æ—¶åè¿‡æœŸ
    "iat": 1737000000
}

# 2. è¯·æ±‚æ—¶éªŒè¯ Token
Authorization: Bearer eyJhbGci...
                     â†“
            JWT.verify(token, secret_key)
                     â†“
             æå– payload.role
                     â†“
         â”Œâ”€â”€â”€â”€ role == "admin" â”€â”€â”€â”€â”
         â†“ YES                      â†“ NO
    å…è®¸è®¿é—®ç®¡ç†æ¥å£          è¿”å› 403 Forbidden
```

### 2.3 æƒé™åˆ†çº§

| è§’è‰² | æƒé™ | API è®¿é—®èŒƒå›´ |
|------|------|-------------|
| **admin** | ç®¡ç†å‘˜ | æ‰€æœ‰ API + ç®¡ç†åŠŸèƒ½ |
| **agent** | æ™®é€šåå¸­ | å·¥ä½œå° API + ä¿®æ”¹è‡ªå·±å¯†ç  |
| **æœªç™»å½•** | - | ä»…ç™»å½•æ¥å£ |

---

## 3. éœ€è¦ä»€ä¹ˆå·¥å…·å’Œé…ç½®ï¼Ÿ

### 3.1 ä¾èµ–åº“

å·²å®‰è£…ï¼ˆåœ¨ requirements.txt ä¸­ï¼‰ï¼š
```bash
PyJWT>=2.8.0          # JWT Token ç”Ÿæˆå’ŒéªŒè¯
bcrypt>=4.0.1         # å¯†ç åŠ å¯†
redis>=5.0.0          # æ•°æ®å­˜å‚¨
pydantic>=2.0.0       # æ•°æ®éªŒè¯
fastapi>=0.104.0      # Web æ¡†æ¶
```

**æ— éœ€å®‰è£…æ–°ä¾èµ–ï¼æ‰€æœ‰åŠŸèƒ½ä½¿ç”¨ç°æœ‰åº“å®ç°ã€‚**

### 3.2 ç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼š

```bash
# JWT é…ç½®
JWT_SECRET_KEY=your_secret_key_at_least_32_characters_long_for_security
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=60      # Access Token æœ‰æ•ˆæœŸï¼ˆ1å°æ—¶ï¼‰
JWT_REFRESH_TOKEN_EXPIRE_DAYS=7        # Refresh Token æœ‰æ•ˆæœŸï¼ˆ7å¤©ï¼‰

# é»˜è®¤ç®¡ç†å‘˜å¯†ç ï¼ˆâš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼‰
DEFAULT_ADMIN_PASSWORD=admin123
```

**å®‰å…¨å»ºè®®**ï¼š
- JWT_SECRET_KEY è‡³å°‘32å­—ç¬¦
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨éšæœºç”Ÿæˆçš„å¼ºå¯†é’¥ï¼š
  ```bash
  python3 -c "import secrets; print(secrets.token_urlsafe(32))"
  ```

### 3.3 Redis æ•°æ®ç»“æ„

```
# åå¸­è´¦å·å­˜å‚¨
Key: agent:{username}
Value: {
  "id": "agent_xxx",
  "username": "admin",
  "password_hash": "$2b$12$...",
  "name": "ç³»ç»Ÿç®¡ç†å‘˜",
  "role": "admin",
  "status": "offline",
  "max_sessions": 10,
  "created_at": 1737000000.0,
  "last_login": 1737001000.0
}
TTL: 31536000 ç§’ (1å¹´)

# å®¡è®¡æ—¥å¿—ï¼ˆå¯é€‰ï¼ŒP2å®ç°ï¼‰
Key: agent_audit:{username}:{action}:{timestamp}
Value: {"action": "create", "operator": "admin", "details": "..."}
TTL: 2592000 ç§’ (30å¤©)
```

---

## 4. å¦‚ä½•å®ç°ï¼Ÿï¼ˆè¯¦ç»†æ­¥éª¤ï¼‰

### 4.1 é˜¶æ®µ1ï¼šJWT æƒé™ä¸­é—´ä»¶ï¼ˆæ ¸å¿ƒåŸºç¡€ï¼‰

**æ–‡ä»¶**: `backend.py`

**æ­¥éª¤1**: å¯¼å…¥ä¾èµ–

```python
from fastapi import Depends, HTTPException
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from src.agent_auth import AgentTokenManager

# åˆå§‹åŒ–
security = HTTPBearer()
agent_token_manager = AgentTokenManager(
    secret_key=os.getenv("JWT_SECRET_KEY", "dev_secret_key"),
    algorithm="HS256"
)
```

**æ­¥éª¤2**: åˆ›å»ºéªŒè¯ä¾èµ–

```python
async def verify_agent_token(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> Dict[str, Any]:
    """
    éªŒè¯ JWT Token

    è¿”å›: Token è½½è· (agent_id, username, role)
    å¼‚å¸¸: HTTPException 401 (Token æ— æ•ˆæˆ–è¿‡æœŸ)
    """
    token = credentials.credentials

    # éªŒè¯ Token
    payload = agent_token_manager.verify_token(token)
    if not payload:
        raise HTTPException(
            status_code=401,
            detail="Token æ— æ•ˆæˆ–å·²è¿‡æœŸ"
        )

    return payload


async def require_admin(
    agent: Dict[str, Any] = Depends(verify_agent_token)
) -> Dict[str, Any]:
    """
    è¦æ±‚ç®¡ç†å‘˜æƒé™

    è¿”å›: Token è½½è·
    å¼‚å¸¸: HTTPException 403 (æƒé™ä¸è¶³)
    """
    if agent.get("role") != "admin":
        raise HTTPException(
            status_code=403,
            detail="éœ€è¦ç®¡ç†å‘˜æƒé™"
        )

    return agent


async def require_agent(
    agent: Dict[str, Any] = Depends(verify_agent_token)
) -> Dict[str, Any]:
    """
    è¦æ±‚åå¸­æƒé™ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰

    è¿”å›: Token è½½è·
    """
    return agent
```

**æ­¥éª¤3**: åº”ç”¨åˆ°ç°æœ‰APIï¼ˆç¤ºä¾‹ï¼‰

```python
# âœ… ä¿æŠ¤åå¸­å·¥ä½œå° API
@app.get("/api/sessions")
async def get_sessions(
    status: Optional[str] = None,
    agent: Dict = Depends(require_agent)  # â† æ·»åŠ æƒé™éªŒè¯
):
    """è·å–ä¼šè¯åˆ—è¡¨ - éœ€è¦åå¸­æƒé™"""
    # ... ç°æœ‰é€»è¾‘ ...
    pass


@app.post("/api/sessions/{session_name}/takeover")
async def takeover_session(
    session_name: str,
    request: dict,
    agent: Dict = Depends(require_agent)  # â† æ·»åŠ æƒé™éªŒè¯
):
    """æ¥å…¥ä¼šè¯ - éœ€è¦åå¸­æƒé™"""
    # ä½¿ç”¨ agent ä¿¡æ¯
    agent_id = agent["agent_id"]
    agent_name = agent["username"]
    # ... ç°æœ‰é€»è¾‘ ...
    pass
```

**éªŒè¯**: æ—  Token è¯·æ±‚åº”è¿”å› 401

```bash
curl -X GET http://localhost:8000/api/sessions
# å“åº”: {"detail": "Not authenticated"}
```

---

### 4.2 é˜¶æ®µ2ï¼šåå¸­åˆ—è¡¨æŸ¥è¯¢ï¼ˆADMIN-02ï¼‰

**API æ¥å£**: `GET /api/agents`

**å®ç°ä»£ç **:

```python
@app.get("/api/agents")
async def get_agents(
    status: Optional[str] = None,
    role: Optional[str] = None,
    page: int = Query(default=1, ge=1),
    page_size: int = Query(default=20, ge=1, le=100),
    admin: Dict = Depends(require_admin)  # â† ä»…ç®¡ç†å‘˜å¯è®¿é—®
):
    """
    è·å–åå¸­åˆ—è¡¨

    Query å‚æ•°:
    - status: è¿‡æ»¤çŠ¶æ€ (online/offline/busy)
    - role: è¿‡æ»¤è§’è‰² (admin/agent)
    - page: é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
    - page_size: æ¯é¡µæ•°é‡ï¼ˆæœ€å¤§100ï¼‰

    æƒé™: ç®¡ç†å‘˜
    """
    if not agent_manager:
        raise HTTPException(503, detail="AgentManager æœªåˆå§‹åŒ–")

    try:
        # è·å–æ‰€æœ‰åå¸­
        agents = await agent_manager.list_agents()

        # è¿‡æ»¤
        if status:
            agents = [a for a in agents if a.status == status]
        if role:
            agents = [a for a in agents if a.role == role]

        # åˆ†é¡µ
        total = len(agents)
        start = (page - 1) * page_size
        end = start + page_size
        items = agents[start:end]

        # ç§»é™¤å¯†ç å­—æ®µ
        items_dict = [agent_to_dict_safe(a) for a in items]

        return {
            "success": True,
            "data": {
                "items": items_dict,
                "total": total,
                "page": page,
                "page_size": page_size
            }
        }
    except Exception as e:
        logger.error(f"è·å–åå¸­åˆ—è¡¨å¤±è´¥: {e}")
        raise HTTPException(500, detail="è·å–åå¸­åˆ—è¡¨å¤±è´¥")


def agent_to_dict_safe(agent: Agent) -> Dict:
    """ç§»é™¤æ•æ„Ÿå­—æ®µ"""
    data = agent.dict()
    data.pop("password_hash", None)  # ç§»é™¤å¯†ç 
    return data
```

**æµ‹è¯•å‘½ä»¤**:

```bash
# 1. ç®¡ç†å‘˜ç™»å½•è·å– Token
TOKEN=$(curl -s -X POST http://localhost:8000/api/agent/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | jq -r '.token')

# 2. è·å–åå¸­åˆ—è¡¨
curl -X GET "http://localhost:8000/api/agents?page=1&page_size=20" \
  -H "Authorization: Bearer $TOKEN"

# é¢„æœŸå“åº”:
# {
#   "success": true,
#   "data": {
#     "items": [
#       {"id": "...", "username": "admin", "name": "ç³»ç»Ÿç®¡ç†å‘˜", ...},
#       {"id": "...", "username": "agent001", "name": "æµ‹è¯•åå¸­1", ...}
#     ],
#     "total": 3,
#     "page": 1,
#     "page_size": 20
#   }
# }
```

---

### 4.3 é˜¶æ®µ3ï¼šåˆ›å»ºåå¸­è´¦å·ï¼ˆADMIN-03ï¼‰

**API æ¥å£**: `POST /api/agents`

**è¯·æ±‚æ ¼å¼**:

```json
{
  "username": "agent003",
  "password": "agent003_pass",
  "name": "å¼ ä¸‰",
  "role": "agent",
  "max_sessions": 5
}
```

**å®ç°ä»£ç **:

```python
class CreateAgentRequest(BaseModel):
    username: str = Field(..., min_length=3, max_length=50, pattern="^[a-zA-Z0-9_]+$")
    password: str = Field(..., min_length=8)
    name: str = Field(..., min_length=1, max_length=100)
    role: AgentRole = AgentRole.AGENT
    max_sessions: int = Field(default=5, ge=1, le=50)


@app.post("/api/agents")
async def create_agent(
    request: CreateAgentRequest,
    admin: Dict = Depends(require_admin)
):
    """
    åˆ›å»ºåå¸­è´¦å·

    æƒé™: ç®¡ç†å‘˜
    """
    if not agent_manager:
        raise HTTPException(503, detail="AgentManager æœªåˆå§‹åŒ–")

    try:
        # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        existing = await agent_manager.get_agent(request.username)
        if existing:
            raise HTTPException(409, detail=f"ç”¨æˆ·å {request.username} å·²å­˜åœ¨")

        # åˆ›å»ºè´¦å·
        agent = await agent_manager.create_agent(
            username=request.username,
            password=request.password,
            name=request.name,
            role=request.role,
            max_sessions=request.max_sessions
        )

        # è®°å½•å®¡è®¡æ—¥å¿—
        logger.info(f"âœ… ç®¡ç†å‘˜ {admin['username']} åˆ›å»ºåå¸­: {request.username}")

        return {
            "success": True,
            "data": agent_to_dict_safe(agent)
        }
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"åˆ›å»ºåå¸­å¤±è´¥: {e}")
        raise HTTPException(500, detail="åˆ›å»ºåå¸­å¤±è´¥")
```

**æµ‹è¯•å‘½ä»¤**:

```bash
curl -X POST http://localhost:8000/api/agents \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "agent003",
    "password": "test123456",
    "name": "å¼ ä¸‰",
    "role": "agent",
    "max_sessions": 5
  }'

# é¢„æœŸå“åº”:
# {
#   "success": true,
#   "data": {
#     "id": "agent_xxx",
#     "username": "agent003",
#     "name": "å¼ ä¸‰",
#     "role": "agent",
#     ...
#   }
# }
```

---

### 4.4 é˜¶æ®µ4ï¼šä¿®æ”¹åå¸­ä¿¡æ¯ï¼ˆADMIN-04ï¼‰

**API æ¥å£**: `PUT /api/agents/{username}`

**è¯·æ±‚æ ¼å¼**:

```json
{
  "name": "æå››",
  "role": "admin",
  "max_sessions": 10,
  "status": "online"
}
```

**å®ç°ä»£ç **:

```python
class UpdateAgentRequest(BaseModel):
    name: Optional[str] = Field(None, min_length=1, max_length=100)
    role: Optional[AgentRole] = None
    max_sessions: Optional[int] = Field(None, ge=1, le=50)
    status: Optional[AgentStatus] = None


@app.put("/api/agents/{username}")
async def update_agent(
    username: str,
    request: UpdateAgentRequest,
    admin: Dict = Depends(require_admin)
):
    """
    ä¿®æ”¹åå¸­ä¿¡æ¯

    æƒé™: ç®¡ç†å‘˜
    """
    if not agent_manager:
        raise HTTPException(503, detail="AgentManager æœªåˆå§‹åŒ–")

    try:
        # è·å–ç°æœ‰è´¦å·
        agent = await agent_manager.get_agent(username)
        if not agent:
            raise HTTPException(404, detail=f"åå¸­ {username} ä¸å­˜åœ¨")

        # æ›´æ–°å­—æ®µ
        if request.name is not None:
            agent.name = request.name
        if request.role is not None:
            agent.role = request.role
        if request.max_sessions is not None:
            agent.max_sessions = request.max_sessions
        if request.status is not None:
            agent.status = request.status

        # ä¿å­˜
        await agent_manager.update_agent(agent)

        logger.info(f"âœ… ç®¡ç†å‘˜ {admin['username']} ä¿®æ”¹åå¸­: {username}")

        return {
            "success": True,
            "data": agent_to_dict_safe(agent)
        }
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"ä¿®æ”¹åå¸­å¤±è´¥: {e}")
        raise HTTPException(500, detail="ä¿®æ”¹åå¸­å¤±è´¥")
```

**æµ‹è¯•å‘½ä»¤**:

```bash
curl -X PUT http://localhost:8000/api/agents/agent003 \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æå››",
    "max_sessions": 10
  }'
```

---

### 4.5 é˜¶æ®µ5ï¼šåˆ é™¤åå¸­è´¦å·ï¼ˆADMIN-05ï¼‰

**API æ¥å£**: `DELETE /api/agents/{username}`

**å®ç°ä»£ç **:

```python
@app.delete("/api/agents/{username}")
async def delete_agent(
    username: str,
    admin: Dict = Depends(require_admin)
):
    """
    åˆ é™¤åå¸­è´¦å·

    æƒé™: ç®¡ç†å‘˜
    æ³¨æ„: ä¸èƒ½åˆ é™¤è‡ªå·±çš„è´¦å·
    """
    if not agent_manager:
        raise HTTPException(503, detail="AgentManager æœªåˆå§‹åŒ–")

    try:
        # ä¸èƒ½åˆ é™¤è‡ªå·±
        if username == admin["username"]:
            raise HTTPException(400, detail="ä¸èƒ½åˆ é™¤è‡ªå·±çš„è´¦å·")

        # æ£€æŸ¥è´¦å·æ˜¯å¦å­˜åœ¨
        agent = await agent_manager.get_agent(username)
        if not agent:
            raise HTTPException(404, detail=f"åå¸­ {username} ä¸å­˜åœ¨")

        # åˆ é™¤
        await agent_manager.delete_agent(username)

        logger.info(f"âœ… ç®¡ç†å‘˜ {admin['username']} åˆ é™¤åå¸­: {username}")

        return {
            "success": True,
            "message": f"åå¸­ {username} å·²åˆ é™¤"
        }
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"åˆ é™¤åå¸­å¤±è´¥: {e}")
        raise HTTPException(500, detail="åˆ é™¤åå¸­å¤±è´¥")
```

**æµ‹è¯•å‘½ä»¤**:

```bash
curl -X DELETE http://localhost:8000/api/agents/agent003 \
  -H "Authorization: Bearer $TOKEN"

# é¢„æœŸå“åº”:
# {"success": true, "message": "åå¸­ agent003 å·²åˆ é™¤"}
```

---

### 4.6 é˜¶æ®µ6ï¼šé‡ç½®åå¸­å¯†ç ï¼ˆADMIN-06ï¼‰

**API æ¥å£**: `POST /api/agents/{username}/reset-password`

**è¯·æ±‚æ ¼å¼**:

```json
{
  "new_password": "new_password_123"
}
```

**å®ç°ä»£ç **:

```python
class ResetPasswordRequest(BaseModel):
    new_password: str = Field(..., min_length=8)


@app.post("/api/agents/{username}/reset-password")
async def reset_agent_password(
    username: str,
    request: ResetPasswordRequest,
    admin: Dict = Depends(require_admin)
):
    """
    é‡ç½®åå¸­å¯†ç 

    æƒé™: ç®¡ç†å‘˜
    """
    if not agent_manager:
        raise HTTPException(503, detail="AgentManager æœªåˆå§‹åŒ–")

    try:
        # æ£€æŸ¥è´¦å·æ˜¯å¦å­˜åœ¨
        agent = await agent_manager.get_agent(username)
        if not agent:
            raise HTTPException(404, detail=f"åå¸­ {username} ä¸å­˜åœ¨")

        # é‡ç½®å¯†ç 
        from src.agent_auth import PasswordHasher
        agent.password_hash = PasswordHasher.hash_password(request.new_password)

        # ä¿å­˜
        await agent_manager.update_agent(agent)

        logger.info(f"âœ… ç®¡ç†å‘˜ {admin['username']} é‡ç½®åå¸­å¯†ç : {username}")

        return {
            "success": True,
            "message": f"åå¸­ {username} å¯†ç å·²é‡ç½®"
        }
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"é‡ç½®å¯†ç å¤±è´¥: {e}")
        raise HTTPException(500, detail="é‡ç½®å¯†ç å¤±è´¥")
```

**æµ‹è¯•å‘½ä»¤**:

```bash
curl -X POST http://localhost:8000/api/agents/agent001/reset-password \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "new_password": "new_pass_123"
  }'
```

---

## 5. æœ€ç»ˆæ•ˆæœæ˜¯ä»€ä¹ˆï¼Ÿ

### 5.1 Before/After å¯¹æ¯”

| åœºæ™¯ | Beforeï¼ˆç°çŠ¶ï¼‰ | Afterï¼ˆå®ç°åï¼‰ |
|------|---------------|----------------|
| **æ–°å¢åå¸­** | ä¿®æ”¹ä»£ç  + é‡å¯æœåŠ¡ï¼ˆ30åˆ†é’Ÿï¼‰ | å·¥ä½œå°ç‚¹å‡»"æ–°å¢"ï¼ˆ2åˆ†é’Ÿï¼‰ |
| **åˆ é™¤åå¸­** | æ— æ³•åˆ é™¤ï¼Œåªèƒ½ç¦ç”¨ | ç®¡ç†å‘˜ç‚¹å‡»"åˆ é™¤"å³å¯ |
| **é‡ç½®å¯†ç ** | æ‰¾å¼€å‘äººå‘˜å¸®åŠ© | ç®¡ç†å‘˜/è‡ªå·±é‡ç½® |
| **API å®‰å…¨** | æ— æƒé™éªŒè¯ï¼Œä»»ä½•äººå¯è®¿é—® | JWT è‡ªåŠ¨éªŒè¯æƒé™ |
| **æƒé™ç®¡ç†** | æ‰‹åŠ¨æ£€æŸ¥è§’è‰² | ä¸­é—´ä»¶è‡ªåŠ¨æ‹¦æˆª |

### 5.2 API å®Œæ•´æ¸…å•

| æ¥å£ | æ–¹æ³• | æƒé™ | åŠŸèƒ½ |
|------|------|------|------|
| `/api/agents` | GET | admin | è·å–åå¸­åˆ—è¡¨ |
| `/api/agents` | POST | admin | åˆ›å»ºåå¸­ |
| `/api/agents/{username}` | PUT | admin | ä¿®æ”¹åå¸­ä¿¡æ¯ |
| `/api/agents/{username}` | DELETE | admin | åˆ é™¤åå¸­ |
| `/api/agents/{username}/reset-password` | POST | admin | é‡ç½®å¯†ç  |
| `/api/sessions` | GET | agent | è·å–ä¼šè¯åˆ—è¡¨ï¼ˆå—ä¿æŠ¤ï¼‰|
| `/api/sessions/{id}/takeover` | POST | agent | æ¥å…¥ä¼šè¯ï¼ˆå—ä¿æŠ¤ï¼‰|

### 5.3 éªŒè¯æ ‡å‡†

**åŠŸèƒ½éªŒè¯**:
- [ ] ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºæ–°åå¸­
- [ ] ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹åå¸­ä¿¡æ¯
- [ ] ç®¡ç†å‘˜å¯ä»¥åˆ é™¤åå¸­ï¼ˆä¸èƒ½åˆ é™¤è‡ªå·±ï¼‰
- [ ] ç®¡ç†å‘˜å¯ä»¥é‡ç½®åå¸­å¯†ç 
- [ ] ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰åå¸­åˆ—è¡¨
- [ ] æ™®é€šåå¸­è®¿é—®ç®¡ç†æ¥å£è¿”å› 403
- [ ] æ—  Token è®¿é—®å—ä¿æŠ¤æ¥å£è¿”å› 401
- [ ] è¿‡æœŸ Token è¿”å› 401

**å®‰å…¨éªŒè¯**:
- [ ] å¯†ç å­—æ®µä¸è¿”å›ç»™å‰ç«¯
- [ ] JWT Token æœ‰è¿‡æœŸæ—¶é—´ï¼ˆ1å°æ—¶ï¼‰
- [ ] ä½¿ç”¨ bcrypt åŠ å¯†å¯†ç 
- [ ] ç®¡ç†æ“ä½œè®°å½•æ—¥å¿—

**æ€§èƒ½éªŒè¯**:
- [ ] åå¸­åˆ—è¡¨æŸ¥è¯¢ < 200ms
- [ ] åˆ›å»ºåå¸­ < 500ms
- [ ] Token éªŒè¯ < 50ms

---

## 6. å®æ–½æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | éš¾åº¦ |
|------|------|----------|------|
| 1 | JWT æƒé™ä¸­é—´ä»¶ | 1å°æ—¶ | â­â­ |
| 2 | åå¸­åˆ—è¡¨æŸ¥è¯¢ | 0.5å°æ—¶ | â­ |
| 3 | åˆ›å»ºåå¸­è´¦å· | 1å°æ—¶ | â­â­ |
| 4 | ä¿®æ”¹åå¸­ä¿¡æ¯ | 0.5å°æ—¶ | â­ |
| 5 | åˆ é™¤åå¸­è´¦å· | 0.5å°æ—¶ | â­ |
| 6 | é‡ç½®åå¸­å¯†ç  | 0.5å°æ—¶ | â­ |
| 7 | æµ‹è¯•éªŒè¯ | 1å°æ—¶ | â­â­ |
| 8 | æ–‡æ¡£æ›´æ–° | 0.5å°æ—¶ | â­ |

**æ€»è®¡**: çº¦5.5å°æ—¶ï¼ˆä¸å«å‰ç«¯UIå¼€å‘ï¼‰

---

## 7. å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ OAuth 2.0ï¼Ÿ

**A**: åå¸­è®¤è¯æ˜¯å†…éƒ¨ç³»ç»Ÿï¼Œä¸éœ€è¦ç¬¬ä¸‰æ–¹æˆæƒï¼ŒJWT å·²è¶³å¤Ÿã€‚OAuth 2.0 å¢åŠ å¤æ‚åº¦ã€‚

### Q2: Token è¿‡æœŸåæ€ä¹ˆåŠï¼Ÿ

**A**: ä½¿ç”¨ Refresh Token åˆ·æ–°ï¼ˆå·²åœ¨ v2.3.7 å®ç°ï¼‰ï¼š
```bash
POST /api/agent/refresh
Body: {"refresh_token": "..."}
å“åº”: {"token": "new_access_token", ...}
```

### Q3: å¦‚ä½•é˜²æ­¢æš´åŠ›ç ´è§£ï¼Ÿ

**A**:
- ä½¿ç”¨ bcrypt åŠ å¯†ï¼ˆè‡ªåŠ¨åŠ ç›ï¼Œè®¡ç®—æ…¢ï¼‰
- å»ºè®®æ·»åŠ ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶ï¼ˆP2åŠŸèƒ½ï¼‰
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS

### Q4: åå¸­åˆ é™¤åæ•°æ®æ€ä¹ˆåŠï¼Ÿ

**A**:
- åå¸­è´¦å·æ•°æ®ç«‹å³åˆ é™¤
- å†å²ä¼šè¯æ•°æ®ä¿ç•™ï¼ˆä¸å…³è”åå¸­è´¦å·ï¼‰
- å®¡è®¡æ—¥å¿—ä¿ç•™30å¤©

### Q5: ç®¡ç†å‘˜è´¦å·è¢«åˆ é™¤äº†æ€ä¹ˆåŠï¼Ÿ

**A**:
- ç³»ç»Ÿé˜»æ­¢åˆ é™¤è‡ªå·±çš„è´¦å·
- å¦‚æœå”¯ä¸€ç®¡ç†å‘˜è¢«è¯¯åˆ ï¼Œéœ€è¦é€šè¿‡æ•°æ®åº“æ¢å¤æˆ–åˆ›å»ºæ–°ç®¡ç†å‘˜

### Q6: æ™®é€šåå¸­å¯ä»¥ä¿®æ”¹è‡ªå·±çš„å¯†ç å—ï¼Ÿ

**A**: P1 é˜¶æ®µä¼šå®ç°ï¼ˆADMIN-07ï¼‰ï¼Œå½“å‰åªèƒ½ç®¡ç†å‘˜é‡ç½®ã€‚

---

## 8. é£é™©ä¸æ³¨æ„äº‹é¡¹

### 8.1 å®‰å…¨é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| JWT å¯†é’¥æ³„éœ² | Token å¯è¢«ä¼ªé€  | ä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼ˆ32+å­—ç¬¦ï¼‰|
| é»˜è®¤å¯†ç æœªä¿®æ”¹ | è´¦å·è¢«å…¥ä¾µ | éƒ¨ç½²æ£€æŸ¥æ¸…å• + å¼ºåˆ¶ä¿®æ”¹ |
| Token è¢«çªƒå– | æœªæˆæƒè®¿é—® | çŸ­è¿‡æœŸæ—¶é—´ï¼ˆ1å°æ—¶ï¼‰+ HTTPS |
| SQL æ³¨å…¥ | æ•°æ®æ³„éœ² | ä½¿ç”¨ Pydantic éªŒè¯è¾“å…¥ |

### 8.2 å…¼å®¹æ€§é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| ç°æœ‰ API éœ€è¦æ”¹é€  | å‰ç«¯ç™»å½•å¤±æ•ˆ | åˆ†é˜¶æ®µæ·»åŠ æƒé™éªŒè¯ |
| å‰ç«¯æœªä¼  Token | API è°ƒç”¨å¤±è´¥ | å‰ç«¯ç»Ÿä¸€æ·»åŠ  Authorization Header |
| Token æ ¼å¼ä¸å…¼å®¹ | è®¤è¯å¤±è´¥ | ä½¿ç”¨æ ‡å‡† JWT æ ¼å¼ |

### 8.3 æ•°æ®é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| Redis æ•°æ®ä¸¢å¤± | æ‰€æœ‰è´¦å·ä¸¢å¤± | Redis æŒä¹…åŒ– + å®šæœŸå¤‡ä»½ |
| åå¸­è¯¯åˆ é™¤ | æ•°æ®æ— æ³•æ¢å¤ | æ·»åŠ ç¡®è®¤æç¤º + å®¡è®¡æ—¥å¿— |

---

## 9. éƒ¨ç½²æ£€æŸ¥æ¸…å•

### 9.1 å¼€å‘ç¯å¢ƒ

- [ ] å®‰è£…ä¾èµ–åº“ï¼ˆPyJWT, bcryptï¼‰
- [ ] é…ç½® .env æ–‡ä»¶ï¼ˆJWT_SECRET_KEYï¼‰
- [ ] å¯åŠ¨ Redis æœåŠ¡
- [ ] è¿è¡ŒåŸºçº¿æµ‹è¯•ï¼ˆç¡®ä¿ç°æœ‰åŠŸèƒ½æ­£å¸¸ï¼‰

### 9.2 ç”Ÿäº§ç¯å¢ƒ

- [ ] âš ï¸ **ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç **ï¼ˆadmin/admin123ï¼‰
- [ ] âš ï¸ **ç”Ÿæˆå¼ºéšæœº JWT å¯†é’¥**ï¼ˆ32+å­—ç¬¦ï¼‰
- [ ] å¯ç”¨ HTTPSï¼ˆé¿å… Token è¢«çªƒå–ï¼‰
- [ ] é…ç½® Redis æŒä¹…åŒ–ï¼ˆRDB + AOFï¼‰
- [ ] è®¾ç½®å¤‡ä»½ç­–ç•¥ï¼ˆæ¯æ—¥å¤‡ä»½åå¸­æ•°æ®ï¼‰
- [ ] é…ç½®æ—¥å¿—è®°å½•ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰
- [ ] é™åˆ¶ Redis è®¿é—®ï¼ˆé˜²ç«å¢™ + å¯†ç ï¼‰

### 9.3 æµ‹è¯•ç¯å¢ƒ

- [ ] åˆ›å»ºæµ‹è¯•åå¸­è´¦å·
- [ ] éªŒè¯æƒé™æ§åˆ¶ï¼ˆadmin vs agentï¼‰
- [ ] éªŒè¯ Token è¿‡æœŸæœºåˆ¶
- [ ] éªŒè¯å¯†ç ä¿®æ”¹åŠŸèƒ½
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆ100+ å¹¶å‘è¯·æ±‚ï¼‰

---

## 10. åç»­æ‰©å±•

### P1 åŠŸèƒ½ï¼ˆä¸‹ä¸€è¿­ä»£ï¼‰

- **ADMIN-07**: åå¸­ä¿®æ”¹è‡ªå·±å¯†ç 
- **ADMIN-08**: åå¸­ä¿®æ”¹ä¸ªäººèµ„æ–™

### P2 åŠŸèƒ½ï¼ˆå¾…å®šï¼‰

- **ADMIN-09**: å®¡è®¡æ—¥å¿—æŸ¥è¯¢
  - è®°å½•æ‰€æœ‰ç®¡ç†æ“ä½œï¼ˆåˆ›å»º/ä¿®æ”¹/åˆ é™¤ï¼‰
  - æ”¯æŒæŒ‰æ—¶é—´/æ“ä½œ/åå¸­æŸ¥è¯¢
  - æ”¯æŒå¯¼å‡ºå®¡è®¡æŠ¥å‘Š

- **ADMIN-10**: æ‰¹é‡å¯¼å…¥åå¸­
  - CSV æ–‡ä»¶ä¸Šä¼ 
  - æ‰¹é‡åˆ›å»ºåå¸­è´¦å·
  - è‡ªåŠ¨ç”Ÿæˆéšæœºå¯†ç 

- **ADMIN-11**: åå¸­çŠ¶æ€ç›‘æ§
  - å®æ—¶æ˜¾ç¤ºåœ¨çº¿/ç¦»çº¿/å¿™ç¢ŒçŠ¶æ€
  - å½“å‰æœåŠ¡ä¼šè¯æ•°
  - å¹³å‡å“åº”æ—¶é—´

---

## 11. å‚è€ƒæ–‡æ¡£

### å†…éƒ¨æ–‡æ¡£

- `prd/02_çº¦æŸä¸åŸåˆ™/CONSTRAINTS_AND_PRINCIPLES.md` - çº¦æŸ17ï¼ˆåå¸­è®¤è¯ï¼‰
- `prd/04_ä»»åŠ¡æ‹†è§£/admin_management_tasks.md` - ä»»åŠ¡æ‹†è§£
- `src/agent_auth.py` - åå¸­è®¤è¯ç³»ç»Ÿå®ç°

### å¤–éƒ¨æ–‡æ¡£

- [PyJWT Documentation](https://pyjwt.readthedocs.io/)
- [bcrypt Documentation](https://github.com/pyca/bcrypt/)
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Claude Code
**æœ€åæ›´æ–°**: 2025-11-25
**å®¡æ ¸çŠ¶æ€**: ğŸ“‹ å¾…å®¡æ ¸
