# Chat History Storage - Tech Stack (Cross-module)

> **Feature**: Chat History Storage & Retrieval  
> **Created**: 2026-01-07  
> **Last Updated**: 2026-01-07  
> **Modules**: `products/ai_chatbot`, `products/agent_workbench`, `services/session`, `infrastructure/database`, `infrastructure/scheduler`

---

## 1. Reuse Existing Stack

| Layer | Tech | Usage |
|------|------|-------|
| Backend | FastAPI | Workbench history APIs |
| Backend | Python 3.x | Message persistence service |
| ORM | SQLAlchemy (sync) | DB access via `get_db_session()` |
| Storage | PostgreSQL | Persist chat messages |
| Cache/State | Redis | Session state (existing, not source-of-truth for history) |
| Frontend | React + TypeScript (Vite) | Workbench UI |

## 2. New Dependencies

None. Use PostgreSQL built-in full-text search for “strong search”.

---

## 3. Storage Design (PostgreSQL)

### 3.1 Table: `chat_messages`

Timestamp convention:
- Use Unix timestamp seconds (`float`) for `created_at` to match existing DB models (e.g., `SessionArchiveModel`, audit/email models).

Schema (conceptual):

| Column | Type | Notes |
|--------|------|------|
| `id` | BIGSERIAL PK | Internal row id |
| `message_id` | VARCHAR(36) UNIQUE | UUID string for idempotency |
| `session_name` | VARCHAR(200) NOT NULL | Stable session identifier |
| `conversation_id` | VARCHAR(100) NULL | Coze conversation id (may be NULL) |
| `role` | VARCHAR(20) NOT NULL | `user` / `assistant` / `agent` |
| `content` | TEXT NOT NULL | Message content |
| `agent_id` | VARCHAR(100) NULL | Only for `role=agent` |
| `agent_name` | VARCHAR(100) NULL | Only for `role=agent` |
| `response_time_ms` | INTEGER NULL | Only for `role=assistant` |
| `created_at` | FLOAT NOT NULL | Unix timestamp seconds |
| `content_tsv` | TSVECTOR | Generated/search index (see below) |

Indexes:
- `session_name`, `conversation_id`, `created_at`, `role`
- Composite: `(created_at, session_name)`
- Full-text search: GIN index on `content_tsv`

### 3.2 Strong Search (Full-text Search)

Approach:
- Generate `content_tsv = to_tsvector('simple', coalesce(content,''))`
- Use `websearch_to_tsquery('simple', :q)` for multi-word queries

Why `'simple'`:
- Works across languages without stemming assumptions.
- Avoids needing language detection or extra NLP dependencies.

---

## 4. Service Layer Design

### 4.1 `services/session/message_store.py`

Responsibilities:
- Provide message write APIs for both `ai_chatbot` and `agent_workbench`
- Provide read/search/export APIs for `agent_workbench`

Write path:
- Use an internal async queue + background worker(s) to reduce request latency.
- Worker performs blocking DB writes in a thread (since SQLAlchemy is sync).
- If queue is full or DB is unavailable, log and drop (best-effort mode).

Configuration (env vars):
- `CHAT_HISTORY_ENABLED` (default `true`)
- `CHAT_HISTORY_QUEUE_MAXSIZE` (default `2000`)
- `CHAT_HISTORY_WORKERS` (default `1`)

---

## 5. Scheduler Cleanup

Cleanup job deletes messages older than retention window:
- `CHAT_HISTORY_RETENTION_DAYS` (default `30`)

Runs daily (e.g., 03:00 server time) via existing scheduler infrastructure.

---

## 6. Workbench API + UI

Backend:
- Add a new router under agent workbench: `/history/*` (mounted under `/api` once).
- All endpoints require existing agent JWT auth.

API notes:
- Search endpoint should use a query param name `q` (not `keyword`) to support web-style multi-word queries, consistent with PostgreSQL `websearch_to_tsquery`.
- For very short queries (e.g., length < 2), the API should return 400 to avoid expensive scans.
- Results should include `session_name`, `conversation_id` (if any), `role`, `content`, `created_at`, and (when available) `agent_name` / `response_time_ms`.
- Session list endpoint (`/api/history/sessions`) must aggregate by `session_name`. Do not aggregate by `conversation_id` because it is generated by Coze after the first call and may be NULL for early/failed messages.

Frontend (workbench):
- React page/component that lists sessions, shows detail, provides search and CSV export.
