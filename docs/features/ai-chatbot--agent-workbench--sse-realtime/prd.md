# 微服务跨进程 SSE 通信 - 跨模块 PRD

> **文档类型**：跨模块功能 PRD
> **版本**：v1.0
> **创建日期**：2025-12-22
> **最后更新**：2025-12-22
> **涉及模块**：infrastructure/bootstrap、products/ai_chatbot、products/agent_workbench

---

## 一、功能概述

### 1.1 功能名称
微服务跨进程 SSE 实时通信

### 1.2 背景与目标

**背景**：
- 项目采用微服务架构，AI 客服 (8000) 和坐席工作台 (8002) 独立部署
- 当前 SSE 使用内存队列 (`asyncio.Queue`)，仅支持单进程
- AI 客服转人工时，坐席工作台无法收到消息

**目标**：
- 使用 Redis Pub/Sub 替代内存队列
- 实现跨进程实时消息推送
- 保持 API 接口不变，对上层透明

### 1.3 涉及模块

| 模块 | 路径 | 职责 |
|------|------|------|
| SSE 基础设施 | `infrastructure/bootstrap/sse.py` | 提供跨进程消息队列能力 |
| AI 客服 | `products/ai_chatbot/` | 发送转人工、状态变化等消息 |
| 坐席工作台 | `products/agent_workbench/` | 接收实时消息并展示 |
| Redis 基础设施 | `infrastructure/bootstrap/redis.py` | 提供 Redis 客户端 |

---

## 二、各模块需求

### 2.1 infrastructure/bootstrap/sse.py 需求

**输入：**
- 消息目标（session_name 或 agent_id）
- 消息内容（dict）

**输出：**
- 跨进程的消息传递能力

**改动内容：**
1. 新增 Redis Pub/Sub 支持
2. 保持原有 API 接口不变
3. 支持降级到内存队列（Redis 不可用时）

### 2.2 products/ai_chatbot 需求

**输入：**
- 用户请求转人工
- 会话状态变化

**输出：**
- 通过 SSE 发送消息给坐席工作台

**改动内容：**
- 无需改动（依赖注入，使用新的 SSE 实现）

### 2.3 products/agent_workbench 需求

**输入：**
- SSE 事件流连接请求

**输出：**
- 实时接收并展示消息

**改动内容：**
- 调整 SSE 订阅方式（从内存队列改为 Redis 订阅）

---

## 三、模块间交互

### 3.1 数据流

```
┌─────────────────┐     Redis Pub/Sub      ┌─────────────────┐
│   AI 客服       │                        │  坐席工作台      │
│   (8000)        │                        │    (8002)        │
│                 │                        │                  │
│  转人工请求     │──► PUBLISH ──────────► │  SSE 事件流      │
│                 │   session:{name}       │                  │
└─────────────────┘                        └─────────────────┘
        │                                          │
        └──────────────┬───────────────────────────┘
                       │
                       ▼
              ┌─────────────────┐
              │     Redis       │
              │   Pub/Sub       │
              │                 │
              │ Channel:        │
              │ session:{name}  │
              └─────────────────┘
```

### 3.2 接口定义

#### Redis Pub/Sub Channel 命名规范

| Channel 模式 | 用途 | 发布者 | 订阅者 |
|-------------|------|--------|--------|
| `sse:session:{session_name}` | 会话级消息 | AI 客服 | 坐席工作台 |
| `sse:agent:{agent_id}` | 坐席级消息 | 系统 | 坐席工作台 |
| `sse:broadcast` | 广播消息 | 系统 | 所有订阅者 |

#### 消息格式

```json
{
  "type": "status_change|new_message|transfer_request|...",
  "payload": { ... },
  "timestamp": 1703246400,
  "source": "ai_chatbot|agent_workbench|system"
}
```

---

## 四、用户故事

1. 作为**客服坐席**，我希望在客户请求转人工时**立即收到通知**，以便及时接入服务
2. 作为**系统管理员**，我希望微服务架构下各服务能**独立部署扩展**，不影响实时通信
3. 作为**开发者**，我希望 SSE API **保持不变**，减少上层代码改动
4. 作为**运维人员**，我希望 Redis 故障时**自动降级**到内存队列，保证基本功能

---

## 五、成功标准

### 5.1 功能验收
- [ ] AI 客服转人工，坐席工作台 1 秒内收到通知
- [ ] 两个微服务独立重启，不影响另一个服务
- [ ] Redis 故障时，单进程内通信正常（降级）
- [ ] 原有 SSE API 接口无需修改

### 5.2 非功能要求
- **性能**：消息延迟 < 100ms
- **可靠性**：Redis 故障自动降级
- **兼容性**：保持 API 向后兼容
