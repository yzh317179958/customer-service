# 17track 物流追踪集成 - 产品需求文档

> **文档版本**：v1.0
> **创建日期**：2025-12-22
> **功能类型**：跨模块功能

---

## 一、功能概述

### 1.1 背景

目前使用 17track 付费插件实现物流追踪功能，存在以下问题：
- 功能固定，无法定制通知规则
- 无法与 AI 客服系统集成
- 用户需跳转到第三方页面查看物流

### 1.2 目标

接入 17track API 实现自研物流追踪系统：
1. 物流状态变更自动通知客户（邮件）
2. AI 客服中直接展示完整物流轨迹
3. 数据自主可控，支持未来扩展

---

## 二、涉及模块

| 模块 | 类型 | 职责 |
|------|------|------|
| `services/tracking` | 新建 | 17track API 封装，物流追踪服务 |
| `products/notification` | 开发 | 接收 Webhook，发送通知邮件 |
| `products/ai_chatbot` | 扩展 | 商品卡片展示物流轨迹 |

---

## 三、功能需求

### 3.1 物流通知功能（notification 模块）

| 功能 | 触发条件 | 通知方式 | 优先级 |
|------|----------|----------|--------|
| 包裹拆分通知 | 订单有多个 fulfillment | 邮件 | P1 |
| 预售型号通知 | 预售商品发货 | 邮件 | P1 |
| 包裹异常通知 | 17track 推送 Alert 状态 | 邮件 | P0 |
| 包裹签收通知 | 17track 推送 Delivered 状态 | 邮件 | P0 |

**注**：发货通知由 Shopify 插件处理，不在本功能范围内。

### 3.2 物流轨迹展示（ai_chatbot 模块）

**交互方式**：
1. 商品卡片显示当前物流状态（运输中/已签收等）
2. 用户点击「查看物流」按钮
3. 展开显示完整物流轨迹时间线

**展示内容**：
- 每个物流事件的时间、地点、状态描述
- 支持中英文显示
- 按时间倒序排列

---

## 四、技术方案

### 4.1 17track API 集成

**模式**：Webhook 推送
- Shopify 发货时，系统自动将运单号注册到 17track
- 17track 物流状态变更时，推送到我们的 Webhook 端点
- 系统根据状态类型发送对应通知

**API 版本**：V2.2

### 4.2 数据关联

```
运单号 → tracking_registrations 表 → 订单号 → Shopify API → 客户邮箱
```

### 4.3 架构图

```
┌─────────┐     发货事件     ┌──────────────┐
│ Shopify │ ───────────────→│ notification │
└─────────┘                  │   Webhook    │
                             └──────┬───────┘
                                    │ 注册运单
                                    ▼
                             ┌──────────────┐
                             │   tracking   │
                             │   service    │
                             └──────┬───────┘
                                    │
                                    ▼
                             ┌──────────────┐
                             │ 17track API  │
                             └──────┬───────┘
                                    │ 状态推送
                                    ▼
                             ┌──────────────┐
                             │ notification │──→ 邮件通知
                             └──────────────┘
```

---

## 五、验收标准

### 5.1 功能验收

- [ ] 订单发货后，运单号自动注册到 17track
- [ ] 包裹拆分时，客户收到拆分通知邮件
- [ ] 预售商品发货时，客户收到预售发货通知
- [ ] 物流异常时，客户收到异常告警邮件
- [ ] 包裹签收后，客户收到签收确认邮件
- [ ] AI 客服中，点击商品卡片可展开完整物流轨迹

### 5.2 非功能验收

- [ ] Webhook 签名验证通过
- [ ] 邮件模板支持多语言（EN/ZH）
- [ ] 服务可独立测试
- [ ] 数据库迁移无损执行

---

## 六、风险与应对

| 风险 | 应对措施 |
|------|----------|
| 17track API 不稳定 | 重试机制 + 失败日志 |
| 运单号无法匹配订单 | 建立映射表 |
| 邮件发送失败 | 重试机制 + 失败告警 |
