# Fiido AI Customer Service - nginx configuration
# 添加到现有nginx配置，使用 /ai/ 路径

# 在现有 server block 中添加以下 location 块
# 或者创建新的配置文件 include 进来

# === 方案1: 添加到现有 server block ===
# location /ai/ {
#     proxy_pass http://127.0.0.1:8000/;
#     ...
# }

# === 方案2: 独立配置文件（推荐） ===
# 此配置会被 include 到主配置中

# AI 客服 API 代理
location /ai/ {
    # 去掉 /ai 前缀后转发
    rewrite ^/ai/(.*) /$1 break;

    proxy_pass http://127.0.0.1:8000;
    proxy_http_version 1.1;

    # 基本头信息
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # SSE 支持（流式响应）
    proxy_set_header Connection '';
    proxy_buffering off;
    proxy_cache off;
    chunked_transfer_encoding on;

    # 超时设置（AI响应可能较慢）
    proxy_connect_timeout 60s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # CORS 支持
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers 'Authorization, Content-Type, X-Requested-With' always;

    if ($request_method = 'OPTIONS') {
        return 204;
    }
}

# AI 客服 WebSocket 支持（如需要）
location /ai/ws/ {
    rewrite ^/ai/(.*) /$1 break;

    proxy_pass http://127.0.0.1:8000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 86400;
}

# =====================================================
# 坐席工作台 - Agent Workbench
# =====================================================

# 坐席工作台前端静态文件
location /workbench/ {
    alias /var/www/agent-workbench/;
    try_files $uri $uri/ /workbench/index.html;

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# 坐席工作台 API 代理
location /workbench/api/ {
    rewrite ^/workbench/api/(.*) /api/$1 break;

    proxy_pass http://127.0.0.1:8002;
    proxy_http_version 1.1;

    # 基本头信息
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # SSE 支持（流式响应）
    proxy_set_header Connection '';
    proxy_buffering off;
    proxy_cache off;
    chunked_transfer_encoding on;

    # 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # CORS 支持
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers 'Authorization, Content-Type, X-Requested-With' always;

    if ($request_method = 'OPTIONS') {
        return 204;
    }
}
